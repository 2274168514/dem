<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Permissions-Policy" content="unload=(), browsing-topics=(), idle-detection=(), magnetometer=(), accelerometer=(), gyroscope=(), camera=(), microphone=(), geolocation=(), payment=(), interest-cohort=()">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://d3js.org https://unpkg.com https://mozilla.github.io; object-src 'none'; base-uri 'self'; form-action 'self';">
  <title>OnlineJudge - 在线编程评测平台</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>编</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style/main.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/markdown-preview.css">
  <link rel="stylesheet" href="css/markdown-panel.css">

  <!-- Markdown 预览所需 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">

  <!-- D3.js 和 Recharts (临时注释以修复问题) -->
  <!-- <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script> -->

  <!-- 图标字体 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.555.0/font/lucide.min.css">
  <script>
    // 阻止unload事件相关的权限警告
    if (window.EventTarget) {
      const originalAddEventListener = EventTarget.prototype.addEventListener;
      EventTarget.prototype.addEventListener = function(type, listener, options) {
        if (type === 'unload' || type === 'beforeunload') {
          // 静默处理，不打印警告
          return;
        }
        return originalAddEventListener.call(this, type, listener, options);
      };
    }
    
    // 全局错误处理 - 静默浏览器扩展错误
    window.addEventListener('error', function(e) {
      // 检测是否为浏览器扩展或外部脚本的错误
      const isExtensionError = !e.filename || 
        e.filename.includes('extension') || 
        e.filename.includes('content.js') ||
        /^\d+\.js$/.test(e.filename.split('/').pop()) ||
        e.message.includes('Unexpected token');
      
      if (isExtensionError) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // 静默 unhandled promise rejection
    window.addEventListener('unhandledrejection', function(e) {
      if (e.reason && (
        e.reason.message?.includes('extension') ||
        e.reason.message?.includes('Permissions policy')
      )) {
        e.preventDefault();
      }
    });
  </script>
  <style>
    body {
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
    }

    /* 隐藏数字输入框的上下箭头 */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
        appearance: none;
    }

    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--border);
    }

    .main-content {
      background: var(--bg);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .nav-item {
      color: var(--text);
      transition: all 0.2s;
    }

    .nav-item:hover {
      background: var(--hover);
      color: var(--accent);
    }

    .nav-item.active {
      background: var(--selection);
      color: var(--accent);
    }

    .glass-effect {
      backdrop-filter: blur(16px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* ========== 浅色模式样式 ========== */
    .light-theme {
      background: #f8fafc !important;
      color: #1e293b !important;
    }

    .light-theme .sidebar {
      background: #ffffff !important;
      border-color: #e2e8f0 !important;
    }

    .light-theme .main-content {
      background: #f8fafc !important;
    }

    .light-theme header {
      background: #ffffff !important;
      border-color: #e2e8f0 !important;
    }

    /* Tailwind 颜色覆盖 */
    .light-theme .text-white {
      color: #1e293b !important;
    }

    .light-theme .text-gray-400 {
      color: #64748b !important;
    }

    .light-theme .text-gray-300 {
      color: #475569 !important;
    }

    .light-theme .text-gray-500 {
      color: #64748b !important;
    }

    .light-theme .bg-gray-900 {
      background-color: #ffffff !important;
    }

    .light-theme .bg-gray-800 {
      background-color: #f8fafc !important;
    }

    .light-theme .bg-gray-700 {
      background-color: #f1f5f9 !important;
    }

    .light-theme .border-gray-700 {
      border-color: #e2e8f0 !important;
    }

    .light-theme .border-gray-600 {
      border-color: #cbd5e1 !important;
    }

    /* 模态框浅色模式 */
    .light-theme [id$="-modal"] > div {
      background: #ffffff !important;
      border-color: #e2e8f0 !important;
    }

    .light-theme [id$="-modal"] .bg-gray-800 {
      background-color: #f8fafc !important;
    }

    .light-theme [id$="-modal"] .bg-gray-700 {
      background-color: #f1f5f9 !important;
    }

    .light-theme [id$="-modal"] .bg-gray-700:hover {
      background-color: #e2e8f0 !important;
    }

    .light-theme [id$="-modal"] .text-white {
      color: #1e293b !important;
    }

    .light-theme [id$="-modal"] .text-gray-300 {
      color: #475569 !important;
    }

    .light-theme [id$="-modal"] .text-gray-400 {
      color: #64748b !important;
    }

    .light-theme [id$="-modal"] input,
    .light-theme [id$="-modal"] textarea {
      background-color: #f8fafc !important;
      border-color: #cbd5e1 !important;
      color: #1e293b !important;
    }

    .light-theme [id$="-modal"] input::placeholder,
    .light-theme [id$="-modal"] textarea::placeholder {
      color: #94a3b8 !important;
    }

    .light-theme [id$="-modal"] .border-gray-700 {
      border-color: #e2e8f0 !important;
    }

    .light-theme [id$="-modal"] .border-gray-600 {
      border-color: #cbd5e1 !important;
    }

    /* 学生列表项 */
    .light-theme .student-item {
      background-color: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
    }

    .light-theme .student-item:hover {
      background-color: #f1f5f9 !important;
    }

    /* 导航项浅色模式 */
    .light-theme .nav-item {
      color: #475569 !important;
    }

    .light-theme .nav-item:hover {
      background: #f1f5f9 !important;
      color: #3b82f6 !important;
    }

    .light-theme .nav-item.active {
      background: #eff6ff !important;
      color: #3b82f6 !important;
    }

    /* glass-effect 浅色模式 */
    .light-theme .glass-effect {
      background: rgba(255, 255, 255, 0.8) !important;
      border: 1px solid #e2e8f0 !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
    }

    /* 按钮悬停 */
    .light-theme .hover\:bg-gray-600:hover {
      background-color: #e2e8f0 !important;
    }

    .light-theme .hover\:bg-gray-700:hover {
      background-color: #f1f5f9 !important;
    }

    .light-theme .hover\:text-white:hover {
      color: #1e293b !important;
    }

    /* 滚动条 */
    .light-theme ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .light-theme ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
    }

    .light-theme ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
  <!-- 全局设置管理器 - 统一主题和语言 -->
  <script src="js/globalSettings.js"></script>
</head>
<body class="min-h-screen flex">
  <!-- 主应用界面 -->
  <div id="main-app" class="w-full h-screen flex">
    <!-- 左侧导航栏 -->
    <div class="sidebar w-64 flex-shrink-0 flex flex-col">
      <div class="p-6 border-b border-gray-700">
        <div class="flex items-center space-x-3">
          <img src="image/logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
          <div>
            <h1 class="text-xl font-bold text-white">SLYCoder</h1>
            </div>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1" id="nav-menu">
        <!-- 备用静态导航菜单 -->
        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3 active" data-page="dashboard">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          <span data-i18n="dashboard">仪表盘</span>
        </button>
        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3" data-page="markdown-editor">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          <span>Markdown 编辑器</span>
        </button>

        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3" data-page="courses">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
          </svg>
          <span data-i18n="courseManagement">课程</span>
        </button>

        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3" data-page="teachers">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span data-i18n="teacherManagement">教师</span>
        </button>

        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3" data-page="students">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <span data-i18n="studentManagement">学生管理</span>
        </button>

        <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3" data-page="profile">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span data-i18n="profile">个人资料</span>
        </button>

        <!-- 管理员不能访问作业管理和用户管理，这些功能已从静态导航中移除 -->
      </nav>

      <div class="p-4 border-t border-gray-700">
        <div class="mb-4">
          <p class="text-sm font-medium text-white" id="user-name">学生</p>
          <p class="text-xs text-gray-400" id="user-role">student</p>
        </div>
        <button id="logout-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm" data-i18n="logout">
          退出登录
        </button>
      </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content flex-1 flex flex-col">
      <!-- 顶部栏 -->
      <header class="border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
          <h1 id="page-title" class="text-2xl font-semibold text-white" data-i18n="pageTitle">仪表盘</h1>
          <div class="flex items-center space-x-4">
            <button onclick="localStorage.setItem('editor-return-page', 'dashboard'); window.location.href='editor.html'" class="flex items-center space-x-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" data-i18n-title="titleCodeEditor" title="代码编辑器">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
              </svg>
              <span class="text-sm font-medium" data-i18n="codeEditorButton">代码编辑器</span>
            </button>
            <button onclick="window.location.href='ppt-viewer/index.html'" class="flex items-center space-x-2 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors" data-i18n-title="titlePptPresentation" title="PPT演示">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 0h10m-10 0l1 16h8l1-16M9 9h6m-6 4h6"></path>
              </svg>
              <span class="text-sm font-medium" data-i18n="pptPresentation">PPT演示</span>
            </button>
            <button onclick="window.location.href='markdown-viewer/index.html'" class="flex items-center space-x-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors" data-i18n-title="titleDocumentPresentation" title="文档演示">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <span class="text-sm font-medium" data-i18n="documentPresentation">文档演示</span>
            </button>
            <button onclick="window.open('http://localhost:3000', '_blank')" class="flex items-center space-x-2 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" data-i18n-title="titleMarkdownEditor" title="Markdown编辑器">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              <span class="text-sm font-medium" data-i18n="markdownEditor">Markdown编辑器</span>
            </button>
            <button id="language-toggle" class="p-2 text-gray-400 hover:text-white transition-colors" title="Switch Language / 切换语言">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
              </svg>
            </button>
            <button id="main-theme-toggle" class="p-2 text-gray-400 hover:text-white transition-colors" title="切换主题" onclick="toggleThemeTest()">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </button>
            <button class="p-2 text-gray-400 hover:text-white transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
            <button class="p-2 text-gray-400 hover:text-white transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- 页面内容 -->
      <main class="flex-1 p-6 overflow-auto">
        <div id="page-content">
          <!-- 页面内容将由JavaScript动态生成 -->
          <div class="animate-fade-in-up">
            <h2 class="text-xl font-semibold text-white mb-4">欢迎使用 OnlineJudge</h2>
            <div class="glass-effect rounded-lg p-6">
              <p class="text-gray-300">请从左侧菜单选择功能</p>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // 国际化系统
    const i18n = {
      // 从全局设置读取语言，兼容旧版存储
      currentLanguage: (window.globalSettings && window.globalSettings.language) 
        || localStorage.getItem('global-language-preference')
        || localStorage.getItem('preferred-language')
        || localStorage.getItem('language') 
        || 'zh',

      // 完整的翻译数据
      translations: {
        zh: {
          pageTitle: '仪表盘',
          codeEditor: '代码编辑器',
          codeEditorButton: '代码编辑器',
          pptPresentation: 'PPT演示',
          documentPresentation: '文档演示',
          markdownEditor: 'Markdown编辑器',
          titleCodeEditor: '代码编辑器',
          titlePptPresentation: 'PPT演示',
          titleDocumentPresentation: '文档演示',
          titleMarkdownEditor: 'Markdown编辑器',
          logout: '退出登录',
          courses: '课程',
          assignments: '作业',
          gradeManagement: '成绩管理',
          codeLibrary: '代码库',
          myAccount: '我的账户',
          settings: '设置',
          username: '用户名',
          password: '密码',
          login: '登录',
          register: '注册',
          dashboard: '仪表盘',
          welcome: '欢迎',
          courseName: '课程名称',
          description: '描述',
          createDate: '创建日期',
          actions: '操作',
          view: '查看',
          edit: '编辑',
          delete: '删除',
          create: '创建',
          save: '保存',
          cancel: '取消',
          submit: '提交',
          search: '搜索',
          filter: '筛选',
          all: '全部',
          name: '姓名',
          email: '邮箱',
          role: '角色',
          status: '状态',
          active: '活跃',
          inactive: '非活跃',
          students: '学生',
          people: '人',
          teachers: '教师',
          admins: '管理员',
          unnamedCourse: '未命名课程',
          clickToAddDescription: '点击添加描述',
          clickToEditDescription: '点击编辑描述',
          editCourseDescription: '编辑课程描述',
          enterCourseDescription: '请输入课程描述',
          cancel: '取消',
          save: '保存',
          descriptionSaved: '描述已保存',
          saveDescriptionFailed: '保存描述失败',
          searchStudents: '搜索学生...',
          allStatus: '全部状态',
          search: '搜索',
          myStudents: '我的学生',
          responsibleCourses: '负责课程',
          coursesUnit: '门',
          totalStudents: '学生总数',
          myCourses: '我的课程',
          profile: '个人资料',
          assignmentTitle: '作业标题',
          assignmentDescription: '作业描述',
          assignmentDeadline: '截止时间',
          selectCourse: '选择课程',
          course: '所属课程',
          enterAssignmentTitle: '请输入作业标题',
          enterAssignmentDescription: '请输入作业描述和具体要求',
          templateSelected: '已选择案例',
          templateDescription: '创建的作业将以此为模板',
          dueDate: '截止日期',
          submitted: '已提交',
          grade: '成绩',
          feedback: '反馈',
          template: '模板',
          example: '示例',
          language: '语言',
          studentId: '学号',
          employeeId: '工号',
          department: '院系',
          major: '专业',
          grade: '年级',
          class: '班级',
          phone: '电话',
          fullName: '全名',
          userManagement: '用户管理',
          studentManagement: '学生',
          teacherManagement: '教师',
          addTeacher: '添加教师',
          addStudent: '添加学生',
          searchPlaceholder: '请输入搜索关键词',
          enterUsername: '请输入用户名',
          enterPassword: '请输入密码',
          pleaseFillForm: '请填写完整信息',
          loading: '加载中...',
          noData: '暂无数据',
          welcomeBack: '欢迎回来',
          totalCourses: '总课程',
          totalCoursesWithCount: '共 {count} 门课程',
          totalCoursesLabel: '总课程',
          activeCourses: '活跃课程',
          createdAt: '创建时间',
          viewRelatedAssignments: '查看相关作业',
          pendingSubmissions: '待提交',
          activeUsers: '活跃用户',
          systemStatus: '系统状态',
          normal: '正常',
          allServicesRunning: '所有服务运行中',
          recentCourses: '最近课程',
          recentAssignments: '最近作业',
          codeRepository: '代码库',
          codeRepositorySubtitle: '精选代码案例和本地保存的示例',
          assignmentManagement: '作业',
        createNewAssignment: '创建作业',
        viewAssignments: '查看作业',
        myAssignments: '我的作业',
        assignmentTitle: '作业标题',
        assignmentDescription: '作业描述',
        assignmentDeadline: '截止时间',
        selectCourse: '选择课程',
        course: '所属课程',
        enterAssignmentTitle: '请输入作业标题',
        enterAssignmentDescription: '请输入作业描述和具体要求',
        createAssignment: '创建作业',
        cancel: '取消',
          allCases: '全部案例',
          localCases: '本地案例',
          featuredCases: '精选案例',
          preview: '预览',
          openInEditor: '在编辑器中打开',
          createAssignment: '创建作业',
          noMatchingCases: '没有找到符合条件的案例',
          featured: '精选',
          local: '本地',
          noDescription: '（无说明）',
          author: '作者',
          localUser: '本地用户',
          noEnrolledCourses: '暂无报名课程',
          noManagedCourses: '暂无管理课程',
          noCourses: '暂无课程',
          studentsCount: '名学生',
          inProgress: '进行中',
          ended: '已结束',
          courseCode: '课程代码',
          courseTeacher: '授课教师',
          courseDescription: '课程描述',
          courseStatus: '课程状态',
          statistics: '统计信息',
          enrolledStudents: '已选学生',
          courseInfo: '课程信息',
          general: '通用',
          viewDetails: '查看详情',
          totalCourses: '共 {count} 门课程',
          totalAssignments: '共 {count} 个作业',
          noAssignments: '暂无作业',
          studentHasNoAssignments: '该学生暂无作业',
          assignmentList: '作业列表',
          saveChanges: '保存修改',
          featureInDevelopment: '该功能正在开发中...',
          courseManagement: '课程',
          createCourse: '创建课程',
          teacher: '教师',
          unassigned: '未分配',
          students: '学生',
          assignStudents: '分配学生',
          importStudentList: '导入学生名单',
          importFormatDescription: '每行一个学生，格式：',
          importFormatExample: '学号,姓名,邮箱,专业,年级',
          importOptionalFields: '（邮箱、专业、年级可选）',
          importExample: '例如：\n2021003,王五,wangwu@example.com,计算机科学与技术,2021级\n2021004,赵六,zhaoliu@example.com,软件工程,2021级',
          confirmImport: '确认导入',
          saveChanges: '保存修改',
          editStudent: '编辑学生',
          addStudent: '添加学生',
          studentInfo: '学生信息',
          searchStudent: '搜索学生',
          filterByRole: '按角色筛选',
          allRoles: '所有角色',
          refreshList: '刷新列表',
          noStudentsFound: '未找到学生',
          studentList: '学生列表',
          loadingStudents: '加载中...',
          // 教师管理界面新增
          teacherName: '教师姓名',
          teacherEmail: '教师邮箱',
          status: '状态',
          active: '活跃',
          inactive: '离职',
          actions: '操作',
          edit: '编辑',
          delete: '删除',
          resetPassword: '重置密码',
          confirmDelete: '确认删除',
          confirmDeleteTeacher: '确定要删除教师"{name}"吗？删除后其账户将被永久删除且无法恢复。',
          teacherAdded: '教师添加成功',
          teacherDeleted: '教师删除成功',
          passwordResetSuccess: '密码重置成功',
          searchTeacher: '搜索教师...',
          // 学生管理界面新增
          studentName: '学生姓名',
          studentEmail: '学生邮箱',
          enrollmentStatus: '学籍状态',
          enrolled: '在读',
          suspended: '休学',
          graduated: '已毕业',
          confirmDeleteStudent: '确定要删除学生"{name}"吗？删除后其账户将被永久删除且无法恢复。',
          studentAdded: '学生添加成功',
          studentDeleted: '学生删除成功',
          // 个人资料界面
          personalProfile: '个人资料',
          basicInformation: '基本信息',
          changeAvatar: '更换头像',
          loginHistory: '登录历史',
          lastLogin: '最后登录',
          loginTime: '登录时间',
          loginIp: '登录IP',
          deviceInfo: '设备信息',
          noLoginRecord: '暂无登录记录',
          statistics: '统计信息',
          totalAssignments: '作业总数',
          completedAssignments: '已完成作业',
          averageScore: '平均分',
          // 通用状态和操作
          admin: '管理员',
          unknown: '未知',
          save: '保存',
          cancel: '取消',
          confirm: '确认',
          success: '成功',
          failed: '失败',
          error: '错误',
          bio: '个人简介',
          bioPlaceholder: '介绍一下你自己...',
          // 表单相关翻译
          addTeacherFormTitle: '添加教师',
          fullName: '姓名',
          usernameForLogin: '用户名（登录账号）',
          enterTeacherName: '请输入教师姓名',
          enterUsername: '请输入登录用户名',
          enterLoginPassword: '请输入登录密码',
          enterPhoneNumber: '请输入电话号码',
          enterDepartmentName: '请输入所属院系',
          // 添加学生表单
          addStudentFormTitle: '添加学生',
          enterStudentName: '请输入学生姓名',
          enterStudentId: '请输入学号',
          enterMajorName: '请输入专业名称',
          enterGradeName: '请输入年级',
          // 添加课程表单
          createCourseFormTitle: '创建课程',
          courseName: '课程名称',
          courseCode: '课程代码',
          courseDescription: '课程描述',
          courseTeacher: '授课教师',
          maxStudentsCount: '最大学生数量',
          enterCourseName: '请输入课程名称',
          enterCourseCode: '请输入课程代码（如：CS101）',
          enterCourseDescription: '请输入课程描述',
          selectTeacher: '选择教师',
          enterMaxStudents: '请输入最大学生数量',
          createCourseBtn: '创建课程',
          // 通用表单
          emailAddress: '邮箱地址',
          enterEmailAddress: '请输入邮箱地址',
          // CSV导入相关
          csvImport: 'CSV导入',
          csvBatchImportStudents: 'CSV批量导入学生',
          downloadCSVTemplate: '下载CSV模板',
          dropCSVFileOrClick: '拖拽CSV文件到此处，或点击选择文件',
          selectCSVFile: '选择CSV文件',
          startImport: '开始导入',
          selectCSVFormatFile: '请选择CSV格式的文件',
          csvParseError: 'CSV文件解析失败',
          csvMinRowsError: 'CSV文件至少需要包含标题行和一行数据',
          // 学生状态专用
          studentActive: '已激活',
          studentInactive: '未激活',
          // 教师状态专用
          teacherActive: '已激活',
          teacherInactive: '未激活',
          // 错误和状态消息
          loadTeachersError: '无法加载教师列表，请稍后重试',
          close: '关闭',
          cancel: '取消',
          noCourses: '暂无课程',
          // 仪表盘统计卡片
          registeredUsers: '注册用户',
          activeCount: '活跃',
          pendingGrade: '待批改',
          totalCount: '总人数',
          todoTasks: '待办',
          gradingTasks: '批改任务',
          studying: '学习中',
          pendingAssignments: '待完成',
          myProgress: '我的进度',
          completed: '已完成',
          completionRate: '完成率'
        },
        en: {
          pageTitle: 'Dashboard',
          codeEditor: 'Code Editor',
          codeEditorButton: 'Code Editor',
          pptPresentation: 'PPT Presentation',
          documentPresentation: 'Document Viewer',
          markdownEditor: 'Markdown Editor',
          titleCodeEditor: 'Code Editor',
          titlePptPresentation: 'PPT Presentation',
          titleDocumentPresentation: 'Document Viewer',
          titleMarkdownEditor: 'Markdown Editor',
          logout: 'Logout',
          courses: 'Courses',
          assignments: 'Assignments',
          gradeManagement: 'Grade Management',
          codeLibrary: 'Code Library',
          myAccount: 'My Account',
          settings: 'Settings',
          username: 'Username',
          password: 'Password',
          login: 'Login',
          register: 'Register',
          dashboard: 'Dashboard',
          welcome: 'Welcome',
          courseName: 'Course Name',
          description: 'Description',
          createDate: 'Create Date',
          actions: 'Actions',
          view: 'View',
          edit: 'Edit',
          delete: 'Delete',
          create: 'Create',
          save: 'Save',
          cancel: 'Cancel',
          submit: 'Submit',
          search: 'Search',
          filter: 'Filter',
          all: 'All',
          name: 'Name',
          email: 'Email',
          role: 'Role',
          status: 'Status',
          active: 'Active',
          inactive: 'Inactive',
          students: 'Students',
          people: 'people',
          teachers: 'Teachers',
          admins: 'Admins',
          unnamedCourse: 'Unnamed Course',
          clickToAddDescription: 'Click to add description',
          clickToEditDescription: 'Click to edit description',
          editCourseDescription: 'Edit Course Description',
          enterCourseDescription: 'Enter course description',
          cancel: 'Cancel',
          save: 'Save',
          descriptionSaved: 'Description saved',
          saveDescriptionFailed: 'Failed to save description',
          searchStudents: 'Search students...',
          allStatus: 'All Status',
          search: 'Search',
          myStudents: 'My Students',
          responsibleCourses: 'Responsible Courses',
          coursesUnit: '',
          totalStudents: 'Total Students',
          myCourses: 'My Courses',
          courseCode: 'Course Code',
          courseTeacher: 'Course Teacher',
          courseDescription: 'Course Description',
          courseStatus: 'Course Status',
          statistics: 'Statistics',
          enrolledStudents: 'Enrolled Students',
          courseInfo: 'Course Information',
        general: 'General',
        viewDetails: 'View Details',
          totalCourses: 'Total {count} courses',
        totalAssignments: 'Total {count} assignments',
          profile: 'Profile',
          assignmentTitle: 'Assignment Title',
          dueDate: 'Due Date',
          submitted: 'Submitted',
          view: 'View',
          update: 'Update',
          grade: 'Grade',
          feedback: 'Feedback',
          template: 'Template',
          example: 'Example',
          language: 'Language',
          studentId: 'Student ID',
          employeeId: 'Employee ID',
          department: 'Department',
          major: 'Major',
          grade: 'Grade',
          class: 'Class',
          phone: 'Phone',
          fullName: 'Full Name',
          userManagement: 'User Management',
          studentManagement: 'Students',
          teacherManagement: 'Teacher',
          courseManagement: 'Course',
          addTeacher: 'Add Teacher',
          addStudent: 'Add Student',
          searchPlaceholder: 'Enter search keywords',
          enterUsername: 'Enter username',
          enterPassword: 'Enter password',
          pleaseFillForm: 'Please fill in complete information',
          loading: 'Loading...',
          noData: 'No data available',
          welcomeBack: 'Welcome back',
          totalCourses: 'Total Courses',
        totalCoursesWithCount: 'Total {count} courses',
          totalCoursesLabel: 'Total Courses',
          activeCourses: 'Active Courses',
          createdAt: 'Created At',
          viewRelatedAssignments: 'View Related Assignments',
          pendingSubmissions: 'Pending',
          activeUsers: 'Active Users',
          systemStatus: 'System Status',
          normal: 'Normal',
          allServicesRunning: 'All Services Running',
          registeredUsers: 'Registered Users',
          activeCount: 'Active',
          pendingGrade: 'Pending',
          totalCount: 'Total',
          todoTasks: 'To-do',
          gradingTasks: 'Grading Tasks',
          studying: 'Studying',
          pendingAssignments: 'Pending',
          myProgress: 'Progress',
          completed: 'Completed',
          completionRate: 'Completion Rate',
          recentCourses: 'Recent Courses',
          recentAssignments: 'Recent Assignments',
          codeRepository: 'Code Repository',
          codeRepositorySubtitle: 'Selected code examples and locally saved samples',
          assignmentManagement: 'Assignments',
        createNewAssignment: 'Create Assignment',
        viewAssignments: 'View Assignments',
        myAssignments: 'My Assignments',
        assignmentTitle: 'Assignment Title',
        assignmentDescription: 'Assignment Description',
        assignmentDeadline: 'Deadline',
        selectCourse: 'Select Course',
        course: 'Course',
        enterAssignmentTitle: 'Enter assignment title',
        enterAssignmentDescription: 'Enter assignment description and requirements',
        templateSelected: 'Template selected',
        templateDescription: 'Assignment will be created using this template',
        createAssignment: 'Create Assignment',
        cancel: 'Cancel',
          allCases: 'All Cases',
          localCases: 'Local Cases',
          featuredCases: 'Featured Cases',
          preview: 'Preview',
          openInEditor: 'Open in Editor',
          createAssignment: 'Create Assignment',
          noMatchingCases: 'No matching cases found',
          featured: 'Featured',
          local: 'Local',
          noDescription: '(No description)',
          author: 'Author',
          localUser: 'Local User',
          noEnrolledCourses: 'No enrolled courses',
          noManagedCourses: 'No managed courses',
          noCourses: 'No courses',
          studentsCount: ' students',
          inProgress: 'In Progress',
          ended: 'Ended',
          noAssignments: 'No assignments',
          studentHasNoAssignments: 'This student has no assignments',
          assignmentList: 'Assignment List',
          featureInDevelopment: 'This feature is under development...',
          courseManagement: 'Course Management',
          createCourse: 'Create Course',
          teacher: 'Teacher',
          unassigned: 'Unassigned',
          students: 'Students',
          assignStudents: 'Assign Students',
          importStudentList: 'Import Student List',
          importFormatDescription: 'One student per line, format:',
          importFormatExample: 'Student ID,Name,Email,Major,Grade',
          importOptionalFields: '(Email, Major, Grade optional)',
          importExample: 'Example:\n2021003,Wang Wu,wangwu@example.com,Computer Science,2021\n2021004,Zhao Liu,zhaoliu@example.com,Software Engineering,2021',
          confirmImport: 'Confirm Import',
          saveChanges: 'Save Changes',
          editStudent: 'Edit Student',
          addStudent: 'Add Student',
          studentInfo: 'Student Information',
          searchStudent: 'Search Student',
          filterByRole: 'Filter by Role',
          allRoles: 'All Roles',
          refreshList: 'Refresh List',
          noStudentsFound: 'No students found',
          studentList: 'Student List',
          loadingStudents: 'Loading...',
          // 教师管理界面新增
          teacherName: 'Teacher Name',
          teacherEmail: 'Teacher Email',
          status: 'Status',
          active: 'Active',
          inactive: 'Inactive',
          actions: 'Actions',
          edit: 'Edit',
          delete: 'Delete',
          resetPassword: 'Reset Password',
          confirmDelete: 'Confirm Delete',
          confirmDeleteTeacher: 'Are you sure you want to delete teacher "{name}"? Their account will be permanently deleted and cannot be recovered.',
          teacherAdded: 'Teacher added successfully',
          teacherDeleted: 'Teacher deleted successfully',
          passwordResetSuccess: 'Password reset successfully',
          searchTeacher: 'Search Teacher...',
          // 学生管理界面新增
          studentName: 'Student Name',
          studentEmail: 'Student Email',
          enrollmentStatus: 'Enrollment Status',
          enrolled: 'Enrolled',
          suspended: 'Suspended',
          graduated: 'Graduated',
          confirmDeleteStudent: 'Are you sure you want to delete student "{name}"? Their account will be permanently deleted and cannot be recovered.',
          studentAdded: 'Student added successfully',
          studentDeleted: 'Student deleted successfully',
          // 个人资料界面
          personalProfile: 'Personal Profile',
          basicInformation: 'Basic Information',
          changeAvatar: 'Change Avatar',
          loginHistory: 'Login History',
          lastLogin: 'Last Login',
          loginTime: 'Login Time',
          loginIp: 'Login IP',
          deviceInfo: 'Device Info',
          noLoginRecord: 'No login records',
          statistics: 'Statistics',
          totalAssignments: 'Total Assignments',
          completedAssignments: 'Completed Assignments',
          averageScore: 'Average Score',
          // 通用状态和操作
          admin: 'Administrator',
          unknown: 'Unknown',
          save: 'Save',
          cancel: 'Cancel',
          confirm: 'Confirm',
          success: 'Success',
          failed: 'Failed',
          error: 'Error',
          bio: 'Bio',
          bioPlaceholder: 'Tell us about yourself...',
          // 表单相关翻译
          addTeacherFormTitle: 'Add Teacher',
          fullName: 'Full Name',
          usernameForLogin: 'Username (Login Account)',
          enterTeacherName: 'Enter teacher name',
          enterUsername: 'Enter username',
          enterLoginPassword: 'Enter login password',
          enterPhoneNumber: 'Enter phone number',
          enterDepartmentName: 'Enter department',
          // 添加学生表单
          addStudentFormTitle: 'Add Student',
          enterStudentName: 'Enter student name',
          enterStudentId: 'Enter student ID',
          enterMajorName: 'Enter major',
          enterGradeName: 'Enter grade',
          // 添加课程表单
          createCourseFormTitle: 'Create Course',
          courseName: 'Course Name',
          courseCode: 'Course Code',
          courseDescription: 'Course Description',
          courseTeacher: 'Course Teacher',
          maxStudentsCount: 'Max Students',
          enterCourseName: 'Enter course name',
          enterCourseCode: 'Enter course code (e.g., CS101)',
          enterCourseDescription: 'Enter course description',
          selectTeacher: 'Select Teacher',
          enterMaxStudents: 'Enter max students',
          createCourseBtn: 'Create Course',
          // 通用表单
          emailAddress: 'Email Address',
          enterEmailAddress: 'Enter email address',
          // CSV导入相关
          csvImport: 'CSV Import',
          csvBatchImportStudents: 'CSV Batch Import Students',
          downloadCSVTemplate: 'Download CSV Template',
          dropCSVFileOrClick: 'Drag CSV file here, or click to select file',
          selectCSVFile: 'Select CSV File',
          startImport: 'Start Import',
          selectCSVFormatFile: 'Please select CSV format file',
          csvParseError: 'CSV file parsing failed',
          csvMinRowsError: 'CSV file must contain at least header row and one data row',
          // 学生状态专用
          studentActive: 'Active',
          studentInactive: 'Inactive',
          // 教师状态专用
          teacherActive: 'Active',
          teacherInactive: 'Inactive',
          // 错误和状态消息
          loadTeachersError: 'Unable to load teacher list, please try again later',
          close: 'Close',
          // 作业提交详情
          submissionStatus: 'Submission Status',
          submissionDetails: 'Submission Details',
          assignmentInfo: 'Assignment Information',
          assignedStudents: 'Assigned Students',
          graded: 'Graded',
          noSubmission: 'No Submission',
          viewCode: 'View Code',
          gradeSubmission: 'Grade Submission',
          notSet: 'Not Set',
          people: 'people',
          copies: 'copies',
          score: 'Score',
          points: 'points',
          scorePlaceholder: 'Score',
          modify: 'Modify',
          updateScore: 'Update Score',
          view: 'View',
          update: 'Update',
          unknownMajor: 'Unknown Major',
          noAssignedStudents: 'No assigned students',
          apiError: 'API Connection Error',
          // 作业相关翻译
          startAssignment: 'Start Assignment',
          inProgress: 'In Progress',
          ended: 'Ended',
          expired: 'Expired',
          pending: 'Pending',
          deadline: 'Deadline',
          submitted: 'Submitted',
          submissionStatus: 'Submission Status',
          submissionDetails: 'Submission Details',
          assignmentInfo: 'Assignment Information',
          assignedStudents: 'Assigned Students',
          graded: 'Graded',
          noSubmission: 'No Submission',
          gradeSubmission: 'Grade Submission',
          notSet: 'Not Set',
          people: 'people',
          copies: 'copies',
          score: 'Score',
          points: 'points',
          scorePlaceholder: 'Score',
          modify: 'Modify',
          updateScore: 'Update Score',
          view: 'View',
          update: 'Update',
          unknownMajor: 'Unknown Major',
          colon: ':'
        }
      },

      // 初始化国际化
      init() {
        this.updateLanguage();
        console.log('i18n system initialized with language:', this.currentLanguage);
      },

      // 切换语言
      toggle() {
        this.currentLanguage = this.currentLanguage === 'zh' ? 'en' : 'zh';
        // 保存到所有存储键以保持兼容
        localStorage.setItem('language', this.currentLanguage);
        localStorage.setItem('preferred-language', this.currentLanguage);
        localStorage.setItem('global-language-preference', this.currentLanguage);
        
        // 同步到全局设置
        if (window.globalSettings) {
          window.globalSettings.language = this.currentLanguage;
        }
        
        this.updateLanguage();
        console.log('Language switched to:', this.currentLanguage);
      },
      
      // 设置语言（用于外部调用）
      setLanguage(lang) {
        if (['zh', 'en'].includes(lang) && this.currentLanguage !== lang) {
          this.currentLanguage = lang;
          localStorage.setItem('language', lang);
          localStorage.setItem('preferred-language', lang);
          localStorage.setItem('global-language-preference', lang);
          this.updateLanguage();
        }
      },

      // 获取翻译文本
      t(key) {
        return this.translations[this.currentLanguage][key] || key;
      },

      // 更新所有带data-i18n属性的元素
      updateLanguage() {
        // 更新所有带data-i18n属性的元素
        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
          const key = element.getAttribute('data-i18n');
          const text = this.t(key);

          // 处理不同类型的元素
          if (element.tagName === 'INPUT' && element.type === 'text') {
            element.placeholder = text;
          } else if (element.tagName === 'BUTTON') {
            // 如果按钮包含图标，保留图标只更新文本
            const icon = element.querySelector('svg');
            const span = element.querySelector('span');
            if (span) {
              span.textContent = text;
            } else if (!icon) {
              element.textContent = text;
            }
          } else {
            element.textContent = text;
          }
        });

        // 更新所有带data-i18n-title属性的元素的title
        const titleElements = document.querySelectorAll('[data-i18n-title]');
        titleElements.forEach(element => {
          const key = element.getAttribute('data-i18n-title');
          const titleText = this.t(key);
          element.setAttribute('title', titleText);
        });

        // 更新页面标题
        const title = document.getElementById('page-title');
        if (title) {
          title.textContent = this.t('pageTitle');
        }

        // 更新代码编辑器按钮
        const codeEditorBtn = document.querySelector('button[onclick*="editor.html"]');
        if (codeEditorBtn) {
          const span = codeEditorBtn.querySelector('span');
          if (span) {
            span.textContent = this.t('codeEditor');
          }
          codeEditorBtn.setAttribute('title', this.t('codeEditor'));
        }

        // 更新语言按钮提示
        const langBtn = document.getElementById('language-toggle');
        if (langBtn) {
          langBtn.setAttribute('title', this.currentLanguage === 'zh' ? '切换到英文' : 'Switch to Chinese');
        }

        // 处理动态内容翻译
        this.applyToDynamicContent();

        // 如果当前在学生管理或教师管理页面，重新加载内容以确保翻译正确
        const pageContent = document.getElementById('page-content');
        if (pageContent) {
          const currentPageTitle = pageContent.querySelector('h2');
          if (currentPageTitle) {
            const titleText = currentPageTitle.textContent;
            if (titleText.includes(this.t('studentManagement')) || titleText.includes(this.t('teacherManagement'))) {
              // 重新加载当前页面以应用新的语言设置
              const currentPageBtn = document.querySelector('.nav-item.active');
              if (currentPageBtn && currentPageBtn.getAttribute('data-page')) {
                const pageId = currentPageBtn.getAttribute('data-page');
                if (pageId === 'students' || pageId === 'teachers') {
                  console.log('Reloading page content for language change:', pageId);
                  setTimeout(() => {
                    if (window.app && window.app.loadUsersPage) {
                      window.app.loadUsersPage(pageId);
                    }
                  }, 100);
                }
              }
            }
          }
        }

        console.log('Language update completed');
      },

      // 为动态内容应用翻译
      applyToDynamicContent(container = document.body) {
        if (!container) return;

        // 处理data-i18n属性
        const elements = container.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
          const key = element.getAttribute('data-i18n');
          if (key && this.translations[this.currentLanguage][key]) {
            if (element.tagName === 'INPUT') {
              element.placeholder = this.t(key);
            } else if (element.tagName === 'TEXTAREA') {
              element.placeholder = this.t(key);
            } else {
              element.textContent = this.t(key);
            }
          }
        });

        // 处理data-i18n-placeholder属性
        const placeholderElements = container.querySelectorAll('[data-i18n-placeholder]');
        placeholderElements.forEach(element => {
          const key = element.getAttribute('data-i18n-placeholder');
          if (key && this.translations[this.currentLanguage][key]) {
            element.placeholder = this.t(key);
          }
        });

        // 处理动态title属性
        const titledElements = container.querySelectorAll('[title]');
        titledElements.forEach(element => {
          const title = element.getAttribute('title');
          if (title && this.translations[this.currentLanguage][title]) {
            element.setAttribute('title', this.t(title));
          }
        });

        // 处理带有i18n-dynamic类的元素（支持模板替换）
        const dynamicElements = container.querySelectorAll('.i18n-dynamic');
        dynamicElements.forEach(element => {
          const templateKey = element.getAttribute('data-i18n-template');
          const count = element.getAttribute('data-count');
          if (templateKey && count !== null && this.translations[this.currentLanguage][templateKey]) {
            const template = this.t(templateKey);
            element.textContent = template.replace('{count}', count);
          }
        });

        // 特别处理导航菜单的span元素（没有data-i18n但有特定文本）
        const navSpans = container.querySelectorAll('nav span');
        navSpans.forEach(span => {
          const text = span.textContent.trim();
          // 根据中文文本找到对应的翻译键
          const keyMap = {
            '仪表盘': 'dashboard',
            '课程管理': 'courseManagement',
            '教师管理': 'teacherManagement',
            '学生管理': 'studentManagement',
            '个人资料': 'profile',
            '课程': 'courses'
          };
          if (keyMap[text]) {
            span.setAttribute('data-i18n', keyMap[text]);
            span.textContent = this.t(keyMap[text]);
          }
        });
      }
    };

    // 将 i18n 对象暴露到全局作用域
    window.i18n = i18n;

    // 语言切换函数
    function toggleLanguage(event) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      // 防抖处理
      if (toggleLanguage.lastClick && (Date.now() - toggleLanguage.lastClick < 300)) {
        console.log('Language toggle clicked too quickly, ignoring');
        return;
      }
      toggleLanguage.lastClick = Date.now();

      console.log('Toggling language from', i18n.currentLanguage);
      i18n.toggle();
      
      // 同步到全局设置
      if (window.globalSettings) {
        window.globalSettings.language = i18n.currentLanguage;
      }
    }

    // 主题切换函数
    function toggleThemeTest() {
      // 使用全局设置管理器切换主题
      if (window.globalSettings) {
        window.globalSettings.toggleTheme();
      } else {
        // 降级处理
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
      }

      const isLight = document.body.classList.contains('light-theme');
      
      // 更新按钮图标
      const themeToggleBtn = document.getElementById('main-theme-toggle');
      if (themeToggleBtn) {
        if (isLight) {
          // 浅色主题显示月亮图标
          themeToggleBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          `;
        } else {
          // 深色主题显示太阳图标
          themeToggleBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          `;
        }
      }
    }

    // 页面加载时恢复保存的主题和语言
    window.addEventListener('load', function() {
      // 初始化国际化系统
      i18n.init();
      
      // 从全局设置同步语言
      if (window.globalSettings && window.globalSettings.language !== i18n.currentLanguage) {
        i18n.setLanguage(window.globalSettings.language);
      }

      // 添加语言切换按钮事件监听器
      const langToggleBtn = document.getElementById('language-toggle');
      if (langToggleBtn) {
        langToggleBtn.addEventListener('click', toggleLanguage);
      }

      // 主题已由 globalSettings.js 自动处理
      const savedTheme = window.globalSettings ? window.globalSettings.theme : localStorage.getItem('theme');
      const themeToggleBtn = document.getElementById('main-theme-toggle');

      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        // 设置月亮图标
        if (themeToggleBtn) {
          themeToggleBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          `;
        }
      } else {
        // 设置太阳图标（默认深色主题）
        if (themeToggleBtn) {
          themeToggleBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          `;
        }
      }
    });

    // ========== 端口配置 ==========
    const API_PORT = 5024;
    const FRONTEND_PORT = 5020;
    const API_BASE = `http://localhost:${API_PORT}/api`;

    // 创建一个代理fetch函数，自动替换硬编码的端口
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      // 如果URL包含硬编码的API端口，自动替换为配置的端口
      if (typeof url === 'string') {
        url = url.replace(/http:\/\/localhost:50\d{2}\/api/g, API_BASE);
      }
      return originalFetch.call(this, url, options);
    };

    class OnlineJudgeApp {
      constructor() {
        this.currentUser = null;
        this.currentPage = 'dashboard';
        // 当前选中的"代码库案例"作为作业模板
        this.currentAssignmentTemplate = null;
        // 代码库过滤状态
        this.currentFilter = 'all';
        this.filteredExamples = [];
        this.builtInExamples = [];
        // 初始化国际化系统
        this.i18n = i18n;
      }

      /**
       * 安全的翻译方法，在翻译系统未初始化时返回默认文本
       */
      getTranslationText(key) {
        try {
          return typeof t === 'function' ? t(key) : this.getDefaultTranslation(key);
        } catch (error) {
          return this.getDefaultTranslation(key);
        }
      }

      /**
       * 获取默认翻译文本（中文）
       */
      getDefaultTranslation(key) {
        const defaultTranslations = {
          'courseManagement': '课程',
          'teacherManagement': '教师',
          'studentManagement': '学生',
          'assignmentManagement': '作业',
          'codeRepository': '代码库',
          'createNewAssignment': '创建作业',
          'viewAssignments': '查看作业',
          'myAssignments': '我的作业',
          'assignmentTitle': '作业标题',
          'assignmentDescription': '作业描述',
          'assignmentDeadline': '截止时间',
          'selectCourse': '选择课程',
          'course': '所属课程',
          'enterAssignmentTitle': '请输入作业标题',
          'enterAssignmentDescription': '请输入作业描述和具体要求',
          'createAssignment': '创建作业',
          'cancel': '取消',
          'dashboard': '仪表盘',
          'inProgress': '进行中',
          'ended': '已结束',
          'expired': '已过期',
          'startAssignment': '开始作业',
          'pending': '待完成',
          'deadline': '截止',
          'submitted': '提交',
          'teacher': '教师',
          'submissionStatus': '提交状态',
          'submissionDetails': '提交详情',
          'assignmentInfo': '作业信息',
          'assignedStudents': '分配学生',
          'graded': '已批改',
          'noSubmission': '未提交',
          'viewSubmission': '查看提交',
          'viewCode': '查看代码',
          'gradeSubmission': '批改作业',
          'notSet': '未设置',
          'people': '人',
          'copies': '份',
          'score': '分数',
          'points': '分',
          'scorePlaceholder': '分数',
          'modify': '修改',
          'updateScore': '更新分数',
          'view': '查看',
          'update': '更新',
          'unknownMajor': '未知专业',
          'noAssignedStudents': '暂无分配的学生',
          'apiError': 'API连接错误',
          'colon': '：',
          'totalCoursesWithCount': '共 {count} 门课程',
          'totalAssignments': '共 {count} 个作业',
          'createdAt': '创建时间',
          'viewRelatedAssignments': '查看相关作业'
        };
        return defaultTranslations[key] || key;
      }

      /**
       * 初始化默认数据
       */
      initDefaultData() {
        // 初始化默认教师数据
        if (!localStorage.getItem('oj-teachers')) {
          const defaultTeachers = [
            {
              id: 'teacher_001',
              username: 'teacher001',
              email: 'teacher001@onlinejudge.com',
              fullName: '李老师',
              role: 'teacher',
                        department: '计算机科学系',
              phone: '13800138001',
              isActive: true,
              createdAt: new Date().toISOString()
            },
            {
              id: 'teacher_002',
              username: 'teacher002',
              email: 'teacher002@onlinejudge.com',
              fullName: '王老师',
              role: 'teacher',
                        department: '软件工程系',
              phone: '13800138002',
              isActive: true,
              createdAt: new Date().toISOString()
            }
          ];
          localStorage.setItem('oj-teachers', JSON.stringify(defaultTeachers));
        }

        // 初始化默认学生数据
        if (!localStorage.getItem('oj-students')) {
          const defaultStudents = [
            {
              id: 'student_001',
              username: 'student001',
              email: 'student001@onlinejudge.com',
              fullName: '张三',
              role: 'student',
                            studentId: '2021001',
              grade: '2021级',
              major: '计算机科学与技术',
              isActive: true,
              createdAt: new Date().toISOString()
            },
            {
              id: 'student_002',
              username: 'student002',
              email: 'student002@onlinejudge.com',
              fullName: '李四',
              role: 'student',
                            studentId: '2021002',
              grade: '2021级',
              major: '软件工程',
              isActive: true,
              createdAt: new Date().toISOString()
            }
          ];
          localStorage.setItem('oj-students', JSON.stringify(defaultStudents));
        }

        // 初始化默认课程数据
        if (!localStorage.getItem('oj-courses')) {
          const defaultCourses = [
            {
              id: 'course_001',
              title: 'Web开发基础',
              code: 'WEB101',
              description: '学习HTML、CSS和JavaScript基础知识',
              teacherId: 'teacher_001',
              teacherName: '李老师',
              status: 'active',
              maxStudents: 50,
              enrolledStudents: ['student_001', 'student_002'],
              createdAt: new Date().toISOString()
            },
            {
              id: 'course_002',
              title: '数据结构与算法',
              code: 'CS201',
              description: '学习基本数据结构和算法设计',
              teacherId: 'teacher_002',
              teacherName: '王老师',
              status: 'active',
              maxStudents: 40,
              enrolledStudents: ['student_001'],
              createdAt: new Date().toISOString()
            }
          ];
          localStorage.setItem('oj-courses', JSON.stringify(defaultCourses));
        }

        // 初始化默认作业数据
        if (!localStorage.getItem('oj-assignments')) {
          const defaultAssignments = [
            {
              id: 'assignment_001',
              title: 'JavaScript基础练习',
              description: '完成JavaScript基础语法练习题',
              courseId: 'course_001',
              courseName: 'Web开发基础',
              teacherId: 'teacher_001',
              teacherName: '李老师',
              deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
              status: 'active',
              assignedStudents: ['student_001', 'student_002'],
              submissions: [],
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            },
            {
              id: 'assignment_002',
              title: 'CSS样式设计',
              description: '设计响应式网页布局',
              courseId: 'course_001',
              courseName: 'Web开发基础',
              teacherId: 'teacher_001',
              teacherName: '李老师',
              deadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
              status: 'active',
              assignedStudents: ['student_001'],
              submissions: [],
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            }
          ];
          localStorage.setItem('oj-assignments', JSON.stringify(defaultAssignments));
        }
      }

      /**
       * 获取所有教师
       */
      async getAllTeachers() {
        try {
          // 优先从API获取最新数据
          const response = await fetch(`${API_BASE}/users?role=teacher`);
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              // 标准化字段名，将 full_name 转换为 fullName
              return result.data.map(teacher => ({
                ...teacher,
                fullName: teacher.full_name || teacher.fullName || '未命名教师'
              }));
            }
          }

          // API失败时从localStorage获取备用数据
          return JSON.parse(localStorage.getItem('oj-teachers') || '[]');
        } catch (error) {
          console.error('获取教师列表失败:', error);
          try {
            return JSON.parse(localStorage.getItem('oj-teachers') || '[]');
          } catch {
            return [];
          }
        }
      }

      /**
       * 根据ID获取教师
       */
      async getTeacherById(teacherId) {
        try {
          const teachers = await this.getAllTeachers();
          return teachers.find(t => t.id == teacherId) || null;
        } catch (error) {
          console.error('获取教师信息失败:', error);
          return null;
        }
      }

      /**
       * 获取所有学生
       */
      async getAllStudents() {
        try {
          // 优先从API获取最新数据
          const response = await fetch(`${API_BASE}/users?role=student`);
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              // 标准化字段名，将下划线格式转换为驼峰格式
              const students = result.data.map(student => ({
                ...student,
                fullName: student.full_name || student.fullName || '未命名学生',
                studentId: student.student_id || student.studentId || '',
                employeeId: student.employee_id || student.employeeId || '',
                grade: student.grade || ''
              }));
              // 缓存到localStorage
              localStorage.setItem('oj-students', JSON.stringify(students));
              return students;
            }
          }

          // API失败时从localStorage获取备用数据
          return JSON.parse(localStorage.getItem('oj-students') || '[]');
        } catch (error) {
          console.error('获取学生列表失败:', error);
          try {
            return JSON.parse(localStorage.getItem('oj-students') || '[]');
          } catch {
            return [];
          }
        }
      }

      /**
       * 获取所有学生（同步版本，从缓存获取）
       */
      getAllStudentsSync() {
        try {
          return JSON.parse(localStorage.getItem('oj-students') || '[]');
        } catch (error) {
          console.error('获取学生列表失败:', error);
          return [];
        }
      }

      /**
       * 根据ID获取学生
       */
      async getStudentById(studentId) {
        try {
          const students = await this.getAllStudents();
          return students.find(s => s.id === studentId) || null;
        } catch (error) {
          console.error('获取学生信息失败:', error);
          return null;
        }
      }

      /**
       * 获取所有用户（从数据库）
       */
      async getAllUsers() {
        try {
          const response = await fetch(`${API_BASE}/users`);
          const result = await response.json();

          if (result.success) {
            return result.data || [];
          } else {
            console.error('获取用户列表失败:', result.message);
            return [];
          }
        } catch (error) {
          console.error('获取用户列表异常:', error);
          return [];
        }
      }

      /**
       * 添加教师（到数据库）
       */
      async addTeacher(teacherData) {
        try {
          const userData = {
            fullName: teacherData.fullName,
            username: teacherData.username,
            email: teacherData.email || `teacher_${teacherData.username}_${Date.now()}@school.local`,
            role: 'teacher',
            employeeId: teacherData.employeeId || teacherData.username,
            phone: teacherData.phone,
            department: teacherData.department,
            password: teacherData.password || '123123'
          };

          const response = await fetch(`${API_BASE}/users/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error('添加教师失败:', error);
          return { success: false, error: error.message };
        }
      }

      /**
       * 添加学生（到数据库）
       */
      async addStudent(studentData) {
        try {
          const userData = {
            fullName: studentData.fullName,
            username: studentData.username,
            email: studentData.email || `student_${studentData.username}_${Date.now()}@school.local`,
            role: 'student',
            studentId: studentData.studentId,
            grade: studentData.grade,
            major: studentData.major,
            password: studentData.password || '123123'
          };

          const response = await fetch(`${API_BASE}/users/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error('添加学生失败:', error);
          return { success: false, error: error.message };
        }
      }

      /**
       * 添加课程
       */
      async addCourse(courseData) {
        try {
          console.log('🚀 正在创建课程，调用API...');

          // 验证必需参数
          if (!courseData.teacherId || courseData.teacherId === '') {
            throw new Error('请选择课程教师');
          }

          // 调用后端API创建课程
          const response = await fetch(`${API_BASE}/courses`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title: courseData.title,
              description: courseData.description || '',
              teacher_id: parseInt(courseData.teacherId), // 转换为整数
              max_students: courseData.maxStudents || 50,
              category: '',
              difficulty: '初级',
              tags: null, // 使用null而不是[]
              is_public: 1,
              start_date: null, // 明确传递null
              end_date: null,   // 明确传递null
              cover_image: null,
              status: '已发布'
            })
          });

          const result = await response.json();
          console.log('📨 API响应:', result);

          if (result.success) {
            // 清除本地缓存，强制从数据库重新加载
            localStorage.removeItem('oj-courses');
            return { success: true, data: result.data };
          } else {
            throw new Error(result.message || '创建课程失败');
          }
        } catch (error) {
          console.error('❌ 添加课程失败:', error);
          return { success: false, error: error.message };
        }
      }

  
      /**
       * 处理创建课程
       */
      async handleCreateCourse(event) {
        const formData = new FormData(event.target);
        const courseData = {
          title: formData.get('title'),
          code: formData.get('code'),
          description: formData.get('description'),
          teacherId: formData.get('teacherId'),
          maxStudents: parseInt(formData.get('maxStudents'))
        };

        try {
          // 获取选中的教师信息
          const teachers = await this.getAllTeachers();
          const selectedTeacher = teachers.find(t => t.id === courseData.teacherId);

          if (selectedTeacher) {
            courseData.teacherId = selectedTeacher.id;
            courseData.teacherName = selectedTeacher.fullName;
            courseData.teacherUsername = selectedTeacher.username;
          }

          // 创建课程
          const result = await this.createCourse(courseData);

          if (result.success) {
            this.closeModal();
            this.showNotification('课程创建成功！', 'success');
            this.loadCoursesPage(); // 刷新课程页面
          } else {
            this.showNotification(result.error || '创建课程失败', 'error');
          }
        } catch (error) {
          console.error('创建课程失败:', error);
          this.showNotification('创建课程时发生错误', 'error');
        }
      }

      /**
       * 创建课程（API调用）
       */
      async createCourse(courseData) {
        try {
          const response = await fetch(`${API_BASE}/courses`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(courseData)
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error('创建课程失败:', error);
          // 如果API失败，使用本地存储作为后备
          return this.addCourse(courseData);
        }
      }

      /**
       * 删除教师
       */
      async deleteTeacher(teacherId) {
        try {
          const response = await fetch(`${API_BASE}/users/${teacherId}`, {
            method: 'DELETE'
          });

          const result = await response.json();

          if (result.success) {
            return { success: true };
          } else {
            return { success: false, error: result.message || '删除教师失败' };
          }
        } catch (error) {
          console.error('删除教师失败:', error);
          return { success: false, error: error.message };
        }
      }

      
      /**
       * 删除学生
       */
      async deleteStudent(studentId) {
        try {
          const response = await fetch(`${API_BASE}/users/${studentId}`, {
            method: 'DELETE'
          });

          const result = await response.json();

          if (result.success) {
            return { success: true };
          } else {
            return { success: false, error: result.message || '删除学生失败' };
          }
        } catch (error) {
          console.error('删除学生失败:', error);
          return { success: false, error: error.message };
        }
      }

      /**
       * 显示编辑学生模态框
       */
      async editStudent(studentId) {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        // 强制刷新学生数据以确保字段格式正确
        await this.getAllStudents();
        const student = await this.getStudentById(studentId);
        if (!student) return;

        const modalHtml = `
          <div id="edit-student-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">${t('editStudent')}</h3>
              <form id="edit-student-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="fullName">${t('fullName')}</label>
                  <input type="text" name="fullName" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.fullName}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="usernameForLogin">${t('usernameForLogin')}</label>
                  <input type="text" name="username" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.username}">
                </div>
                    <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="studentId">${t('studentId')}</label>
                  <input type="text" name="studentId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.studentId}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="grade">${t('grade')}</label>
                  <input type="text" name="grade" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.grade}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="major">${t('major')}</label>
                  <input type="text" name="major" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.major}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="email">${t('email')}</label>
                  <input type="email" name="email"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.email || ''}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="phone">${t('phone')}</label>
                  <input type="tel" name="phone"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${student.phone || ''}">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    <span data-i18n="cancel">${t('cancel')}</span>
                  </button>
                  <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    <span data-i18n="saveChanges">${t('saveChanges')}</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 确保模态框中的 data-i18n 元素被正确翻译
        setTimeout(() => {
          if (window.i18n) {
            const modal = document.getElementById('edit-student-modal');
            if (modal) {
              window.i18n.applyToDynamicContent(modal);
            }
          }
        }, 10);

        document.getElementById('edit-student-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleEditStudent(studentId, e);
        });
      }

      /**
       * 处理编辑学生
       */
      async handleEditStudent(studentId, event) {
        const formData = new FormData(event.target);

        try {
          // 准备API数据格式（转换为下划线格式）
          const apiData = {
            full_name: formData.get('fullName'),
            username: formData.get('username'),
            student_id: formData.get('studentId'),
            grade: formData.get('grade'),
            major: formData.get('major'),
            email: formData.get('email'),
            phone: formData.get('phone')
          };

          // 调用API更新学生信息
          const response = await fetch(`http://localhost:5025/api/users/${studentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiData)
          });

          const result = await response.json();

          if (result.success) {
            this.closeModal();
            this.loadUsersPage('students');
            alert('学生信息更新成功！');

            // 清除本地缓存，强制重新获取数据
            localStorage.removeItem('oj-students');
          } else {
            alert('更新失败：' + (result.message || '未知错误'));
          }
        } catch (error) {
          console.error('更新学生信息失败:', error);
          alert('更新失败：网络错误，请稍后重试');
        }
      }

      /**
       * 同步用户数据到API服务器
       */
      async syncUsersToServer() {
        try {
          const allUsers = this.getAllUsers();
          const response = await fetch(`${API_BASE}/users/sync`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              users: allUsers
            })
          });

          const result = await response.json();
          if (result.success) {
            console.log('✅ 用户数据同步成功:', result.message);
          } else {
            console.error('❌ 用户数据同步失败:', result.message);
          }
        } catch (error) {
          console.error('❌ 用户数据同步异常:', error);
        }
      }

      
      /**
       * 应用初始化
       */
      async init() {
        try {
          console.log('🚀 应用初始化开始...');

          // 初始化默认数据
          this.initDefaultData();

          // 获取当前用户
          const user = await this.getCurrentUser();
          if (user) {
            this.showMainApp(user);
          } else {
            // 如果没有用户信息，跳转到登录页面
            window.location.href = 'login.html';
            return;
          }

          this.bindEvents();

          console.log('✅ 应用初始化完成');
        } catch (error) {
          console.error('💥 应用初始化失败:', error);
        }
      }

      /**
       * 获取当前用户
       */
      async getCurrentUser() {
        try {
          // 首先尝试从 sessionStorage 获取用户信息
          const sessionUser = sessionStorage.getItem('current-user');
          const localUser = localStorage.getItem('currentUser');

          // 优先使用 sessionStorage 中的信息，因为这是 userAuth.js 存储的主要位置
          let userData = null;
          if (sessionUser) {
            userData = JSON.parse(sessionUser);
            console.log('✅ 从 sessionStorage 获取到用户信息:', userData.fullName);
          } else if (localUser) {
            userData = JSON.parse(localUser);
            console.log('✅ 从 localStorage 获取到用户信息:', userData.fullName);
            // 同步到 sessionStorage 以确保一致性
            sessionStorage.setItem('current-user', JSON.stringify(userData));
          }

          if (userData && userData.id && userData.username && userData.role) {
            console.log('✅ 用户数据验证通过');
            return userData;
          } else {
            console.log('❌ 用户数据不完整或不存在');
            return null;
          }
        } catch (error) {
          console.error('获取用户信息失败:', error);
          return null;
        }
      }

      /**
       * 显示主应用界面
       */
      showMainApp(user) {
        this.currentUser = user;
        this.updateUserInfo(user);
        this.renderNavigation();

        // 检查是否有编辑器返回页面信息
        const returnPage = localStorage.getItem('editor-return-page');
        if (returnPage) {
          console.log('🔙 检测到编辑器返回页面信息:', returnPage);
          // 清除返回页面信息，避免下次重复使用
          localStorage.removeItem('editor-return-page');

          // 根据返回页面信息导航到相应页面
          if (returnPage === 'dashboard') {
            this.navigateToPage('dashboard');
          } else if (returnPage === 'student-assignments') {
            this.navigateToPage('assignments');
          } else if (returnPage === 'code-repository') {
            this.navigateToPage('codeRepo');
          } else {
            // 默认返回到仪表盘
            this.navigateToPage('dashboard');
          }
        } else {
          // 没有返回页面信息，默认导航到仪表盘
          this.navigateToPage('dashboard');
        }
      }

      /**
       * 更新用户信息显示
       */
      updateUserInfo(user) {
        console.log('🔧 [updateUserInfo] 更新用户信息:', user);
        console.log('🔧 [updateUserInfo] 用户角色:', user.role);

        const userNameEl = document.getElementById('user-name');
        const userRoleEl = document.getElementById('user-role');

        if (userNameEl) {
          userNameEl.textContent = user.fullName || user.username;
          console.log('✅ [updateUserInfo] 用户名已更新:', userNameEl.textContent);
        } else {
          console.error('❌ [updateUserInfo] 未找到 user-name 元素');
        }

        if (userRoleEl) {
          userRoleEl.textContent = user.role || '用户';
          console.log('✅ [updateUserInfo] 用户角色已更新:', userRoleEl.textContent);
        } else {
          console.error('❌ [updateUserInfo] 未找到 user-role 元素');
        }
      }

      /**
       * 获取用户可访问的菜单项
       */
      getAccessibleMenuItems(user) {
        const userRole = user.role || user;
        const menuItems = [
          {
            id: 'dashboard',
            label: '仪表盘',
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>',
            roles: ['admin', 'teacher', 'student']
          }
        ];

        // 管理员功能：课程管理、教师管理、学生管理
        if (userRole === 'admin') {
          menuItems.push(
            {
              id: 'courses',
              label: 'courseManagement',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>',
              roles: ['admin']
            },
            {
              id: 'teachers',
              label: 'teacherManagement',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>',
              roles: ['admin']
            },
            {
              id: 'students',
              label: 'studentManagement',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z"></path>',
              roles: ['admin']
            }
          );
        }

        // 教师功能：学生管理、作业管理
        if (userRole === 'teacher') {
          menuItems.push(
            {
              id: 'students',
              label: 'studentManagement',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z"></path>',
              roles: ['teacher']
            },
            {
              id: 'assignments',
              label: 'assignmentManagement',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>',
              roles: ['teacher']
            }
          );
        }

        // 学生功能：作业、课程
        if (userRole === 'student') {
          menuItems.push(
            {
              id: 'assignments',
              label: 'myAssignments',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>',
              roles: ['student']
            },
            {
              id: 'courses',
              label: 'myCourses',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>',
              roles: ['student']
            }
          );
        }

        // 只有教师可以访问代码库
        if (userRole === 'teacher') {
          menuItems.push(
            {
              id: 'codeRepo',
              label: 'codeRepository',
              icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10"></path>',
              roles: ['teacher']
            }
          );
        }

        // 所有用户都有个人资料
        menuItems.push(
          {
            id: 'profile',
            label: '个人资料',
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>',
            roles: ['admin', 'teacher', 'student']
          }
        );

        return menuItems.filter(item => item.roles.includes(userRole));
      }

      /**
       * 渲染导航菜单
       */
      renderNavigation() {
        console.log('🔄 渲染导航菜单，当前用户:', this.currentUser);
        const menuItems = this.getAccessibleMenuItems(this.currentUser);
        console.log('📋 获取到的菜单项:', menuItems);
        const navMenu = document.getElementById('nav-menu');

        if (!navMenu) {
          console.error('找不到导航菜单容器');
          return;
        }

        navMenu.innerHTML = menuItems.map(item => `
          <button class="nav-item w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center space-x-3 ${item.id === 'dashboard' ? 'active' : ''}"
            data-page="${item.id}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${item.icon}
            </svg>
            <span data-i18n="${item.label}">${this.getTranslationText(item.label)}</span>
          </button>
        `).join('');

        // 绑定导航点击事件
        navMenu.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', (e) => {
            const page = e.currentTarget.dataset.page;
            this.navigateToPage(page);
          });
        });

        // 全局事件委托
        document.addEventListener('click', (e) => {
          if (e.target.closest('.nav-item')) {
            const navItem = e.target.closest('.nav-item');
            const page = navItem.dataset.page;
            this.navigateToPage(page);
          }
        });
      }

      /**
       * 导航到指定页面
       */
      async navigateToPage(pageId) {
        console.log('🚀 导航到页面:', pageId);

        // 更新导航状态
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const targetNavItem = document.querySelector(`[data-page="${pageId}"]`);
        if (targetNavItem) {
          targetNavItem.classList.add('active');
        }

        // 更新页面标题 - 使用i18n系统
        const pageTitleKeys = {
          dashboard: 'pageTitle',
          users: 'userManagement',
          teachers: 'teacherManagement',
          students: 'studentManagement',
          courses: 'courses',
          assignments: 'assignments',
          profile: 'profile'
        };
        const pageTitleKey = pageTitleKeys[pageId] || 'pageTitle';
        const pageTitleElement = document.getElementById('page-title');
        pageTitleElement.setAttribute('data-i18n', pageTitleKey);
        pageTitleElement.textContent = i18n.t(pageTitleKey);

        // 处理特殊页面
        if (pageId === 'editor') {
          console.log('🔄 跳转到代码编辑器...');
          // 设置返回页面信息
          localStorage.setItem('editor-return-page', 'dashboard');
          window.location.href = 'editor.html';
          return;
        }

        // 加载页面内容
        this.loadPageContent(pageId).then(() => {
          // 在页面加载后应用当前语言设置
          setTimeout(() => {
            i18n.applyToDynamicContent(document.getElementById('page-content'));
          }, 100);
        });
      }

      /**
       * 加载页面内容
       */
      async loadPageContent(pageId) {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;

        switch (pageId) {
          case 'dashboard':
            await this.loadDashboard();
            break;
          case 'profile':
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

          pageContent.innerHTML = `
              <div class="animate-fade-in-up">
                <h2 class="text-xl font-semibold text-white mb-4" data-i18n="personalProfile">${t('personalProfile')}</h2>
                <div class="glass-effect rounded-lg p-6">
                  <!-- 头像区域 -->
                  <div class="flex items-center space-x-6 mb-8">
                    <div class="w-24 h-24 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                      ${currentUser.fullName ? currentUser.fullName.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div>
                      <h3 class="text-2xl font-bold text-white">${currentUser.fullName}</h3>
                      <p class="text-gray-400 text-lg">${currentUser.email}</p>
                      <span class="inline-block mt-2 px-3 py-1 text-sm rounded-full ${currentUser.role === 'teacher' ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-blue-500 bg-opacity-20 text-blue-400'}">
                        ${currentUser.role === 'teacher' ? t('teacher') : t('student')}
                      </span>
                    </div>
                  </div>

                  <!-- 编辑表单 -->
                  <form id="profile-edit-form" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="fullName">${t('fullName')} *</label>
                        <input type="text" id="edit-name" value="${currentUser.fullName || ''}" required
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="username">${t('username')}</label>
                        <input type="text" value="${currentUser.username || ''}" disabled
                               class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-gray-400 cursor-not-allowed">
                      </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="email">${t('email')} *</label>
                        <input type="email" id="edit-email" value="${currentUser.email || ''}" required
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="phone">${t('phone')}</label>
                        <input type="tel" id="edit-phone" value="${currentUser.phone || ''}"
                               placeholder="${t('phone')}"
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                    </div>

                    ${currentUser.role === 'student' ? `
                    <!-- 学生特有信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="studentId">${t('studentId')}</label>
                        <input type="text" value="${currentUser.studentId || ''}"
                               placeholder="${t('studentId')}"
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="major">${t('major')}</label>
                        <input type="text" id="edit-major" value="${currentUser.major || ''}"
                               placeholder="${t('major')}"
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                    </div>
                    ` : ''}

                    ${currentUser.role === 'teacher' ? `
                    <!-- 教师特有信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="employeeId">${t('employeeId')}</label>
                        <input type="text" id="edit-teacher-id" value="${currentUser.teacherId || ''}"
                               placeholder="${t('employeeId')}"
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="department">${t('department')}</label>
                        <input type="text" id="edit-department" value="${currentUser.department || ''}"
                               placeholder="${t('department')}"
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                      </div>
                    </div>
                    ` : ''}

                    <!-- 个人简介 -->
                    <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="bio">${t('bio')}</label>
                      <textarea id="edit-bio" rows="4"
                                placeholder="${t('bioPlaceholder')}"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all">${currentUser.bio || ''}</textarea>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-700">
                      <button type="button" id="cancel-edit-btn"
                              class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        <span data-i18n="cancel">${t('cancel')}</span>
                      </button>
                      <button type="submit"
                              class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <span data-i18n="save">${t('save')}</span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            `;

            // 添加表单事件监听器
            setTimeout(() => {
              this.setupProfileForm();
            }, 100);
            break;
          case 'courses':
            if (currentUser.role === 'student') {
              await this.loadStudentCoursesPage();
            } else {
              this.loadCoursesPage();
            }
            break;
          case 'assignments':
            if (currentUser.role === 'student') {
              this.loadStudentAssignmentsPage();
            } else {
              this.loadAssignmentsPage();
            }
            break;
          case 'users':
          case 'teachers':
          case 'students':
            this.loadUsersPage(pageId);
            break;
          case 'codeRepo':
            this.loadCodeRepositoryPage();
            break;
          default:
            pageContent.innerHTML = `
              <div class="animate-fade-in-up">
                <h2 class="text-xl font-semibold text-white mb-4">${pageId}</h2>
                <div class="glass-effect rounded-lg p-6">
                  <p class="text-gray-300" data-i18n="featureInDevelopment">该功能正在开发中...</p>
                </div>
              </div>
            `;
        }
      }

      /**
       * 获取课程统计数据 - 使用API获取最新数据
       */
      async getCourseStats() {
        try {
          console.log('📊 getCourseStats: 调用API获取最新课程数据...');
          const courses = await this.getAllCourses();
          console.log('📊 getCourseStats: 获取到课程数据:', courses.length, '门课程');

          const currentUser = this.currentUser;
          let filteredCourses = courses;

          // 根据用户角色过滤课程
          if (currentUser.role === 'student') {
            // 学生只看到自己报名的课程 - 修复数据类型匹配问题
            const currentUserIdStr = String(currentUser.id);
            const currentUserIdNum = Number(currentUser.id);
            filteredCourses = courses.filter(c => {
              const enrolledStudentIds = c.enrolledStudents || c.enrolled_students || [];
              return enrolledStudentIds.includes(currentUserIdStr) || enrolledStudentIds.includes(currentUserIdNum);
            });
            console.log('📊 学生过滤后课程:', filteredCourses.length, '门', '用户ID:', currentUser.id);
          } else if (currentUser.role === 'teacher') {
            // 教师只看到自己教授的课程 - 修复字段映射问题
            filteredCourses = courses.filter(c => {
              const teacherIdMatch = String(c.teacherId || c.teacher_id) === String(currentUser.id);
              const teacherNameMatch = c.teacherFullName === currentUser.fullName || c.teacher_name === currentUser.username;
              return teacherIdMatch || teacherNameMatch;
            });
            console.log('📊 教师过滤后课程:', filteredCourses.length, '门', '用户ID:', currentUser.id);
          }
          // admin看到所有课程，不需要过滤

          const stats = {
            totalCourses: filteredCourses.length,
            activeCourses: filteredCourses.filter(c => c.status === 'active' || c.status === '已发布').length,
            totalStudents: currentUser.role === 'admin'
              ? courses.reduce((sum, c) => sum + (c.enrolledCount || 0), 0)  // admin看到所有学生总数
              : (currentUser.role === 'teacher'
                ? filteredCourses.reduce((sum, c) => sum + (c.enrolledCount || 0), 0)  // 教师看到自己课程的学生总数
                : 0)  // 学生不需要看学生数
          };

          console.log('📊 getCourseStats: 计算得到的统计数据:', stats);
          return stats;
        } catch (error) {
          console.error('获取课程统计失败:', error);
          return { totalCourses: 0, activeCourses: 0, totalStudents: 0 };
        }
      }

      /**
       * 获取作业统计数据
       */
      async getAssignmentStats() {
        try {
          const assignments = await this.getAllAssignments();
          const currentUser = this.currentUser;
          let filteredAssignments = assignments;

          // 根据用户角色过滤作业
          if (currentUser.role === 'student') {
            // 学生只看到自己相关课程的作业 - 修复数据类型匹配问题
            const courses = await this.getAllCourses();
            const currentUserIdStr = String(currentUser.id);
            const currentUserIdNum = Number(currentUser.id);
            const myCourses = courses.filter(c => {
              const enrolledStudentIds = c.enrolledStudents || c.enrolled_students || [];
              return enrolledStudentIds.includes(currentUserIdStr) || enrolledStudentIds.includes(currentUserIdNum);
            });
            const myCourseIds = myCourses.map(c => String(c.id));
            filteredAssignments = assignments.filter(a =>
              myCourseIds.includes(String(a.courseId))
            );
            console.log('📊 学生作业统计:', {
              myCoursesCount: myCourses.length,
              myCourseIds,
              totalAssignments: assignments.length,
              filteredAssignments: filteredAssignments.length
            });
          } else if (currentUser.role === 'teacher') {
            // 教师只看到自己课程的作业 - 修复字段映射问题
            const courses = await this.getAllCourses();
            const myCourses = courses.filter(c => {
              const teacherIdMatch = String(c.teacherId || c.teacher_id) === String(currentUser.id);
              const teacherNameMatch = c.teacherFullName === currentUser.fullName || c.teacher_name === currentUser.username;
              return teacherIdMatch || teacherNameMatch;
            });
            const myCourseIds = myCourses.map(c => String(c.id));
            filteredAssignments = assignments.filter(a =>
              myCourseIds.includes(String(a.courseId))
            );
            console.log('📊 教师作业统计:', {
              myCoursesCount: myCourses.length,
              myCourseIds,
              totalAssignments: assignments.length,
              filteredAssignments: filteredAssignments.length
            });
          }
          // admin看到所有作业，不需要过滤

          return {
            totalAssignments: filteredAssignments.length,
            pendingSubmissions: currentUser.role === 'student'
              ? filteredAssignments.filter(a => {
                  // 检查学生是否已提交这个作业
                  const submissions = JSON.parse(localStorage.getItem('oj-submissions') || '[]');
                  const hasSubmitted = submissions.some(s =>
                    s.assignmentId === a.id && s.studentId === currentUser.id
                  );
                  return !hasSubmitted && (a.status === 'active' || a.status === 'published');
                }).length
              : filteredAssignments.filter(a => a.status === 'active' || a.status === 'published').length
          };
        } catch (error) {
          console.error('获取作业统计失败:', error);
          return { totalAssignments: 0, pendingSubmissions: 0 };
        }
      }

      /**
       * 获取所有课程
       */
      async getAllCourses() {
        try {
          console.log('📡 从API获取课程列表...');

          // 强制清除旧缓存
          localStorage.removeItem('oj-courses');
          console.log('🗑️ 已清除旧缓存数据');
          console.log('🔍 强制重新获取课程数据...');

          // 添加请求测试
          console.log('🌐 开始请求API...');
          const response = await fetch('http://localhost:5025/api/courses');
          console.log('📡 API响应状态:', response.status);
          console.log('📡 API响应头:', response.headers);

          const result = await response.json();
          console.log('📨 API完整响应:', result);
          console.log('📨 API数据详情:', result.data);

          if (result.success && result.data) {
            // 转换数据库字段到前端格式 - 与作业数据转换保持一致
            const courses = result.data.map(course => {
              console.log('🔍 处理课程数据:', course);
              return {
                id: course.id.toString(),
                title: course.title || course.name || `课程ID${course.id}`,
                name: course.title || course.name || `课程ID${course.id}`,
                course_code: course.course_code || course.code || 'N/A',
                description: course.description || '',
                // 使用前端格式的字段名
                teacherId: course.teacher_id?.toString(),
                teacherName: course.teacher_name || '未分配',
                teacherFullName: course.teacher_full_name || course.teacher_name || '未分配',
                enrolledStudents: course.enrolled_students || [],
                enrolledStudentsCount: course.enrolled_students_count || 0,
                enrolledCount: course.enrolled_students_count || 0,
                current_students: course.current_students || 0,  // 保留原始字段
                capacity: course.max_students || course.capacity || 0,
                status: course.status || '未知',
                createdAt: course.created_at
              };
            });

            console.log('✅ 转换后的课程数据:', courses);
            console.log('🔍 检查第一个课程的enrolledCount:', courses[0]?.enrolledCount);
            console.log('🔍 检查第一个课程的current_students来源:', courses[0]);

            // 强制显示数据详情
            if (courses.length > 0) {
              const course = courses[0];
              console.log('📊 课程数据详情:');
              console.log('  - 标题:', course.title);
              console.log('  - enrolledCount:', course.enrolledCount);
              console.log('  - current_students:', course.current_students);
              console.log('  - enrolledStudents:', course.enrolledStudents);
              console.log('  - enrolledStudents_count:', course.enrolledStudents_count);
            }

            // 不再缓存到localStorage，强制每次都从API获取最新数据
            // localStorage.setItem('oj-courses', JSON.stringify(courses));

            return courses;
          } else {
            console.warn('❌ API返回失败:', result.message);
            return [];
          }
        } catch (error) {
          console.error('❌ 从API获取课程失败:', error);
          return [];
        }
      }

      /**
       * 从数据库获取当前教师负责的课程
       */
      async getTeacherCoursesFromDatabase() {
        try {
          console.log('📡 从数据库获取教师课程...');

          if (!this.currentUser || !this.currentUser.id) {
            console.warn('❌ 用户未登录或ID无效');
            return [];
          }

          const response = await fetch(`http://localhost:5025/api/courses?teacher_id=${this.currentUser.id}`);
          console.log('📡 教师课程API响应状态:', response.status);

          const result = await response.json();
          console.log('📨 教师课程API响应:', result);

          if (result.success && result.data) {
            // 转换数据库字段到前端格式
            const courses = result.data.map(course => ({
              id: course.id.toString(),
              title: course.title || course.name || `课程ID${course.id}`,
              code: course.course_code || course.code || 'N/A',
              description: course.description || '',
              teacherId: course.teacher_id?.toString(),
              teacherName: course.teacherName || '未分配',
              teacherFullName: course.teacher_full_name || course.teacherName || '未分配',
              enrolledStudents: course.enrolledStudents || [],
              enrolledCount: course.enrolledStudents_count || 0,
              capacity: course.maxStudents || course.capacity || 0,
              status: course.status || '未知',
              createdAt: course.created_at
            }));

            console.log('✅ 转换后的教师课程数据:', courses);
            return courses;
          } else {
            console.warn('❌ 教师课程API返回失败:', result.message);
            return [];
          }
        } catch (error) {
          console.error('❌ 从数据库获取教师课程失败:', error);
          return [];
        }
      }

      /**
       * 根据ID获取课程
       */
      async getCourseById(courseId) {
        try {
          const courses = await this.getAllCourses();
          return courses.find(c => c.id === courseId) || null;
        } catch (error) {
          console.error('获取课程信息失败:', error);
          return null;
        }
      }

      /**
       * 获取所有作业
       */
      async getAllAssignments() {
        try {
          console.log('📡 从数据库获取作业列表...');

          const response = await fetch('http://localhost:5025/api/assignments');
          console.log('📡 作业API响应状态:', response.status);

          const result = await response.json();
          console.log('📨 作业API响应:', result);

          if (result.success && result.data) {
            // 转换数据库字段到前端格式
            const assignments = result.data.map(assignment => {
              const transformed = {
                id: assignment.id.toString(),
                title: assignment.title,
                description: assignment.description,
                courseId: assignment.course_id?.toString(),
                courseName: assignment.course_title || `课程ID${assignment.course_id}`,
                teacherId: assignment.teacher_id?.toString(),
                teacherName: assignment.teacher_name || '未分配',
                teacherFullName: assignment.teacher_full_name || assignment.teacher_name || '未分配',
                deadline: assignment.end_time,
                status: assignment.is_published ? 'active' : 'inactive',
                submissions: [],
                submissionCount: assignment.submission_count || 0,
                createdAt: assignment.created_at,
                updatedAt: assignment.updated_at
              };

              console.log('🔄 转换作业数据:', transformed);
              return transformed;
            });

            console.log('✅ 转换后的作业数据:', assignments);

            // 缓存到localStorage以提高性能
            localStorage.setItem('oj-assignments', JSON.stringify(assignments));
            return assignments;
          } else {
            console.warn('❌ 作业API返回失败:', result.message);
            return [];
          }
        } catch (error) {
          console.error('❌ 从数据库获取作业失败:', error);
          // 如果API失败，尝试返回缓存数据
          try {
            return JSON.parse(localStorage.getItem('oj-assignments') || '[]');
          } catch (cacheError) {
            console.error('获取缓存作业也失败:', cacheError);
            return [];
          }
        }
      }

      /**
       * 获取本地代码库案例列表
       */
      getAllCodeRepositoryItems() {
        try {
          const raw = localStorage.getItem('oj-code-repository');
          if (!raw) return [];
          const list = JSON.parse(raw);
          return Array.isArray(list) ? list : [];
        } catch (error) {
          console.error('获取代码库失败:', error);
          return [];
        }
      }

      /**
       * 获取内置代码案例列表
       */
      async getBuiltInExamples() {
        try {
          // 尝试读取本地examples.json文件
          const response = await fetch('code-examples/examples.json');
          if (!response.ok) {
            throw new Error('无法加载内置案例');
          }
          const data = await response.json();
          return data.examples || [];
        } catch (error) {
          console.error('获取内置案例失败:', error);
          return [];
        }
      }

      /**
       * 加载仪表盘
       */
      async loadDashboard() {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;

        // 异步获取统计数据和课程作业数据
        const [courseStats, assignmentStats, recentCoursesHtml, recentAssignmentsHtml] = await Promise.all([
          this.getCourseStats(),
          this.getAssignmentStats(),
          this.getRecentCourses(),
          this.getRecentAssignments()
        ]);

        // 根据用户角色生成统计卡片
        let statsCards = '';
        if (currentUser.role === 'admin') {
          statsCards = `
            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="totalCoursesLabel">总课程</span>
              </div>
              <div class="text-xl font-bold text-blue-400 mb-1">${courseStats.totalCourses}</div>
              <div class="text-xs text-gray-300"><span data-i18n="activeCourses">活跃</span>：${courseStats.activeCourses}</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="assignments">总作业</span>
              </div>
              <div class="text-xl font-bold text-green-400 mb-1">${assignmentStats.totalAssignments}</div>
              <div class="text-xs text-gray-300"><span data-i18n="activeCount">活跃</span>：${assignmentStats.pendingSubmissions}</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="students">总学生</span>
              </div>
              <div class="text-xl font-bold text-purple-400 mb-1">${courseStats.totalStudents || 0}</div>
              <div class="text-xs text-gray-300" data-i18n="registeredUsers">注册用户</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-orange-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="systemStatus">系统</span>
              </div>
              <div class="text-xl font-bold text-orange-400 mb-1" data-i18n="normal">正常</div>
              <div class="text-xs text-gray-300" data-i18n="allServicesRunning">运行中</div>
            </div>`;
        } else if (currentUser.role === 'teacher') {
          statsCards = `
            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="courses">我的课程</span>
              </div>
              <div class="text-xl font-bold text-blue-400 mb-1">${courseStats.totalCourses}</div>
              <div class="text-xs text-gray-300"><span data-i18n="activeCourses">活跃</span>：${courseStats.activeCourses}</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="assignments">作业</span>
              </div>
              <div class="text-xl font-bold text-green-400 mb-1">${assignmentStats.totalAssignments}</div>
              <div class="text-xs text-gray-300"><span data-i18n="pendingGrade">待批改</span>：${assignmentStats.pendingSubmissions}</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="students">学生</span>
              </div>
              <div class="text-xl font-bold text-purple-400 mb-1">${courseStats.totalStudents || 0}</div>
              <div class="text-xs text-gray-300" data-i18n="totalCount">总人数</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-indigo-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="todoTasks">待办</span>
              </div>
              <div class="text-xl font-bold text-indigo-400 mb-1">${assignmentStats.pendingSubmissions}</div>
              <div class="text-xs text-gray-300" data-i18n="gradingTasks">批改任务</div>
            </div>`;
        } else {
          // student
          statsCards = `
            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="courses">我的课程</span>
              </div>
              <div class="text-xl font-bold text-blue-400 mb-1">${courseStats.totalCourses}</div>
              <div class="text-xs text-gray-300" data-i18n="studying">学习中</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="assignments">作业</span>
              </div>
              <div class="text-xl font-bold text-green-400 mb-1">${assignmentStats.totalAssignments}</div>
              <div class="text-xs text-gray-300"><span data-i18n="pendingAssignments">待完成</span>：${assignmentStats.pendingSubmissions}</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="completed">已完成</span>
              </div>
              <div class="text-xl font-bold text-yellow-400 mb-1">${assignmentStats.totalAssignments - assignmentStats.pendingSubmissions}</div>
              <div class="text-xs text-gray-300" data-i18n="assignments">作业数量</div>
            </div>

            <div class="glass-effect rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-400" data-i18n="myProgress">进度</span>
              </div>
              <div class="text-xl font-bold text-purple-400 mb-1">${assignmentStats.totalAssignments > 0 ? Math.round((assignmentStats.totalAssignments - assignmentStats.pendingSubmissions) / assignmentStats.totalAssignments * 100) : 0}%</div>
              <div class="text-xs text-gray-300" data-i18n="completionRate">完成率</div>
            </div>`;
        }

        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6"><span data-i18n="welcomeBack">欢迎回来</span>，${currentUser.fullName}</h2>

            <!-- 统计卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              ${statsCards}
            </div>

            <!-- 快速操作 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- 最近课程 -->
              <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                  <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                  <span data-i18n="recentCourses">最近课程</span>
                </h3>
                <div class="space-y-3">
                  ${recentCoursesHtml}
                </div>
              </div>

              <!-- 最近作业 -->
              <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                  <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <span data-i18n="recentAssignments">最近作业</span>
                </h3>
                <div class="space-y-3">
                  ${recentAssignmentsHtml}
                </div>
              </div>
            </div>

                      </div>
        `;
      }

      /**
       * 加载代码库页面（本地案例库）
       */
      loadCodeRepositoryPage() {
        const pageContent = document.getElementById('page-content');
        const localItems = this.getAllCodeRepositoryItems();

        // 异步加载内置案例
        this.getBuiltInExamples().then(builtInItems => {
          this.renderCodeRepositoryPage(pageContent, localItems, builtInItems);
        }).catch(error => {
          console.error('加载内置案例失败:', error);
          this.renderCodeRepositoryPage(pageContent, localItems, []);
        });
      }

      renderCodeRepositoryPage(pageContent, localItems, builtInItems) {
        // 保存内置案例并合并本地案例和内置案例
        this.builtInExamples = builtInItems;
        const allItems = [
          ...localItems.map(item => ({...item, source: 'local'})),
          ...builtInItems.map(item => ({...item, source: 'builtin'}))
        ];

        // 初始化过滤后的案例列表
        this.filteredExamples = allItems;

        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white" data-i18n="codeRepository">代码库</h2>
              <p class="text-sm text-gray-400" data-i18n="codeRepositorySubtitle">精选代码案例和本地保存的示例</p>
            </div>

            <div class="glass-effect rounded-lg p-6">
              <div class="mb-4">
                <div class="flex items-center space-x-4 mb-4">
                  <button class="px-4 py-2 text-sm rounded-lg ${this.currentFilter === 'all' ? 'bg-blue-600' : 'bg-gray-700'} text-white" onclick="window.app.filterExamples('all')">
                    <span data-i18n="allCases">全部案例</span> (${allItems.length})
                  </button>
                  <button class="px-4 py-2 text-sm rounded-lg ${this.currentFilter === 'local' ? 'bg-blue-600' : 'bg-gray-700'} text-white" onclick="window.app.filterExamples('local')">
                    <span data-i18n="localCases">本地案例</span> (${localItems.length})
                  </button>
                  <button class="px-4 py-2 text-sm rounded-lg ${this.currentFilter === 'builtin' ? 'bg-blue-600' : 'bg-gray-700'} text-white" onclick="window.app.filterExamples('builtin')">
                    <span data-i18n="featuredCases">精选案例</span> (${builtInItems.length})
                  </button>
                </div>
              </div>

              <div class="space-y-4">
                ${this.filteredExamples.length > 0 ? this.filteredExamples.map(item => `
                  <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4 hover:bg-opacity-70 transition-all duration-200 ${item.source === 'builtin' ? 'border-l-4 border-green-500' : ''}">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                          <h3 class="text-lg font-semibold text-white">${item.title}</h3>
                          ${item.source === 'builtin' ? `<span class="px-2 py-1 text-xs bg-green-600 text-gray-100 rounded-sm" data-i18n="featured">精选</span>` : `<span class="px-2 py-1 text-xs bg-gray-600 text-gray-300 rounded-sm" data-i18n="local">本地</span>`}
                        </div>
                        <p class="text-sm text-gray-300 leading-relaxed">${item.description || '<span data-i18n="noDescription">（无说明）</span>'}</p>
                        <div class="flex flex-wrap items-center gap-2 mt-3 text-xs">
                          ${item.category ? `<span class="px-2 py-1 bg-gray-600 text-gray-300 rounded-sm">${item.category}</span>` : ''}
                          ${item.difficulty ? `<span class="px-2 py-1 bg-gray-500 text-gray-200 rounded-sm">${item.difficulty}</span>` : ''}
                          ${item.tags && item.tags.length ? item.tags.slice(0, 3).map(tag => `<span class="px-2 py-1 bg-gray-600 text-gray-400 rounded-sm">${tag}</span>`).join(' ') : ''}
                          ${item.tags && item.tags.length > 3 ? `<span class="text-gray-500">+${item.tags.length - 3}</span>` : ''}
                          ${item.source === 'local' ? `<span class="text-gray-500"><span data-i18n="author">作者</span>：${item.author || '<span data-i18n="localUser">本地用户</span>'}</span>` : ''}
                          ${item.source === 'local' && item.createdAt ? `<span class="text-gray-500">${new Date(item.createdAt).toLocaleDateString()}</span>` : ''}
                        </div>
                      </div>
                      <div class="flex flex-col space-y-2 ml-4">
                        ${item.source === 'builtin' ? `
                          <button
                            class="px-3 py-1.5 text-xs rounded bg-gray-600 hover:bg-gray-500 text-white transition-colors"
                            onclick="window.app.previewExample('${item.id}')"
                          >
                            <span data-i18n="preview">预览</span>
                          </button>
                          <button
                            class="px-3 py-1.5 text-xs rounded bg-green-600 hover:bg-green-500 text-white transition-colors"
                            onclick="window.app.openExampleInEditor('${item.id}')"
                          >
                            <span data-i18n="openInEditor">在编辑器中打开</span>
                          </button>
                        ` : `
                          <button
                            class="px-3 py-1.5 text-xs rounded bg-green-600 hover:bg-green-500 text-white transition-colors"
                            onclick="window.app.openRepoInEditor('${item.id}')"
                          >
                            <span data-i18n="openInEditor">在编辑器中打开</span>
                          </button>
                          <button
                            class="px-3 py-1.5 text-xs rounded bg-gray-600 hover:bg-gray-500 text-white transition-colors"
                            onclick="window.app.createAssignmentFromRepo('${item.id}')"
                          >
                            <span data-i18n="createAssignment">基于此创建作业</span>
                          </button>
                        `}
                      </div>
                    </div>
                  </div>
                `).join('') : `<p class="text-gray-400 text-center py-8" data-i18n="noMatchingCases">没有找到符合条件的案例。</p>`}
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 过滤案例
       */
      filterExamples(filter) {
        this.currentFilter = filter;
        const localItems = this.getAllCodeRepositoryItems();
        const allItems = [
          ...localItems.map(item => ({...item, source: 'local'})),
          ...this.builtInExamples.map(item => ({...item, source: 'builtin'}))
        ];

        switch (filter) {
          case 'local':
            this.filteredExamples = allItems.filter(item => item.source === 'local');
            break;
          case 'builtin':
            this.filteredExamples = allItems.filter(item => item.source === 'builtin');
            break;
          case 'all':
          default:
            this.filteredExamples = allItems;
            break;
        }

        // 重新渲染页面
        this.renderCodeRepositoryPage(document.getElementById('page-content'), localItems, this.builtInExamples);
      }

      /**
       * 预览内置案例
       */
      previewExample(exampleId) {
        const example = this.builtInExamples.find(item => item.id === exampleId);
        if (!example) {
          alert('未找到该案例');
          return;
        }

        // 添加code-examples前缀到预览路径
        const previewPath = 'code-examples/' + example.preview;
        console.log('预览案例:', previewPath);

        // 在新窗口中打开预览
        const previewWindow = window.open(previewPath, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        if (!previewWindow) {
          alert('请允许弹窗以预览案例');
        }
      }

      /**
       * 在编辑器中打开内置案例
       */
      async openExampleInEditor(exampleId) {
        try {
          const example = this.builtInExamples.find(item => item.id === exampleId);
          if (!example) {
            alert('未找到该案例');
            return;
          }

          // 读取案例文件内容，添加code-examples前缀
          const fileContents = [];
          for (const [fileName, filePath] of Object.entries(example.files)) {
            const fullPath = 'code-examples/' + filePath;
            console.log('正在读取文件:', fullPath);

            const response = await fetch(fullPath);
            if (!response.ok) {
              throw new Error(`无法读取文件: ${fileName} (${fullPath})`);
            }
            const content = await response.text();
            fileContents.push({ name: fileName, content });
          }

          // 创建一个临时的代码库项目对象，使用编辑器期望的格式
          const repoData = {
            id: example.id,
            title: example.title,
            description: example.description,
            files: fileContents, // 数组格式，每个元素有 name 和 content 属性
            source: 'builtin'
          };

          // 保存到localStorage供编辑器使用
          localStorage.setItem('oj-current-repo-open', JSON.stringify(repoData));

          // 设置返回页面信息并直接在当前窗口打开编辑器
          localStorage.setItem('editor-return-page', 'code-repository');
          window.location.href = 'editor.html';

        } catch (error) {
          console.error('打开案例失败:', error);
          alert('打开案例失败: ' + error.message);
        }
      }

      /**
       * 获取最近课程HTML
       */
      async getRecentCourses() {
        const currentUser = this.currentUser;
        let courses = await this.getAllCourses();

        // 根据用户角色过滤课程
        if (currentUser.role === 'student') {
          // 学生只看到已报名的课程 - 修复数据类型匹配问题
          console.log('🎓 [getRecentCourses] 学生用户过滤课程:', {
            currentUserId: currentUser.id,
            currentUserIdType: typeof currentUser.id,
            allCoursesCount: courses.length
          });

          courses = courses.filter(course => {
            const enrolledStudentIds = course.enrolledStudents || [];
            console.log('🔍 [getRecentCourses] 课程报名检查:', {
              courseId: course.id,
              courseTitle: course.title,
              enrolledStudentIds,
              enrolledStudentTypes: enrolledStudentIds.map(id => typeof id),
              willInclude: enrolledStudentIds.includes(String(currentUser.id)) || enrolledStudentIds.includes(currentUser.id)
            });

            // 支持字符串和数字两种格式，确保兼容性
            return enrolledStudentIds.includes(String(currentUser.id)) || enrolledStudentIds.includes(currentUser.id);
          });

          console.log('🔍 [getRecentCourses] 学生过滤后课程数:', courses.length);
        } else if (currentUser.role === 'teacher') {
          // 教师只看到自己管理的课程 - 修复字段映射
          console.log('🔍 [getRecentCourses] 教师用户过滤课程:', {
            currentUserId: currentUser.id,
            currentUserFullName: currentUser.fullName,
            currentUserUsername: currentUser.username,
            allCoursesCount: courses.length
          });

          courses = courses.filter(course => {
            const teacherIdMatch = String(course.teacherId) === String(currentUser.id);
            const teacherNameMatch = course.teacherFullName === currentUser.fullName || course.teacherName === currentUser.username;

            console.log('🔍 [getRecentCourses] 课程过滤检查:', {
              courseId: course.id,
              courseTitle: course.title || course.name,
              courseTeacherId: course.teacherId,
              courseTeacherName: course.teacherName,
              courseTeacherFullName: course.teacherFullName,
              teacherIdMatch,
              teacherNameMatch,
              willInclude: teacherIdMatch || teacherNameMatch
            });

            return teacherIdMatch || teacherNameMatch;
          });

          console.log('🔍 [getRecentCourses] 教师过滤后课程数:', courses.length);
        }
        // 管理员看到所有课程

        const displayCourses = courses.slice(0, 3);
        if (displayCourses.length === 0) {
          const emptyMessage = currentUser.role === 'student' ? '<span data-i18n="noEnrolledCourses">暂无报名课程</span>' :
                               currentUser.role === 'teacher' ? '<span data-i18n="noManagedCourses">暂无管理课程</span>' : '<span data-i18n="noCourses">暂无课程</span>';
          return `<p class="text-gray-400 text-sm">${emptyMessage}</p>`;
        }

        return displayCourses.map(course => {
          let courseInfo = course.title || course.name || '未命名课程';
          if (currentUser.role === 'admin') {
            courseInfo += ` • ${course.enrolled_count || course.enrolledStudents?.length || 0}<span data-i18n="studentsCount">名学生</span>`;
          } else if (currentUser.role === 'teacher') {
            courseInfo += ` • ${course.enrolled_count || course.enrolledStudents?.length || 0}<span data-i18n="studentsCount">名学生</span>`;
          }

          return `
            <div class="flex items-center justify-between p-3 bg-gray-700 bg-opacity-30 rounded-lg">
              <div>
                <div class="font-medium text-white">${course.title || course.name || '未命名课程'}</div>
                <div class="text-xs text-gray-400">${courseInfo}</div>
              </div>
              <span class="px-2 py-1 text-xs rounded-full ${course.status === '已发布' ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}" data-i18n="${course.status === '已发布' ? 'inProgress' : 'ended'}">
                ${course.status === '已发布' ? '进行中' : '已结束'}
              </span>
            </div>
          `;
        }).join('');
      }

      /**
       * 获取最近作业HTML
       */
      async getRecentAssignments() {
        const currentUser = this.currentUser;
        let assignments = await this.getAllAssignments();
        const courses = await this.getAllCourses();

        // 调试信息
        console.log('🔍 仪表盘作业调试:', {
          currentUser: {
            id: currentUser.id,
            username: currentUser.username,
            role: currentUser.role,
            fullName: currentUser.fullName
          },
          totalAssignments: assignments.length,
          totalCourses: courses.length
        });

        // 根据用户角色过滤作业
        if (currentUser.role === 'student') {
          // 学生只看到已报名课程的作业 - 修复数据类型匹配问题
          const studentCourseIds = courses
            .filter(course => {
              const enrolledStudentIds = course.enrolledStudents || [];
              return enrolledStudentIds.includes(String(currentUser.id)) || enrolledStudentIds.includes(currentUser.id);
            })
            .map(course => course.id);

          console.log('🎓 学生课程匹配:', {
            studentId: currentUser.id,
            studentCourseIds,
            coursesWithStudents: courses.filter(c => c.enrolledStudents && c.enrolledStudents.length > 0).map(c => ({
              id: c.id,
              title: c.title,
              enrolledStudents: c.enrolledStudents
            }))
          });

          assignments = assignments.filter(assignment =>
            studentCourseIds.includes(assignment.courseId) && assignment.status === 'active'
          );

          console.log('📚 学生过滤后作业:', {
            beforeFilter: assignments.length + (assignments.length - assignments.length),
            afterFilter: assignments.length,
            activeOnly: true
          });
        } else if (currentUser.role === 'teacher') {
          // 教师只看到自己课程的作业 - 使用与作业管理页面相同的过滤逻辑
          const teacherCourses = courses.filter(course => {
            const teacherIdMatch = String(course.teacherId) === String(currentUser.id);
            const teacherNameMatch = course.teacherFullName === currentUser.fullName || course.teacherName === currentUser.username;
            return teacherIdMatch || teacherNameMatch;
          });

          console.log('👨‍🏫 教师课程匹配:', {
            teacherId: currentUser.id,
            teacherName: currentUser.fullName,
            teacherUsername: currentUser.username,
            teacherCourses: teacherCourses.map(c => ({
              id: c.id,
              title: c.title,
              teacherId: c.teacherId,
              teacherName: c.teacherName,
              teacherFullName: c.teacherFullName
            }))
          });

          assignments = assignments.filter(assignment => {
            return teacherCourses.some(course => course.id === assignment.courseId);
          });

          console.log('📝 教师过滤后作业:', {
            beforeFilter: assignments.length + (assignments.length - assignments.length),
            afterFilter: assignments.length
          });
        }
        // 管理员看到所有作业

        const displayAssignments = assignments.slice(0, 3);
        if (displayAssignments.length === 0) {
          return `<p class="text-gray-400 text-sm">${this.getTranslationText('noAssignments')}</p>`;
        }

        // 预先获取翻译文本
        const dashboardTranslations = {
          inProgress: this.getTranslationText('inProgress'),
          ended: this.getTranslationText('ended')
        };

        return displayAssignments.map(assignment => {
          const course = courses.find(c => c.id === assignment.courseId);
          return `
            <div class="flex items-center justify-between p-3 bg-gray-700 bg-opacity-30 rounded-lg">
              <div>
                <div class="font-medium text-white">${assignment.title || '未命名作业'}</div>
                <div class="text-xs text-gray-400">${course?.title || assignment.courseName || '未分配'} • <span data-i18n="deadline">截止</span>：${(assignment.deadline && assignment.deadline !== 'Invalid Date') ? new Date(assignment.deadline).toLocaleDateString() : '未设置'}</div>
              </div>
              <span class="px-2 py-1 text-xs rounded-full ${assignment.status === 'active' ? 'bg-blue-500 bg-opacity-20 text-blue-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}">
                <span data-i18n="${assignment.status === 'active' ? 'inProgress' : 'ended'}">${assignment.status === 'active' ? dashboardTranslations.inProgress : dashboardTranslations.ended}</span>
              </span>
            </div>
          `;
        }).join('');
      }

      /**
       * 获取快速操作HTML
       */
      getQuickActions() {
        const user = this.currentUser;
        const actions = [];

    
        // 教师权限操作
        if (user.role === 'teacher') {
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>',
            label: 'assignmentManagement',
            action: 'assignments'
          });
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>',
            label: 'createNewAssignment',
            action: 'assignments'
          });
        }

        // 管理员权限操作
        if (user.role === 'admin') {
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>',
            label: 'courseManagement',
            action: 'courses'
          });
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>',
            label: 'teacherManagement',
            action: 'teachers'
          });
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z"></path>',
            label: 'studentManagement',
            action: 'students'
          });
        }

        // 学生权限操作
        if (user.role === 'student') {
          actions.push({
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>',
            label: 'viewAssignments',
            action: 'assignments'
          });
        }

        return actions.map(action => `
          <button onclick="window.app.navigateToPage('${action.action}')" class="p-4 bg-gray-700 bg-opacity-30 hover:bg-opacity-50 rounded-lg transition-all text-center group">
            <svg class="w-6 h-6 mx-auto mb-2 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${action.icon}
            </svg>
            <span class="text-sm text-gray-300 group-hover:text-white transition-colors" data-i18n="${action.label}">${this.getTranslationText(action.label)}</span>
          </button>
        `).join('');
      }

      /**
       * 加载课程管理页面
       */
      async loadCoursesPage() {
        const pageContent = document.getElementById('page-content');
        let courses = await this.getAllCourses();
        const teachers = this.getAllTeachers();
        const currentUser = this.currentUser;

        // 根据用户角色过滤课程
        if (currentUser.role === 'teacher') {
          console.log('🔍 [loadCoursesPage] 教师用户过滤课程:', {
            currentUserId: currentUser.id,
            currentUserFullName: currentUser.fullName,
            currentUserUsername: currentUser.username,
            allCoursesCount: courses.length
          });

          courses = courses.filter(course => {
            const teacherIdMatch = String(course.teacherId) === String(currentUser.id);
            const teacherNameMatch = course.teacherFullName === currentUser.fullName || course.teacherName === currentUser.username;

            console.log('🔍 [loadCoursesPage] 课程过滤检查:', {
              courseId: course.id,
              courseTitle: course.title || course.name,
              courseTeacherId: course.teacherId,
              courseTeacherName: course.teacherName,
              courseTeacherFullName: course.teacherFullName,
              teacherIdMatch,
              teacherNameMatch,
              willInclude: teacherIdMatch || teacherNameMatch
            });

            return teacherIdMatch || teacherNameMatch;
          });

          console.log('🔍 [loadCoursesPage] 教师过滤后课程数:', courses.length);
        } else if (currentUser.role === 'student') {
          // 学生只看到已报名的课程
          courses = courses.filter(course =>
            course.enrolledStudents?.includes(currentUser.id) ||
            (course.enrolledStudents && course.enrolledStudents.includes(String(currentUser.id)))
          );
        }
        // 管理员看到所有课程

        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white" data-i18n="courseManagement">课程管理</h2>
              <button onclick="window.app.showAddCourseModal()" class="btn-primary px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span data-i18n="createCourse">创建课程</span>
              </button>
            </div>

            <div class="glass-effect rounded-lg p-6">
              <div class="space-y-4">
                ${courses.length > 0 ? courses.map(course => `
                  <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                      <div>
                        <h3 class="text-lg font-semibold text-white">${course.title || course.name || '未命名课程'}</h3>
                        <p class="text-sm text-gray-400">ID: ${course.id} • ${course.description || ''}</p>
                        <div class="flex items-center space-x-4 mt-2 text-sm">
                          <span class="text-gray-400"><span data-i18n="teacher">教师</span>：${course.teacher_full_name || course.teacherName || '未分配'}</span>
                          <span class="text-gray-400"><span data-i18n="students">学生</span>：${course.enrolled_count || course.enrolledStudents?.length || 0}/${course.maxStudents || course.capacity || 0}</span>
                          <span class="px-2 py-1 text-xs rounded-full ${course.status === '已发布' ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}" data-i18n="${course.status === '已发布' ? 'inProgress' : 'ended'}">
                            ${course.status === '已发布' ? '进行中' : '已结束'}
                          </span>
                        </div>
                      </div>
                      <div class="flex space-x-2">
                        <button onclick="window.app.showImportStudentsModal('${course.id}')" class="p-2 text-green-400 hover:bg-green-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${i18n.t('importStudentList')}">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v4m0 0v4m0-4h4m-4 0H8m-2 8h12"></path>
                          </svg>
                        </button>
                        <button onclick="window.app.handleAssignStudentsToCourse('${course.id}')" class="p-2 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${i18n.t('assignStudents')}">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z"></path>
                          </svg>
                        </button>
                        <button onclick="window.app.deleteCourse('${course.id}')" class="p-2 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${i18n.t('delete')}">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('') : `<p class="text-gray-400 text-center py-8" data-i18n="noCourses">暂无课程</p>`}
              </div>
            </div>
          </div>
        `;

        // 在页面渲染后调用动态内容翻译
        setTimeout(() => {
          const pageContent = document.getElementById('page-content');
          i18n.applyToDynamicContent(pageContent);
        }, 50);
      }

      /**
       * 显示导入学生名单模态框
       */
      showImportStudentsModal(courseId) {
        const modalHtml = `
          <div id="import-students-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-md shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-3 text-center">导入学生名单</h3>
              <p class="text-sm text-gray-400 mb-3">
                每行一个学生，格式：<span class="text-gray-200">学号,姓名,邮箱,专业,年级</span>（邮箱、专业、年级可选）
              </p>
              <form id="import-students-form" class="space-y-3">
                <textarea name="studentsText" rows="8" required
                  class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                  focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all resize-none"
                  placeholder="例如：\n2021003,王五,wangwu@example.com,计算机科学与技术,2021级\n2021004,赵六,zhaoliu@example.com,软件工程,2021级"></textarea>
                <div class="flex justify-end space-x-3 mt-3 pt-3 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    取消
                  </button>
                  <button type="submit"
                    class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    导入
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('import-students-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleImportStudents(courseId, e);
        });
      }

      /**
       * 处理导入学生名单
       */
      async handleImportStudents(courseId, event) {
        const formData = new FormData(event.target);
        const raw = (formData.get('studentsText') || '').toString().trim();

        if (!raw) {
          alert('请粘贴学生名单文本');
          return;
        }

        const lines = raw.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
        if (lines.length === 0) {
          alert('学生名单为空');
          return;
        }

        const students = this.getAllStudentsSync();
        const courses = await this.getAllCourses();
        const course = courses.find(c => c.id === courseId);

        if (!course) {
          alert('未找到对应课程');
          return;
        }

        const enrolledSet = new Set(course.enrolledStudents || []);
        let createdCount = 0;

        lines.forEach(line => {
          const parts = line.split(',').map(p => p.trim()).filter(Boolean);
          if (parts.length < 2) return;

          // 跳过表头
          if (/学号|姓名|student/i.test(parts[0])) {
            return;
          }

          const [studentIdRaw, fullNameRaw, emailRaw, majorRaw, gradeRaw] = parts;
          const studentId = studentIdRaw;
          const fullName = fullNameRaw;
          const email = emailRaw || `${studentId}@example.com`;
          const major = majorRaw || '未设置';
          const grade = gradeRaw || '';

          if (!studentId || !fullName) {
            return;
          }

          let existing = students.find(s => s.studentId === studentId || s.email === email);
          if (!existing) {
            const id = `student_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            existing = {
              id,
              username: studentId,
              email,
              fullName,
              role: 'student',
              studentId,
              grade,
              major,
              isActive: true,
              createdAt: new Date().toISOString()
            };
            students.push(existing);
            createdCount += 1;
          }

          enrolledSet.add(existing.id);
        });

        course.enrolledStudents = Array.from(enrolledSet);

        try {
          localStorage.setItem('oj-students', JSON.stringify(students));
          localStorage.setItem('oj-courses', JSON.stringify(courses));

          this.closeModal();
          this.loadCoursesPage();
          alert(`导入完成，新建学生 ${createdCount} 名`);
        } catch (error) {
          console.error('导入学生失败:', error);
          alert('导入失败：' + error.message);
        }
      }

      /**
       * 显示添加课程模态框
       */
      async showAddCourseModal() {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        try {
          const teachers = await this.getAllTeachers();
          const teacherOptions = teachers.map(teacher =>
            `<option value="${teacher.id}">${teacher.fullName} - ${teacher.department}</option>`
          ).join('');

        const modalHtml = `
          <div id="course-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center" data-i18n="createCourseFormTitle">${t('createCourseFormTitle')}</h3>
              <form id="add-course-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="courseName">${t('courseName')}</label>
                  <input type="text" name="title" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterCourseName')}" data-i18n-placeholder="enterCourseName">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="courseCode">${t('courseCode')}</label>
                  <input type="text" name="code" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterCourseCode')}" data-i18n-placeholder="enterCourseCode">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="courseDescription">${t('courseDescription')}</label>
                  <textarea name="description" rows="3" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all resize-none"
                    placeholder="${t('enterCourseDescription')}" data-i18n-placeholder="enterCourseDescription"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="courseTeacher">${t('courseTeacher')}</label>
                  <select name="teacherId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                    <option value="">${t('selectTeacher')}</option>
                    ${teacherOptions}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="maxStudentsCount">${t('maxStudentsCount')}</label>
                  <input type="number" name="maxStudents" min="1" value="50" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    <span data-i18n="cancel">${t('cancel')}</span>
                  </button>
                  <button type="submit"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    <span data-i18n="createCourseBtn">${t('createCourseBtn')}</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 多次尝试确保模态框中的语言被正确应用
        const applyLanguageInModal = () => {
          const modal = document.getElementById('course-modal');
          if (modal && window.i18n) {
            // 应用到整个模态框
            window.i18n.applyToDynamicContent(modal);

            // 额外处理所有placeholder属性
            const inputs = modal.querySelectorAll('input[data-i18n-placeholder], textarea[data-i18n-placeholder]');
            inputs.forEach(input => {
              const key = input.getAttribute('data-i18n-placeholder');
              if (key) {
                input.placeholder = window.i18n.t(key);
              }
            });

            // 处理所有文本内容
            const textElements = modal.querySelectorAll('[data-i18n]');
            textElements.forEach(element => {
              const key = element.getAttribute('data-i18n');
              if (key && element.textContent !== window.i18n.t(key)) {
                element.textContent = window.i18n.t(key);
              }
            });
          }
        };

        // 立即应用一次
        applyLanguageInModal();

        // 短延迟后再次应用
        setTimeout(applyLanguageInModal, 10);

        // 更长延迟后再次应用，确保DOM完全渲染
        setTimeout(applyLanguageInModal, 100);

        document.getElementById('add-course-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.handleAddCourse(e);
        });
        } catch (error) {
          console.error('获取教师列表失败:', error);
          // 如果获取教师失败，仍然显示模态框但没有教师选项
          const modalHtml = `
            <div id="course-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
              <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 text-center" data-i18n="createCourseFormTitle">${t('createCourseFormTitle')}</h3>
                <p class="text-red-400 text-center mb-4" data-i18n="loadTeachersError">${t('loadTeachersError')}</p>
                <div class="flex justify-center">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    <span data-i18n="close">${t('close')}</span>
                  </button>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', modalHtml);

          // 即使是错误情况也要应用语言设置
          setTimeout(() => {
            if (window.i18n) {
              window.i18n.applyToDynamicContent(document.getElementById('course-modal'));
            }
          }, 10);
        }
      }

      /**
       * 处理添加课程
       */
      async handleAddCourse(event) {
        const formData = new FormData(event.target);
        const teacherId = formData.get('teacherId');
        const teachers = await this.getAllTeachers();

        // 确保找到教师，处理类型转换问题
        const selectedTeacher = teachers.find(t => String(t.id) === String(teacherId));

        console.log('🔍 调试信息:');
        console.log('teacherId:', teacherId);
        console.log('teachers:', teachers);
        console.log('selectedTeacher:', selectedTeacher);

        const courseData = {
          title: formData.get('title'),
          code: formData.get('code'),
          description: formData.get('description'),
          teacherId: teacherId,
          teacherName: selectedTeacher ? selectedTeacher.fullName : (teacherId ? '未知教师' : '未分配'),
          teacherUsername: selectedTeacher ? selectedTeacher.username : null,
          maxStudents: parseInt(formData.get('maxStudents'))
        };

        console.log('📦 courseData:', courseData);

        const result = await this.addCourse(courseData);
        if (result.success) {
          this.closeModal();
          this.loadCoursesPage();
          alert('课程创建成功！');
        } else {
          alert('创建失败：' + result.error);
        }
      }

      /**
       * 删除课程
       */
      async deleteCourse(courseId) {
        if (confirm('确定要删除这门课程吗？删除后无法恢复！')) {
          try {
            // 调用后端API删除课程
            const response = await fetch(`http://localhost:5025/api/courses/${courseId}`, {
              method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
              // 清除本地缓存，强制从数据库重新加载
              localStorage.removeItem('oj-courses');

              this.showNotification('课程删除成功！', 'success');
              this.loadCoursesPage();
            } else {
              throw new Error(result.message || '删除课程失败');
            }
          } catch (error) {
            console.error('删除课程失败:', error);
            this.showNotification('删除失败：' + error.message, 'error');
          }
        }
      }

      /**
       * 显示通知消息
       */
      showNotification(message, type = 'info') {
        // 移除现有的通知
        const existingNotifications = document.querySelectorAll('.notification-toast');
        existingNotifications.forEach(notif => notif.remove());

        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `notification-toast fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;

        // 根据类型设置样式
        switch (type) {
          case 'success':
            notification.className += ' bg-green-600 text-white';
            break;
          case 'error':
            notification.className += ' bg-red-600 text-white';
            break;
          case 'warning':
            notification.className += ' bg-yellow-600 text-white';
            break;
          default:
            notification.className += ' bg-blue-600 text-white';
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        // 显示动画
        setTimeout(() => {
          notification.classList.remove('translate-x-full');
          notification.classList.add('translate-x-0');
        }, 10);

        // 3秒后自动移除
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }

      /**
       * 处理分配学生到课程（包装方法）
       */
      async handleAssignStudentsToCourse(courseId) {
        await this.assignStudentsToCourse(courseId);
      }

      /**
       * 分配学生到课程
       */
      async assignStudentsToCourse(courseId) {
        const course = await this.getCourseById(courseId);
        if (!course) return;

        // 先预加载并缓存学生数据
        await this.getAllStudents();
        const students = this.getAllStudentsSync();
        const enrolledStudentIds = Array.isArray(course.enrolledStudents) ? course.enrolledStudents : [];

        const modalHtml = `
          <div id="assign-students-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-4xl shadow-2xl border border-gray-700 flex flex-col relative" style="max-height: 90vh;">
              <!-- 固定头部 - 包含关闭和确认按钮 -->
              <div class="flex items-center justify-between mb-6 flex-shrink-0">
                <div>
                  <h3 class="text-xl font-bold text-white">分配学生到课程</h3>
                  <div class="text-sm text-gray-300 mt-1">
                    课程：<span class="text-blue-400 font-semibold">${course.title}</span>
                  </div>
                </div>
                <div class="flex items-center space-x-3">
                  <!-- 已选择数量 -->
                  <div class="text-sm text-gray-300">
                    已选择: <span id="selected-count-header" class="text-blue-400 font-semibold">${enrolledStudentIds.length}</span> 名学生
                  </div>
                  <!-- 确认和取消按钮 -->
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium text-sm">
                    取消
                  </button>
                  <button type="button" onclick="(async () => { await window.app.saveCourseStudentAssignment('${courseId}') })()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium shadow-lg text-sm">
                    确认分配
                  </button>
                </div>
              </div>

              <!-- 固定搜索和控制区 -->
              <div class="mb-4 flex items-center justify-between flex-shrink-0">
                <input type="text" id="student-search-input" placeholder="搜索学生姓名、学号或用户名..."
                  class="flex-1 px-4 py-2 bg-gray-800 border border-gray-600 rounded-l-lg text-white
                  focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                <div class="flex space-x-2 ml-4">
                  <button type="button" id="select-all-btn" onclick="window.app.toggleSelectAll(true)"
                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-r-lg transition-colors text-sm font-medium">
                    全选
                  </button>
                  <button type="button" id="clear-all-btn" onclick="window.app.toggleSelectAll(false)"
                    class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors text-sm font-medium">
                    清除
                  </button>
                </div>
              </div>

              <!-- 可滚动学生列表 -->
              <div class="overflow-y-auto bg-gray-800 rounded-lg p-4 flex-1" style="max-height: 55vh;">
                <div class="space-y-2" id="student-list">
                  ${students.map(student => `
                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors student-item"
                         data-student-name="${student.fullName}"
                         data-student-id="${student.studentId || ''}"
                         data-student-username="${student.username || ''}">
                      <div class="flex items-center space-x-3">
                        <input type="checkbox" id="student-${student.id}"
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                          ${enrolledStudentIds.includes(student.id) ? 'checked' : ''}>
                        <div>
                          <div class="text-white font-medium">${student.fullName}</div>
                          <div class="text-xs text-gray-400">
                            ${student.studentId ? `学号: ${student.studentId}` : ''}
                            ${student.username ? `• 用户名: ${student.username}` : ''}
                            ${student.grade ? `• ${student.grade}` : ''}
                          </div>
                        </div>
                      </div>
                      <div class="text-sm text-gray-400">
                        ${enrolledStudentIds.includes(student.id) ?
                          '<span class="text-green-400">已分配</span>' :
                          '<span class="text-gray-500">未分配</span>'}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- 底部统计信息 -->
              <div class="flex justify-between items-center text-sm text-gray-300 mt-4 pt-4 border-t border-gray-700 flex-shrink-0">
                <span>共 ${students.length} 名学生</span>
                <span>已选择 <span id="selected-count" class="text-blue-400 font-semibold">${enrolledStudentIds.length}</span> 名</span>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        this.setupStudentSearch();
        this.setupStudentCheckboxes();
        this.updateSelectedCount();
      }

      /**
       * 设置学生复选框事件
       */
      setupStudentCheckboxes() {
        const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            this.updateSelectedCount();
          });
        });
      }

      /**
       * 全选/取消全选
       */
      toggleSelectAll(selectAll) {
        const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll;
        });
        this.updateSelectedCount();
      }

      /**
       * 设置学生搜索功能
       */
      setupStudentSearch() {
        const searchInput = document.getElementById('student-search-input');
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const studentItems = document.querySelectorAll('.student-item');

          studentItems.forEach(item => {
            const name = item.dataset.studentName.toLowerCase();
            const id = item.dataset.studentId.toLowerCase();
            const username = item.dataset.studentUsername.toLowerCase();

            if (name.includes(searchTerm) || id.includes(searchTerm) || username.includes(searchTerm)) {
              item.style.display = 'flex';
            } else {
              item.style.display = 'none';
            }
          });
        });
      }

      /**
       * 更新选中数量
       */
      updateSelectedCount() {
        const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        // 更新所有计数器
        const topCounter = document.getElementById('selected-count');
        const headerCounter = document.getElementById('selected-count-header');

        if (topCounter) topCounter.textContent = selectedCount;
        if (headerCounter) headerCounter.textContent = selectedCount;
      }

      /**
       * 处理保存课程学生分配
       */
      async handleSaveCourseStudentAssignment(courseId) {
        await this.saveCourseStudentAssignment(courseId);
      }

      /**
       * 保存课程学生分配
       */
      async saveCourseStudentAssignment(courseId) {
        const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');
        const selectedStudentIds = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.id.replace('student-', ''));

        try {
          console.log('🎓 开始分配学生到课程:', courseId, '选中学生:', selectedStudentIds);

          // 为每个选中的学生调用注册API
          const enrollmentPromises = selectedStudentIds.map(async (studentId) => {
            try {
              console.log('📝 正在为学生注册课程:', studentId, '课程ID:', courseId);

              const response = await fetch(`http://localhost:5025/api/courses/${courseId}/enroll`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ student_id: String(studentId) })
              });

              const result = await response.json();
              console.log('📨 学生注册响应:', studentId, result);
              return result;
            } catch (error) {
              console.error('❌ 注册请求失败:', studentId, error);
              return { success: false, message: error.message };
            }
          });

          const results = await Promise.all(enrollmentPromises);
          console.log('📊 所有注册结果:', results);
          const successCount = results.filter(r => r.success).length;
          const failCount = results.length - successCount;
          console.log('✅ 成功:', successCount, '❌ 失败:', failCount);

          // 清除本地缓存，强制从数据库重新加载
          localStorage.removeItem('oj-courses');

          // 显示成功提示
          const successMessage = document.createElement('div');
          successMessage.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-pulse';
          if (failCount === 0) {
            successMessage.textContent = `✓ 成功分配 ${successCount} 名学生到课程！`;
          } else {
            successMessage.textContent = `✓ 成功分配 ${successCount} 名学生，${failCount} 名学生分配失败`;
            successMessage.className = 'fixed top-4 right-4 bg-yellow-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-pulse';
          }
          document.body.appendChild(successMessage);

          // 3秒后自动关闭提示
          setTimeout(() => {
            successMessage.remove();
          }, 3000);

          this.closeModal();

          // 刷新课程管理页面
          this.loadCoursesPage();

        } catch (error) {
          console.error('保存学生分配失败:', error);
          alert('保存失败，请重试。');
        }
      }

      /**
       * 显示编辑课程模态框
       */
      async editCourse(courseId) {
        const course = await this.getCourseById(courseId);
        if (!course) return;

        const teachers = this.getAllTeachers();
        const teacherOptions = teachers.map(teacher =>
          `<option value="${teacher.id}" ${course.teacherId === teacher.id ? 'selected' : ''}>${teacher.fullName} - ${teacher.department}</option>`
        ).join('');

        const modalHtml = `
          <div id="edit-course-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">编辑课程</h3>
              <form id="edit-course-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">课程名称</label>
                  <input type="text" name="title" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${course.title}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">课程代码</label>
                  <input type="text" name="code" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    value="${course.code}">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">课程描述</label>
                  <textarea name="description" rows="3" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all resize-none">${course.description}</textarea>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">授课教师</label>
                  <select name="teacherId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                    <option value="">选择教师</option>
                    ${teacherOptions}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">最大学生数量</label>
                  <input type="number" name="maxStudents" min="1" value="${course.maxStudents}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    取消
                  </button>
                  <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    保存修改
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 确保模态框中的 data-i18n 元素被正确翻译
        setTimeout(() => {
          if (window.i18n) {
            const modal = document.getElementById('edit-course-modal');
            if (modal) {
              window.i18n.applyToDynamicContent(modal);
            }
          }
        }, 10);

        document.getElementById('edit-course-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleEditCourse(courseId, e);
        });
      }

      /**
       * 更新课程
       */
      async updateCourse(courseId, courseData) {
        try {
          // 调用后端API更新课程
          const response = await fetch(`http://localhost:5025/api/courses/${courseId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title: courseData.title,
              description: courseData.description || '',
              teacher_id: parseInt(courseData.teacherId),
              max_students: courseData.maxStudents || 50,
              status: '已发布'
            })
          });

          const result = await response.json();

          if (result.success) {
            // 清除本地缓存，强制从数据库重新加载
            localStorage.removeItem('oj-courses');
            return { success: true, data: result.data };
          } else {
            throw new Error(result.message || '更新课程失败');
          }
        } catch (error) {
          console.error('❌ 更新课程失败:', error);
          return { success: false, error: error.message };
        }
      }

      /**
       * 处理编辑课程
       */
      async handleEditCourse(courseId, event) {
        const formData = new FormData(event.target);
        const teacherId = formData.get('teacherId');
        const teachers = this.getAllTeachers();
        const selectedTeacher = teachers.find(t => t.id === teacherId);

        const updatedCourse = {
          title: formData.get('title'),
          code: formData.get('code'),
          description: formData.get('description'),
          teacherId: teacherId,
          teacherName: selectedTeacher ? selectedTeacher.fullName : '未分配',
          maxStudents: parseInt(formData.get('maxStudents'))
        };

        const result = await this.updateCourse(courseId, updatedCourse);
        if (result.success) {
          this.closeModal();
          this.loadCoursesPage();
          this.showNotification('课程更新成功！', 'success');
        } else {
          this.showNotification('更新失败：' + result.error, 'error');
        }
      }

      /**
       * 加载作业管理页面
       */
      async loadAssignmentsPage() {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;
        const assignments = await this.getAllAssignments();
        const courses = await this.getAllCourses();

        console.log('🔍 调试作业加载:');
        console.log('- 当前用户:', currentUser);
        console.log('- 所有作业数量:', assignments.length);
        console.log('- 所有课程数量:', courses.length);
        console.log('- 所有作业详情:', assignments);
        console.log('- 所有课程详情:', courses);

        // 根据用户角色获取不同的作业列表
        let teacherAssignments = [];
        let pageHeaderKey = 'assignmentManagement';

        if (currentUser.role === 'teacher') {
          // 教师只看到自己课程的作业 - 使用前端转换后的字段
          const teacherCourses = courses.filter(course => {
            const teacherIdMatch = String(course.teacherId) === String(currentUser.id);
            const teacherNameMatch = course.teacherFullName === currentUser.fullName || course.teacherName === currentUser.username;

            console.log(`- 课程 "${course.title}" 检查:`, {
              courseId: course.id,
              courseTeacherId: course.teacherId,
              courseTeacherName: course.teacherName,
              courseTeacherFullName: course.teacherFullName,
              currentUserId: currentUser.id,
              currentUserFullName: currentUser.fullName,
              currentUserUsername: currentUser.username,
              teacherIdMatch,
              teacherNameMatch
            });

            return teacherIdMatch || teacherNameMatch;
          });

          console.log('- 教师课程数量:', teacherCourses.length);
          console.log('- 教师课程列表:', teacherCourses.map(c => ({
            id: c.id,
            title: c.title,
            teacherId: c.teacherId,
            teacherName: c.teacherName,
            teacherFullName: c.teacherFullName
          })));

          teacherAssignments = assignments.filter(assignment => {
            const matches = teacherCourses.some(course => course.id === assignment.courseId);
            console.log(`- 作业 "${assignment.title}" (课程ID: ${assignment.courseId}) 匹配教师课程:`, matches);
            return matches;
          });

          console.log('- 过滤后教师作业数量:', teacherAssignments.length);
          pageHeaderKey = 'myAssignments';
        } else {
          teacherAssignments = assignments;
        }

        console.log('🎯 teacherAssignments过滤结果:', {
          数量: teacherAssignments.length,
          详情: teacherAssignments
        });

        // 预先获取翻译文本，避免在模板字符串中this上下文问题
        const translations = {
          pageHeader: this.getTranslationText(pageHeaderKey),
          createNewAssignment: this.getTranslationText('createNewAssignment'),
          inProgress: this.getTranslationText('inProgress'),
          ended: this.getTranslationText('ended')
        };

        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white" data-i18n="${pageHeaderKey}">${translations.pageHeader}</h2>
              ${currentUser.role === 'teacher' ? `
                <button onclick="window.app.showCreateAssignmentModal()" class="btn-primary px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                  <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  <span data-i18n="createNewAssignment">${translations.createNewAssignment}</span>
                </button>
              ` : ''}
            </div>

            <div class="glass-effect rounded-lg p-6">
              <div class="space-y-4">
        ${teacherAssignments.length > 0 ? teacherAssignments.map(assignment => {
                  const course = courses.find(c => c.id === assignment.courseId);
                  const deadline = assignment.deadline && assignment.deadline !== 'Invalid Date' ? new Date(assignment.deadline) : null;
                  const now = new Date();
                  const isOverdue = deadline ? deadline < now : false;

                  console.log('📋 显示作业:', {
                    title: assignment.title,
                    courseId: assignment.courseId,
                    teacherId: assignment.teacherId,
                    course: course?.title,
                    deadline: assignment.deadline
                  });

                  return `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <h3 class="text-lg font-semibold text-white">${assignment.title || '未命名作业'}</h3>
                          <p class="text-sm text-gray-400">${course?.title || assignment.courseName || '未分配课程'} • ${assignment.description || '无描述'}</p>
                          <div class="flex items-center space-x-4 mt-2 text-sm">
                            <span class="${isOverdue ? 'text-red-400' : 'text-gray-400'}">
                              <span data-i18n="deadline">截止</span>：${deadline ? deadline.toLocaleDateString() : '未设置'}
                            </span>
                            <span class="text-gray-400"><span data-i18n="submitted">提交</span>：${assignment.submissionCount || 0}份</span>
                            <span class="text-gray-400"><span data-i18n="teacher">教师</span>：${assignment.teacherFullName || assignment.teacherName || '未分配'}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${assignment.status === 'active' ? 'bg-blue-500 bg-opacity-20 text-blue-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}">
                              <span data-i18n="${assignment.status === 'active' ? 'inProgress' : 'ended'}">${assignment.status === 'active' ? translations.inProgress : translations.ended}</span>
                            </span>
                          </div>
                        </div>
                        <div class="flex space-x-2">
                          <button onclick="window.app.viewAssignmentSubmissions('${assignment.id}')" class="p-2 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                          </button>
                          ${currentUser.role === 'teacher' ? `
                            <button onclick="window.app.editAssignment('${assignment.id}')" class="p-2 text-green-400 hover:bg-green-500 hover:bg-opacity-20 rounded-lg transition-colors">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                              </svg>
                            </button>
                            <button onclick="window.app.deleteAssignment('${assignment.id}')" class="p-2 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                              </svg>
                            </button>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('') : `<p class="text-gray-400 text-center py-8" data-i18n="noAssignments">${this.getTranslationText('noAssignments')}</p>`}
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 显示创建作业模态框
       */
      async showCreateAssignmentModal() {
        // 安全获取翻译文本的辅助函数 - 模仿课程管理模式
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        // 从数据库获取当前教师负责的课程
        const teacherCourses = await this.getTeacherCoursesFromDatabase();
        console.log('📚 教师课程数据:', teacherCourses);

        const courseOptions = teacherCourses.map(course =>
          `<option value="${course.id}">${course.title} - ${course.code || ''}</option>`
        ).join('');

        const hasTemplate = !!this.currentAssignmentTemplate;
        const templateNotice = hasTemplate
          ? `<p class="text-sm text-green-400 mb-2 text-center">${t('templateSelected')}: ${this.currentAssignmentTemplate.title}，${t('templateDescription')}</p>`
          : '';

        const modalHtml = `
          <div id="assignment-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-2 text-center" data-i18n="createNewAssignment">${t('createNewAssignment')}</h3>
              ${templateNotice}
              <form id="create-assignment-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentTitle">${t('assignmentTitle')}</label>
                  <input type="text" name="title" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterAssignmentTitle')}" data-i18n-placeholder="enterAssignmentTitle">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentDescription">${t('assignmentDescription')}</label>
                  <textarea name="description" rows="3" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all resize-none"
                    placeholder="${t('enterAssignmentDescription')}" data-i18n-placeholder="enterAssignmentDescription"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="course">${t('course')}</label>
                  <select name="courseId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                    <option value="">${t('selectCourse')}</option>
                    ${courseOptions}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentDeadline">${t('assignmentDeadline')}</label>
                  <input type="date" name="deadline" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    ${t('cancel')}
                  </button>
                  <button type="submit"
                    class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    ${t('createAssignment')}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('create-assignment-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleCreateAssignment(e);
        });
      }

      /**
       * 处理创建作业
       */
      async handleCreateAssignment(event) {
        const formData = new FormData(event.target);
        const courseId = formData.get('courseId');

        console.log('🚀 开始创建作业，课程ID:', courseId);

        try {
          // 构建作业数据，调用数据库API
          const assignmentData = {
            title: formData.get('title'),
            description: formData.get('description'),
            instructions: formData.get('description'), // 使用描述作为说明
            teacher_id: parseInt(this.currentUser.id),
            assignment_type: '编程练习',
            difficulty: '中等',
            max_attempts: 0,
            time_limit: 120,
            end_time: new Date(formData.get('deadline')).toISOString().slice(0, 19).replace('T', ' '),
            max_score: 100,
            allow_late_submission: false,
            auto_grade: true,
            is_published: true
          };

          console.log('📋 作业数据:', assignmentData);

          // 尝试读取当前选择的代码库案例作为模板
          let repoTemplate = null;
          try {
            if (this.currentAssignmentTemplate) {
              repoTemplate = this.currentAssignmentTemplate;
            } else {
              const saved = localStorage.getItem('oj-current-assignment-template');
              if (saved) {
                repoTemplate = JSON.parse(saved);
              }
            }
          } catch (error) {
            console.error('读取作业模板失败:', error);
          }

          // 如果存在模板，添加到作业数据中
          if (repoTemplate && Array.isArray(repoTemplate.files)) {
            assignmentData.template_files = JSON.stringify(repoTemplate.files.map(file => ({
              name: file.name,
              content: file.content,
              type: file.type || 'text'
            })));
          }

          // 调用数据库API创建作业
          const response = await fetch(`http://localhost:5025/api/courses/${courseId}/assignments`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(assignmentData)
          });

          console.log('📡 创建作业API响应状态:', response.status);

          const result = await response.json();
          console.log('📨 创建作业API完整响应:', result);
          console.log('📨 API响应状态检查:', {
            success: result.success,
            hasData: !!result.data,
            statusCode: response.status
          });

          if (result.success === true) {
            console.log('✅ 作业创建成功:', result.data || result.message);

            // 清除当前模板状态
            this.currentAssignmentTemplate = null;
            localStorage.removeItem('oj-current-assignment-template');

            // 清除作业缓存，确保从数据库重新加载
            localStorage.removeItem('oj-assignments');

            console.log('🔄 开始关闭模态框并刷新页面...');
            this.closeModal();

            // 延迟一点再加载页面，确保数据库写入完成
            setTimeout(() => {
              console.log('🔄 开始重新加载作业页面...');
              this.loadAssignmentsPage();
            }, 500);

            alert('作业创建成功！');
          } else {
            console.error('❌ API返回失败，详细信息:', {
              success: result.success,
              data: result.data,
              message: result.message,
              fullResponse: result
            });
            throw new Error(result.message || '创建作业失败：服务器返回异常');
          }
        } catch (error) {
          console.error('❌ 创建作业失败:', error);
          console.error('❌ 错误堆栈:', error.stack);

          // 如果是网络错误，提供更友好的提示
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            alert('网络错误：无法连接到服务器，请检查后端服务是否正常运行');
          } else {
            alert('创建失败：' + error.message);
          }
        }
      }

      /**
       * 查看作业提交情况
       */
      async viewAssignmentSubmissions(assignmentId) {
        try {
          console.log('🔍 从数据库获取作业提交详情:', assignmentId);

          // 安全获取翻译文本的辅助函数
          const t = (key, fallback = key) => {
            try {
              // 直接使用i18n实例的方法
              if (i18n && typeof i18n.t === 'function') {
                return i18n.t(key);
              }

              // 备用方案：直接从翻译对象获取
              const currentLang = i18n?.currentLanguage || localStorage.getItem('language') || 'zh';
              if (i18n?.translations?.[currentLang]?.[key]) {
                return i18n.translations[currentLang][key];
              }

              console.warn('Translation not found:', key, 'Language:', currentLang);
            } catch (error) {
              console.warn('Translation error:', key, error);
            }
            return fallback;
          };

          // 使用新的API获取作业提交详情
          const response = await fetch(`http://localhost:5025/api/assignments/${assignmentId}/submissions`);
          const result = await response.json();

          if (!result.success) {
            console.error('❌ API调用失败:', result.message);
            alert('获取作业提交详情失败：' + result.message);
            return;
          }

          const { assignment, submissions, courseStudents } = result.data;

          console.log('📋 从数据库获取的数据:', {
            assignment: assignment.title,
            submissionsCount: submissions.length,
            courseStudentsCount: courseStudents.length
          });

          // 预先获取翻译文本
          const translations = {
            submissionStatus: t('submissionStatus'),
            submissionDetails: t('submissionDetails'),
            assignmentInfo: t('assignmentInfo'),
            course: t('course'),
            assignmentDeadline: t('assignmentDeadline'),
            assignedStudents: t('assignedStudents'),
            submitted: t('submitted'),
            graded: t('graded'),
            noSubmission: t('noSubmission'),
            viewSubmission: t('viewSubmission'),
            viewCode: t('viewCode'),
            gradeSubmission: t('gradeSubmission'),
            notSet: t('notSet'),
            people: t('people'),
            copies: t('copies'),
            colon: t('colon'),
            score: t('score'),
            points: t('points'),
            scorePlaceholder: t('scorePlaceholder'),
            view: t('view'),
            update: t('update'),
            unknownMajor: t('unknownMajor'),
            noAssignedStudents: t('noAssignedStudents')
          };

          const pageContent = document.getElementById('page-content');
          pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="flex items-center space-x-4 mb-6">
                <button onclick="window.app.loadAssignmentsPage()" class="text-gray-400 hover:text-white transition-colors">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h2 class="text-2xl font-bold text-white">${assignment.title} - <span data-i18n="submissionDetails">${translations.submissionDetails}</span></h2>
              </div>

              <div class="glass-effect rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-white mb-4"><span data-i18n="assignmentInfo">${translations.assignmentInfo}</span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span class="text-gray-400"><span data-i18n="course">${translations.course}</span>${translations.colon}</span>
                    <span class="text-white">${assignment.course_title || assignment.courseName}</span>
                  </div>
                  <div>
                    <span class="text-gray-400"><span data-i18n="assignmentDeadline">${translations.assignmentDeadline}</span>${translations.colon}</span>
                    <span class="text-white">${assignment.end_time ? new Date(assignment.end_time).toLocaleString() : translations.notSet}</span>
                  </div>
                  <div>
                    <span class="text-gray-400"><span data-i18n="assignedStudents">${translations.assignedStudents}</span>${translations.colon}</span>
                    <span class="text-white">${courseStudents.length} <span data-i18n="people">${translations.people}</span></span>
                  </div>
                  <div>
                    <span class="text-gray-400"><span data-i18n="submitted">${translations.submitted}</span>${translations.colon}</span>
                    <span class="text-green-400">${submissions.length} <span data-i18n="copies">${translations.copies}</span></span>
                  </div>
                  <div>
                    <span class="text-gray-400"><span data-i18n="graded">${translations.graded}</span>${translations.colon}</span>
                    <span class="text-blue-400">${submissions.filter(s => s.score !== null && s.score !== undefined).length} <span data-i18n="copies">${translations.copies}</span></span>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4"><span data-i18n="submissionStatus">${translations.submissionStatus}</span></h3>
                <div class="space-y-4">
                  ${courseStudents.length > 0 ? courseStudents.map(student => {
                    // 匹配学生提交情况
                    const submission = submissions.find(s => s.student_id === student.id);

                    return `
                      <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                          <div class="flex-1">
                            <h4 class="font-medium text-white">${student.full_name || student.fullName || student.username}</h4>
                            <p class="text-sm text-gray-400">${student.student_id || student.studentId || student.id} • ${student.major || translations.unknownMajor}</p>
                            ${submission && submission.score !== null && submission.score !== undefined ? `<p class="text-sm text-green-400">${translations.score}: ${Math.round(submission.score)}${translations.points}</p>` : ''}
                          </div>
                          <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 text-xs rounded-full ${submission ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-yellow-500 bg-opacity-20 text-yellow-400'}">
                              <span data-i18n="${submission ? 'submitted' : 'noSubmission'}">${submission ? translations.submitted : translations.noSubmission}</span>
                            </span>
                            ${submission ? `<button
                              class="px-3 py-1 text-xs rounded bg-blue-600 hover:bg-blue-700 text-white"
                              onclick="window.open('editor.html?assignment=${encodeURIComponent(assignment.id)}&student=${encodeURIComponent(submission.student_id)}&mode=review', '_blank')"
                            >
                              ${translations.view}
                            </button>` : ''}
                          </div>
                          ${submission ? `
                            <div class="flex items-center space-x-1">
                              <input type="number"
                                id="score-${submission.student_id}"
                                min="0"
                                max="100"
                                value="${submission.score !== undefined && submission.score !== null ? Math.round(submission.score) : ''}"
                                placeholder="${translations.scorePlaceholder}"
                                class="w-12 px-0 py-1 text-xs bg-gray-600 border border-gray-500 rounded text-white placeholder-gray-400 text-center"
                                style="-moz-appearance: textfield; -webkit-appearance: none; appearance: none;"
                              />
                              <button
                                class="px-2 py-1 text-xs rounded bg-blue-600 hover:bg-blue-700 text-white"
                                onclick="window.app.updateScore('${assignment.id}', '${submission.student_id}', '${submission.id}')"
                              >
                                ${translations.update}
                              </button>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `;
                  }).join('') : `<p class="text-gray-400 text-center py-4">${translations.noAssignedStudents}</p>`}
                </div>
              </div>
            </div>
          `;

          // 重新应用国际化
          if (typeof i18n !== 'undefined' && i18n.currentLanguage === 'en') {
            // 如果当前是英文模式，重新应用翻译
            setTimeout(() => {
              if (typeof translateAll === 'function') {
                translateAll();
              }
            }, 100);
          }

        } catch (error) {
          console.error('❌ 获取作业提交详情失败:', error);
          alert('获取作业提交详情失败：' + error.message);
        }
      }

      /**
       * 生成教师调试信息
       */
      generateTeacherDebugInfo(assignmentId, assignment, assignedStudents) {
        const localSubmissions = JSON.parse(localStorage.getItem('oj-assignment-submissions') || '[]');
        const assignmentSubmissions = localSubmissions.filter(s => s.assignmentId === assignmentId);

        let debugText = `🔍 教师端调试信息
==================
作业ID: ${assignmentId}
作业标题: ${assignment.title}
分配学生数: ${assignedStudents.length}
本地提交总数: ${localSubmissions.length}
当前作业提交数: ${assignmentSubmissions.length}

📋 当前作业的所有提交记录:
`;

        if (assignmentSubmissions.length === 0) {
          debugText += '  (无提交记录)\n\n';
        } else {
          assignmentSubmissions.forEach((sub, index) => {
            debugText += `  记录${index + 1}:
    - 提交ID: ${sub.id}
    - 作业ID: ${sub.assignmentId}
    - 学生ID: ${sub.studentId}
    - 学生姓名: ${sub.studentName}
    - 提交时间: ${sub.submittedAt}
    - 文件数量: ${sub.files ? sub.files.length : 0}
    - 状态: ${sub.status || '未知'}
`;
          });
        }

        debugText += `\n👥 分配学生详细信息和匹配测试:\n`;
        assignedStudents.forEach((student, index) => {
          const submission = assignmentSubmissions.find(s => {
            const match = s.studentId === student.id ||
                         s.studentId === student.username ||
                         s.studentId === student.studentId ||
                         s.studentName === student.fullName ||
                         s.studentName === student.username;
            return match;
          });

          debugText += `  学生${index + 1}:
    - 姓名: ${student.fullName}
    - 学号: ${student.studentId}
    - 用户名: ${student.username}
    - ID: ${student.id}
    - 找到提交: ${submission ? '是' : '否'}
`;

          if (submission) {
            debugText += `    - 提交ID: ${submission.id}
    - 提交学生ID: ${submission.studentId}
    - 提交学生姓名: ${submission.studentName}
`;
          }
          debugText += '\n';
        });

        debugText += `\n🧪 匹配测试详情:
遍历所有提交记录，检查每个提交是否能匹配到分配的学生:\n`;

        localSubmissions.forEach((sub, index) => {
          const isForThisAssignment = sub.assignmentId === assignmentId;
          const matchedStudent = assignedStudents.find(student => {
            const match = sub.studentId === student.id ||
                         sub.studentId === student.username ||
                         sub.studentId === student.studentId ||
                         sub.studentName === student.fullName ||
                         sub.studentName === student.username;
            return match;
          });

          debugText += `  提交${index + 1}:
    - 属于此作业: ${isForThisAssignment ? '是' : '否'}
    - 匹配到学生: ${matchedStudent ? matchedStudent.fullName : '无'}
`;

          if (!isForThisAssignment) {
            debugText += `    - 作业ID不匹配: 提交作业ID=${sub.assignmentId}, 当前作业ID=${assignmentId}\n`;
          }
        });

        return debugText;
      }

      /**
       * 更新分数（统一处理打分和修改分数）
       */
      async updateScore(assignmentId, studentId, submissionId) {
        const scoreInput = document.getElementById(`score-${studentId}`);
        const score = parseInt(scoreInput.value);

        if (isNaN(score) || score < 0 || score > 100) {
          alert('请输入有效的分数（0-100）');
          return;
        }

        try {
          // 先尝试更新数据库
          try {
            const currentUser = JSON.parse(localStorage.getItem('oj-current-user') || '{}');
            console.log('🔍 当前用户信息:', currentUser);
            console.log('🔍 用户ID:', currentUser.id, '类型:', typeof currentUser.id);

            // 确保传递正确的教师ID（必须是整数）
            const teacherId = currentUser.id ? parseInt(currentUser.id) : null;
            console.log('🔍 教师ID:', teacherId, '类型:', typeof teacherId);

            const response = await fetch(`http://localhost:5025/api/assignments/${assignmentId}/submissions/${submissionId}/grade`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                score: score,
                gradedBy: teacherId
              })
            });

            const result = await response.json();
            if (result.success) {
              console.log('✅ 数据库分数更新成功');
              // 重新加载提交数据以更新显示
              this.viewAssignmentSubmissions(assignmentId);
            } else {
              console.warn('⚠️ 数据库更新失败，将更新本地存储:', result.message);
            }
          } catch (error) {
            console.warn('⚠️ 无法连接到数据库，将更新本地存储:', error.message);
          }

          // 同时更新本地存储作为备份
          const submissions = JSON.parse(localStorage.getItem('oj-assignment-submissions') || '[]');
          const submissionIndex = submissions.findIndex(s => s.id === submissionId);

          if (submissionIndex !== -1) {
            // 更新分数和评分时间
            submissions[submissionIndex].score = score;
            submissions[submissionIndex].gradedAt = new Date().toISOString();
            submissions[submissionIndex].gradedBy = JSON.parse(localStorage.getItem('oj-current-user') || '{}').fullName || '教师';

            // 保存回本地存储
            localStorage.setItem('oj-assignment-submissions', JSON.stringify(submissions));
          }

          // 显示成功消息
          alert(`分数更新成功！分数：${score}分`);

          // 刷新页面显示
          this.viewAssignmentSubmissions(assignmentId);
        } catch (error) {
          console.error('更新分数失败:', error);
          alert('更新分数失败，请稍后重试');
        }
      }

      /**
       * 作业打分功能
       */
      gradeSubmission(assignmentId, studentId, submissionId) {
        const scoreInput = document.getElementById(`score-${studentId}`);
        const score = parseInt(scoreInput.value);

        if (isNaN(score) || score < 0 || score > 100) {
          alert('请输入有效的分数（0-100）');
          return;
        }

        try {
          // 获取本地存储的提交数据
          const submissions = JSON.parse(localStorage.getItem('oj-assignment-submissions') || '[]');
          const submissionIndex = submissions.findIndex(s => s.id === submissionId);

          if (submissionIndex !== -1) {
            // 更新分数和评分时间
            submissions[submissionIndex].score = score;
            submissions[submissionIndex].gradedAt = new Date().toISOString();
            submissions[submissionIndex].gradedBy = JSON.parse(sessionStorage.getItem('current-user') || '{}').fullName || '教师';

            // 保存回本地存储
            localStorage.setItem('oj-assignment-submissions', JSON.stringify(submissions));

            // 显示成功消息
            alert(`打分成功！分数：${score}分`);

            // 刷新页面显示
            this.viewAssignmentSubmissions(assignmentId);
          } else {
            alert('未找到提交记录');
          }
        } catch (error) {
          console.error('打分失败:', error);
          alert('打分失败，请稍后重试');
        }
      }

      /**
       * 刷新教师调试信息
       */
      refreshTeacherDebugInfo(assignmentId) {
        const assignments = this.getAllAssignments();
        const students = this.getAllStudentsSync();
        const assignment = assignments.find(a => a.id === assignmentId);

        if (!assignment) return;

        const assignedStudents = students.filter(student =>
          assignment.assignedStudents?.includes(student.id)
        );

        const debugContent = document.getElementById('teacher-debug-content');
        if (debugContent) {
          debugContent.textContent = this.generateTeacherDebugInfo(assignmentId, assignment, assignedStudents);
        }
      }

      /**
       * 编辑作业
       */
      async editAssignment(assignmentId) {
        const assignments = this.getAllAssignments();
        const assignment = assignments.find(a => a.id === assignmentId);
        const courses = await this.getAllCourses();

        if (!assignment) {
          alert('未找到该作业');
          return;
        }

        const modalHtml = `
          <div id="edit-assignment-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">编辑作业</h3>
              <form id="edit-assignment-form" class="space-y-4">
                <input type="hidden" name="assignmentId" value="${assignment.id}">

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentTitle">${this.getTranslationText('assignmentTitle')}</label>
                  <input type="text" name="title" value="${assignment.title}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentDescription">${this.getTranslationText('assignmentDescription')}</label>
                  <textarea name="description" rows="3" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all resize-none">${assignment.description}</textarea>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="assignmentDeadline">${this.getTranslationText('assignmentDeadline')}</label>
                  <input type="datetime-local" name="deadline" value="${new Date(assignment.deadline).toISOString().slice(0, 16)}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    ${this.getTranslationText('cancel')}
                  </button>
                  <button type="submit"
                    class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    ${this.getTranslationText('saveChanges')}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        document.getElementById('edit-assignment-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleEditAssignment(e);
        });
      }

      /**
       * 处理编辑作业
       */
      handleEditAssignment(event) {
        const formData = new FormData(event.target);
        const assignmentId = formData.get('assignmentId');

        try {
          const assignments = this.getAllAssignments();
          const assignmentIndex = assignments.findIndex(a => a.id === assignmentId);

          if (assignmentIndex !== -1) {
            assignments[assignmentIndex] = {
              ...assignments[assignmentIndex],
              title: formData.get('title'),
              description: formData.get('description'),
              deadline: new Date(formData.get('deadline')).toISOString(),
              updatedAt: new Date().toISOString()
            };

            localStorage.setItem('oj-assignments', JSON.stringify(assignments));
            this.closeModal();
            this.loadAssignmentsPage();
            alert('作业修改成功！');
          }
        } catch (error) {
          console.error('修改作业失败:', error);
          alert('修改失败：' + error.message);
        }
      }

      /**
       * 删除作业
       */
      deleteAssignment(assignmentId) {
        if (confirm('确定要删除这个作业吗？')) {
          try {
            const assignments = this.getAllAssignments();
            const updatedAssignments = assignments.filter(a => a.id !== assignmentId);
            localStorage.setItem('oj-assignments', JSON.stringify(updatedAssignments));

            this.loadAssignmentsPage();
            alert('作业删除成功！');
          } catch (error) {
            console.error('删除作业失败:', error);
            alert('删除失败：' + error.message);
          }
        }
      }

      /**
       * 加载用户管理页面
       */
      async loadUsersPage(pageId) {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;

        if (pageId === 'teachers') {
          // 教师管理页面 - 从数据库获取所有用户并筛选教师
          try {
            const allUsers = await this.getAllUsers();
            const teachers = allUsers.filter(user => user.role === 'teacher');

          // 安全获取翻译文本的辅助函数 - 增强版
        const t = (key, fallback = key) => {
          try {
            // 首先尝试从全局i18n获取
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            // 如果全局i18n不可用，尝试从本地i18n获取
            if (i18n && i18n.translations && i18n.currentLanguage) {
              const translation = i18n.translations[i18n.currentLanguage][key];
              if (translation) return translation;
            }
            // 最后的回退：直接从localStorage获取语言设置
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
            console.warn('Translation not found for key:', key, 'language:', currentLang);
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white" data-i18n="teacherManagement">${t('teacherManagement')}</h2>
                <button onclick="window.app.showAddTeacherModal()" class="btn-primary px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                  <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                  </svg>
                  <span data-i18n="addTeacher">${t('addTeacher')}</span>
                </button>
              </div>

              <div class="glass-effect rounded-lg p-6">
                <div class="mb-4">
                  <div class="flex items-center space-x-4">
                    <input type="text" id="teacher-search" placeholder="${t('searchTeacher')}" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white flex-1">
                    <select id="teacher-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                      <option value="all">${t('allRoles')}</option>
                      <option value="active">${t('active')}</option>
                      <option value="inactive">${t('inactive')}</option>
                    </select>
                  </div>
                </div>

                <div class="space-y-4">
                  ${teachers.length > 0 ? teachers.map(teacher => `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <h3 class="text-lg font-semibold text-white">${teacher.full_name || teacher.fullName}</h3>
                          <p class="text-sm text-gray-400">${t('username')}: ${teacher.username || t('unknown')}</p>
                          <p class="text-xs text-gray-500">${t('employeeId')}: ${teacher.employee_id || t('unknown')} • ${t('department')}: ${teacher.department || t('unknown')}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                          <button onclick="window.app.toggleUserStatus('${teacher.id}', 'teacher')"
                                  class="px-2 py-1 text-xs rounded-full font-medium transition-all duration-200 ${teacher.is_active ? 'bg-green-500 bg-opacity-20 text-green-400 hover:bg-green-500 hover:bg-opacity-30' : 'bg-red-500 bg-opacity-20 text-red-400 hover:bg-red-500 hover:bg-opacity-30'}">
                            ${teacher.is_active ? t('teacherActive') : t('teacherInactive')}
                          </button>
                          <button onclick="window.app.editTeacher('${teacher.id}')" class="p-2 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${t('edit')}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button onclick="window.app.confirmDeleteTeacher('${teacher.id}')" class="p-2 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${t('delete')}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('') : `<p class="text-gray-400 text-center py-8">${t('noData')}</p>`}
                  </div>
                </div>
              </div>
            </div>
          `;

          // 应用语言设置到动态生成的内容
          setTimeout(() => {
            if (window.i18n) {
              window.i18n.applyToDynamicContent(pageContent);
            }
          }, 10);
          } catch (error) {
            console.error('获取教师列表失败:', error);
            pageContent.innerHTML = `
              <div class="animate-fade-in-up">
                <div class="text-center py-8">
                  <p class="text-red-400">加载教师数据失败，请刷新页面重试</p>
                </div>
              </div>
            `;
          }
        } else if (pageId === 'students') {
          // 学生管理页面
          if (currentUser.role === 'teacher') {
            // 教师查看自己课程的学生
            this.loadTeacherStudentsPage();
            return;
          }

          // 管理员查看所有学生 - 从数据库获取所有用户并筛选学生
          let students;
          try {
            const allUsers = await this.getAllUsers();
            students = allUsers.filter(user => user.role === 'student');
          } catch (error) {
            console.error('获取学生列表失败:', error);
            students = [];
          }

        // 安全获取翻译文本的辅助函数 - 增强版
        const t = (key, fallback = key) => {
          try {
            // 首先尝试从全局i18n获取
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            // 如果全局i18n不可用，尝试从本地i18n获取
            if (i18n && i18n.translations && i18n.currentLanguage) {
              const translation = i18n.translations[i18n.currentLanguage][key];
              if (translation) return translation;
            }
            // 最后的回退：直接从localStorage获取语言设置
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
            console.warn('Translation not found for key:', key, 'language:', currentLang);
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white" data-i18n="studentManagement">${t('studentManagement')}</h2>
                <div class="flex space-x-3">
                  <button onclick="window.app.showCSVImportModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    ${t('csvImport')}
                  </button>
                  <button onclick="window.app.showAddStudentModal()" class="btn-primary px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    <span data-i18n="addStudent">${t('addStudent')}</span>
                  </button>
                </div>
              </div>

              <div class="glass-effect rounded-lg p-6">
                <div class="mb-4">
                  <div class="flex items-center space-x-4">
                    <input type="text" id="student-search" placeholder="${t('searchStudent')}" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white flex-1">
                    <select id="student-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                      <option value="all">${t('allRoles')}</option>
                      <option value="active">${t('active')}</option>
                      <option value="inactive">${t('inactive')}</option>
                    </select>
                  </div>
                </div>

                <div class="space-y-2">
                  ${students.length > 0 ? students.map(student => `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-3">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                          <!-- 基本信息 -->
                          <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <h3 class="text-base font-semibold text-white whitespace-nowrap">${student.full_name || student.username || '未知'}</h3>
                            <span class="text-sm text-gray-400 whitespace-nowrap">用户名: ${student.username || 'N/A'}</span>
                            ${student.student_id ? `<span class="text-xs text-gray-500 whitespace-nowrap">${t('studentId')}: ${student.student_id}</span>` : ''}
                            ${student.major ? `<span class="text-xs text-gray-500 whitespace-nowrap">${t('major')}: ${student.major}</span>` : ''}
                          </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="flex items-center space-x-1">
                          <button onclick="window.app.toggleUserStatus('${student.id}', 'student')"
                                  class="px-2 py-1 text-xs rounded-full font-medium transition-all duration-200 whitespace-nowrap ${student.is_active ? 'bg-green-500 bg-opacity-20 text-green-400 hover:bg-green-500 hover:bg-opacity-30' : 'bg-red-500 bg-opacity-20 text-red-400 hover:bg-red-500 hover:bg-opacity-30'}">
                            ${student.is_active ? t('studentActive') : t('studentInactive')}
                          </button>
                          <button onclick="window.app.editStudent('${student.id}')" class="p-1.5 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${t('edit')}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button onclick="window.app.confirmDeleteStudent('${student.id}')" class="p-1.5 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors" title="${t('delete')}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('') : `<p class="text-gray-400 text-center py-8">${t('noData')}</p>`}
                  </div>
                </div>
              </div>
            </div>
          `;

          // 应用语言设置到动态生成的内容
          setTimeout(() => {
            if (window.i18n) {
              window.i18n.applyToDynamicContent(pageContent);
            }
          }, 10);
        }
      }

      /**
       * 显示添加教师模态框
       */
      showAddTeacherModal() {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        const modalHtml = `
          <div id="teacher-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center" data-i18n="addTeacherFormTitle">${t('addTeacherFormTitle')}</h3>
              <form id="add-teacher-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="fullName">${t('fullName')}</label>
                  <input type="text" name="fullName" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterTeacherName')}" data-i18n-placeholder="enterTeacherName">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="usernameForLogin">${t('usernameForLogin')}</label>
                  <input type="text" name="username" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterUsername')}" data-i18n-placeholder="enterUsername">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="employeeId">${t('employeeId')}</label>
                  <input type="text" name="employeeId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('employeeId')}" data-i18n-placeholder="employeeId">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="password">${t('password')}</label>
                  <input type="password" name="password" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterLoginPassword')}" data-i18n-placeholder="enterLoginPassword" value="123123">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="phone">${t('phone')}</label>
                  <input type="tel" name="phone" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterPhoneNumber')}" data-i18n-placeholder="enterPhoneNumber">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="department">${t('department')}</label>
                  <input type="text" name="department" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterDepartmentName')}" data-i18n-placeholder="enterDepartmentName">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    <span data-i18n="cancel">${t('cancel')}</span>
                  </button>
                  <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    <span data-i18n="addTeacher">${t('addTeacher')}</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 多次尝试确保模态框中的语言被正确应用
        const applyLanguageInModal = () => {
          const modal = document.getElementById('teacher-modal');
          if (modal && window.i18n) {
            // 应用到整个模态框
            window.i18n.applyToDynamicContent(modal);

            // 额外处理所有placeholder属性
            const inputs = modal.querySelectorAll('input[data-i18n-placeholder]');
            inputs.forEach(input => {
              const key = input.getAttribute('data-i18n-placeholder');
              if (key) {
                input.placeholder = window.i18n.t(key);
              }
            });

            // 处理所有文本内容
            const textElements = modal.querySelectorAll('[data-i18n]');
            textElements.forEach(element => {
              const key = element.getAttribute('data-i18n');
              if (key && element.textContent !== window.i18n.t(key)) {
                element.textContent = window.i18n.t(key);
              }
            });
          }
        };

        // 立即应用一次
        applyLanguageInModal();

        // 短延迟后再次应用
        setTimeout(applyLanguageInModal, 10);

        // 更长延迟后再次应用，确保DOM完全渲染
        setTimeout(applyLanguageInModal, 100);

        document.getElementById('add-teacher-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleAddTeacher(e);
        });
      }

      /**
       * 显示添加学生模态框
       */
      showAddStudentModal() {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        const modalHtml = `
          <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-5 w-full max-w-sm shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center" data-i18n="addStudentFormTitle">${t('addStudentFormTitle')}</h3>
              <form id="add-student-form" class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="fullName">${t('fullName')}</label>
                  <input type="text" name="fullName" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterStudentName')}" data-i18n-placeholder="enterStudentName">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="usernameForLogin">${t('usernameForLogin')}</label>
                  <input type="text" name="username" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterUsername')}" data-i18n-placeholder="enterUsername">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="password">${t('password')}</label>
                  <input type="password" name="password" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterLoginPassword')}" data-i18n-placeholder="enterLoginPassword" value="123123">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="studentId">${t('studentId')}</label>
                  <input type="text" name="studentId" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterStudentId')}" data-i18n-placeholder="enterStudentId">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="grade">${t('grade')}</label>
                  <input type="text" name="grade" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterGradeName')}" data-i18n-placeholder="enterGradeName">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2" data-i18n="major">${t('major')}</label>
                  <input type="text" name="major" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="${t('enterMajorName')}" data-i18n-placeholder="enterMajorName">
                </div>
                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    <span data-i18n="cancel">${t('cancel')}</span>
                  </button>
                  <button type="submit"
                    class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    <span data-i18n="addStudent">${t('addStudent')}</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 多次尝试确保模态框中的语言被正确应用
        const applyLanguageInModal = () => {
          const modal = document.getElementById('student-modal');
          if (modal && window.i18n) {
            // 应用到整个模态框
            window.i18n.applyToDynamicContent(modal);

            // 额外处理所有placeholder属性
            const inputs = modal.querySelectorAll('input[data-i18n-placeholder]');
            inputs.forEach(input => {
              const key = input.getAttribute('data-i18n-placeholder');
              if (key) {
                input.placeholder = window.i18n.t(key);
              }
            });

            // 处理所有文本内容
            const textElements = modal.querySelectorAll('[data-i18n]');
            textElements.forEach(element => {
              const key = element.getAttribute('data-i18n');
              if (key && element.textContent !== window.i18n.t(key)) {
                element.textContent = window.i18n.t(key);
              }
            });
          }
        };

        // 立即应用一次
        applyLanguageInModal();

        // 短延迟后再次应用
        setTimeout(applyLanguageInModal, 10);

        // 更长延迟后再次应用，确保DOM完全渲染
        setTimeout(applyLanguageInModal, 100);

        document.getElementById('add-student-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleAddStudent(e);
        });
      }

      /**
       * 处理添加教师
       */
      async handleAddTeacher(event) {
        const formData = new FormData(event.target);
        const teacherData = {
          fullName: formData.get('fullName'),
          username: formData.get('username'),
          employeeId: formData.get('employeeId'),
          password: formData.get('password'),
          phone: formData.get('phone'),
          department: formData.get('department'),
        };

        try {
          const result = await this.addTeacher(teacherData);
          if (result.success) {
            this.closeModal();
            this.loadUsersPage('teachers');
            alert(`教师添加成功！\n登录账号：${teacherData.username}\n登录密码：${teacherData.password}`);
          } else {
            alert('添加失败：' + (result.error || result.message || '未知错误'));
          }
        } catch (error) {
          console.error('添加教师失败:', error);
          alert('添加失败：' + error.message);
        }
      }

      /**
       * 处理添加学生
       */
      async handleAddStudent(event) {
        const formData = new FormData(event.target);
        const studentData = {
          fullName: formData.get('fullName'),
          username: formData.get('username'),
          password: formData.get('password'),
          studentId: formData.get('studentId'),
          grade: formData.get('grade'),
          major: formData.get('major'),
        };

        try {
          const result = await this.addStudent(studentData);
          if (result.success) {
            this.closeModal();
            this.loadUsersPage('students');
            alert(`学生添加成功！\n登录账号：${studentData.username}\n登录密码：${studentData.password}`);
          } else {
            alert('添加失败：' + (result.error || result.message || '未知错误'));
          }
        } catch (error) {
          console.error('添加学生失败:', error);
          alert('添加失败：' + error.message);
        }
      }

      /**
       * 显示用户注册模态框
       */
      showRegisterModal() {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        const modalHtml = `
          <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">用户注册</h3>
              <form id="register-form" class="space-y-3">
                <!-- 用户角色选择 -->
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">用户角色</label>
                  <select name="role" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
                    <option value="">请选择角色</option>
                    <option value="student">学生</option>
                    <option value="teacher">教师</option>
                  </select>
                </div>

                <!-- 基本信息 -->
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">姓名</label>
                  <input type="text" name="fullName" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入真实姓名">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">用户名</label>
                  <input type="text" name="username" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入登录用户名">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">密码</label>
                  <input type="password" name="password" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入至少6位密码">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">确认密码</label>
                  <input type="password" name="confirmPassword" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请再次输入密码">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">邮箱（可选）</label>
                  <input type="email" name="email"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入邮箱地址">
                </div>

                <!-- 学生专用字段 -->
                <div id="student-fields" class="hidden space-y-3">
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">学号</label>
                    <input type="text" name="studentId"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入学号">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">专业</label>
                    <input type="text" name="major"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入专业">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">年级</label>
                    <input type="text" name="grade"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入年级">
                  </div>
                </div>

                <!-- 教师专用字段 -->
                <div id="teacher-fields" class="hidden space-y-3">
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">工号</label>
                    <input type="text" name="employeeId"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入工号">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">院系</label>
                    <input type="text" name="department"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入院系">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-200 mb-2">电话</label>
                    <input type="tel" name="phone"
                      class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all"
                      placeholder="请输入电话号码">
                  </div>
                </div>

                <div class="flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-700">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    取消
                  </button>
                  <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    立即注册
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 角色切换逻辑
        const roleSelect = document.querySelector('select[name="role"]');
        const studentFields = document.getElementById('student-fields');
        const teacherFields = document.getElementById('teacher-fields');

        roleSelect.addEventListener('change', (e) => {
          const role = e.target.value;
          if (role === 'student') {
            studentFields.classList.remove('hidden');
            teacherFields.classList.add('hidden');
          } else if (role === 'teacher') {
            studentFields.classList.add('hidden');
            teacherFields.classList.remove('hidden');
          } else {
            studentFields.classList.add('hidden');
            teacherFields.classList.add('hidden');
          }
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleRegister(e);
        });
      }

      /**
       * 处理用户注册
       */
      async handleRegister(event) {
        const formData = new FormData(event.target);
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');

        // 验证密码
        if (password !== confirmPassword) {
          alert('两次输入的密码不一致！');
          return;
        }

        if (password.length < 6) {
          alert('密码长度至少6位！');
          return;
        }

        const userData = {
          fullName: formData.get('fullName'),
          username: formData.get('username'),
          password: password,
          email: formData.get('email') || '',
          role: formData.get('role'),
          studentId: formData.get('studentId') || '',
          major: formData.get('major') || '',
          grade: formData.get('grade') || '',
          employeeId: formData.get('employeeId') || '',
          department: formData.get('department') || '',
          phone: formData.get('phone') || ''
        };

        try {
          const response = await fetch('http://localhost:5024/api/public/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
          });

          const result = await response.json();

          if (result.success) {
            this.closeModal();
            alert(`注册成功！\n\n用户名：${userData.username}\n密码：${userData.password}\n\n您现在可以使用此账号登录系统。`);
          } else {
            alert('注册失败：' + (result.message || '未知错误'));
          }
        } catch (error) {
          console.error('注册失败:', error);
          alert('注册失败：' + error.message);
        }
      }

      /**
       * 关闭模态框
       */
      closeModal() {
        const modals = document.querySelectorAll('#teacher-modal, #student-modal, #course-modal, #assignment-modal, #import-students-modal, #csv-import-modal, #edit-student-modal, #edit-teacher-modal, #assign-students-modal, #edit-assignment-modal, #register-modal');
        modals.forEach(modal => modal.remove());
      }

      /**
       * 显示CSV导入模态框
       */
      showCSVImportModal() {
        const modalHtml = `
          <div id="csv-import-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-lg shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">${this.i18n.t('csvBatchImportStudents')}</h3>

              <!-- 模板下载 -->
              <div class="mb-4 text-center">
                <a href="students_template.csv" download class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  ${this.i18n.t('downloadCSVTemplate')}
                </a>
              </div>

              <!-- 文件上传区域 -->
              <div class="mb-4">
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition-colors" id="csv-drop-zone">
                  <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                  </svg>
                  <p class="text-gray-300 mb-3">${this.i18n.t('dropCSVFileOrClick')}</p>
                  <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                  <button type="button" onclick="document.getElementById('csv-file-input').click()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    ${this.i18n.t('selectCSVFile')}
                  </button>
                </div>
              </div>

              <!-- 操作按钮 -->
              <div class="flex justify-between items-center">
                <div id="csv-error" class="text-red-400 text-sm hidden"></div>
                <div class="flex space-x-3">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    ${this.i18n.t('cancel')}
                  </button>
                  <button type="button" id="import-csv-btn" onclick="window.app.importCSVData()" disabled
                    class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">
                    ${this.i18n.t('startImport')}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        this.setupCSVImportEvents();
      }

      /**
       * 设置CSV导入事件监听
       */
      setupCSVImportEvents() {
        const dropZone = document.getElementById('csv-drop-zone');
        const fileInput = document.getElementById('csv-file-input');
        const importBtn = document.getElementById('import-csv-btn');

        // 文件拖拽事件
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        });

        dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dropZone.classList.remove('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].type === 'text/csv') {
            this.handleCSVFile(files[0]);
          }
        });

        // 文件选择事件
        fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            this.handleCSVFile(e.target.files[0]);
          }
        });
      }

      /**
       * 处理CSV文件
       */
      handleCSVFile(file) {
        if (file.type !== 'text/csv') {
          this.showCSVError(this.i18n.t('selectCSVFormatFile'));
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csvData = this.parseCSV(e.target.result);
            this.pendingCSVData = csvData;
            document.getElementById('import-csv-btn').disabled = false;
            document.getElementById('csv-error').classList.add('hidden');
          } catch (error) {
            this.showCSVError(this.i18n.t('csvParseError') + '：' + error.message);
          }
        };
        reader.readAsText(file, 'UTF-8');
      }

      /**
       * 解析CSV数据
       */
      parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) {
          throw new Error(this.i18n.t('csvMinRowsError'));
        }

        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const students = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          if (values.length >= 3) { // 至少需要基本信息
            const student = {};
            headers.forEach((header, index) => {
              if (values[index]) {
                student[header] = values[index];
              }
            });

            // 确保必要字段存在
            if (!student.fullName || !student.username) {
              continue; // 跳过不完整的记录
            }

            // 设置默认值
            student.password = student.password || '123123';
            student.email = student.email || student.username + '@student.edu';
            student.phone = student.phone || '';
            student.grade = student.grade || '';
            student.class = student.class || '';
            student.major = student.major || (student.class || '计算机科学');
            student.studentId = student.studentId || student.username;

            students.push(student);
          }
        }

        return students;
      }

      /**
       * 预览CSV数据
       */
    
      /**
       * 显示CSV错误
       */
      showCSVError(message) {
        const errorDiv = document.getElementById('csv-error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        document.getElementById('import-csv-btn').disabled = true;
      }

      /**
       * 导入CSV数据
       */
      async importCSVData() {
        if (!this.pendingCSVData || this.pendingCSVData.length === 0) {
          this.showCSVError('没有可导入的数据');
          return;
        }

        const importBtn = document.getElementById('import-csv-btn');
        const originalText = importBtn.textContent;

        try {
          importBtn.disabled = true;
          importBtn.textContent = '导入中...';

          let successCount = 0;
          let errorCount = 0;
          const errors = [];

          for (let i = 0; i < this.pendingCSVData.length; i++) {
            try {
              const studentData = this.pendingCSVData[i];
              const result = await this.addStudent(studentData);

              if (result.success) {
                successCount++;
              } else {
                errorCount++;
                errors.push(`第${i + 1}行：${result.error}`);
              }
            } catch (error) {
              errorCount++;
              errors.push(`第${i + 1}行：${error.message}`);
            }
          }

          // 显示导入结果
          let message = `导入完成！\n成功：${successCount} 人\n失败：${errorCount} 人`;
          if (errors.length > 0) {
            message += '\n\n错误详情：\n' + errors.slice(0, 5).join('\n');
            if (errors.length > 5) {
              message += `\n... 还有 ${errors.length - 5} 个错误`;
            }
          }

          if (successCount > 0) {
            // 同步用户数据到服务器
            await this.syncUsersToServer();

            // 刷新页面
            this.loadUsersPage('students');
          }

          alert(message);
          this.closeModal();

        } catch (error) {
          console.error('CSV导入失败:', error);
          this.showCSVError('导入过程中发生错误：' + error.message);
        } finally {
          importBtn.disabled = false;
          importBtn.textContent = originalText;
        }
      }

      /**
       * 编辑教师
       */
      async editTeacher(teacherId) {
        const teacher = await this.getTeacherById(teacherId);
        if (!teacher) {
          alert('未找到该教师');
          return;
        }

        const modalHtml = `
          <div id="edit-teacher-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">编辑教师</h3>
              <form id="edit-teacher-form" class="space-y-4">
                <input type="hidden" name="teacherId" value="${teacher.id}">

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">姓名</label>
                  <input type="text" name="fullName" value="${teacher.full_name || teacher.fullName}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">用户名</label>
                  <input type="text" name="username" value="${teacher.username}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">工号</label>
                  <input type="text" name="employeeId" value="${teacher.employee_id || ''}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入工号">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">院系</label>
                  <input type="text" name="department" value="${teacher.department || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入所属院系">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">手机号</label>
                  <input type="tel" name="phone" value="${teacher.phone || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入手机号">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">专业领域</label>
                  <input type="text" name="specialization" value="${teacher.specialization || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all"
                    placeholder="请输入专业领域">
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    取消
                  </button>
                  <button type="submit"
                    class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    保存修改
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 确保模态框中的 data-i18n 元素被正确翻译
        setTimeout(() => {
          if (window.i18n) {
            const modal = document.getElementById('edit-teacher-modal');
            if (modal) {
              window.i18n.applyToDynamicContent(modal);
            }
          }
        }, 10);

        document.getElementById('edit-teacher-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleEditTeacher(e);
        });
      }

      /**
       * 切换用户激活状态
       */
      async toggleUserStatus(userId, userType) {
        try {
          const response = await fetch(`http://localhost:5025/api/users/${userId}/toggle-status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          const result = await response.json();

          if (result.success) {
            // 重新加载当前页面以反映变化
            if (userType === 'teacher') {
              await this.loadUsersPage('teachers');
            } else if (userType === 'student') {
              await this.loadUsersPage('students');
            }
          } else {
            this.showMessage(result.message, 'error');
          }
        } catch (error) {
          console.error('切换用户状态失败:', error);
          this.showMessage('切换用户状态失败', 'error');
        }
      }

      /**
       * 显示消息提示
       */
      showMessage(message, type = 'info') {
        // 创建临时提示元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0`;

        // 根据类型设置样式
        if (type === 'success') {
          messageDiv.classList.add('bg-green-500', 'text-white');
        } else if (type === 'error') {
          messageDiv.classList.add('bg-red-500', 'text-white');
        } else {
          messageDiv.classList.add('bg-blue-500', 'text-white');
        }

        messageDiv.textContent = message;

        // 添加到页面
        document.body.appendChild(messageDiv);

        // 3秒后自动移除
        setTimeout(() => {
          messageDiv.classList.add('opacity-0', 'transform', 'translate-x-full');
          setTimeout(() => {
            if (messageDiv.parentNode) {
              messageDiv.parentNode.removeChild(messageDiv);
            }
          }, 300);
        }, 3000);
      }

      // 添加缺失的用户管理方法
      async loadTeachers() {
        try {
          const response = await fetch('http://localhost:5025/api/users?role=teacher');
          const result = await response.json();

          if (result.success && result.data) {
            this.displayTeachers(result.data);
          } else {
            this.showMessage('加载教师数据失败', 'error');
          }
        } catch (error) {
          console.error('加载教师数据失败:', error);
          this.showMessage('加载教师数据失败', 'error');
        }
      }

      async loadStudents() {
        try {
          const response = await fetch('http://localhost:5025/api/users?role=student');
          const result = await response.json();

          if (result.success && result.data) {
            this.displayStudents(result.data);
          } else {
            this.showMessage('加载学生数据失败', 'error');
          }
        } catch (error) {
          console.error('加载学生数据失败:', error);
          this.showMessage('加载学生数据失败', 'error');
        }
      }

      async loadAllStudents() {
        try {
          const response = await fetch('http://localhost:5025/api/users?role=student&all=true');
          const result = await response.json();

          if (result.success && result.data) {
            this.displayAllStudents(result.data);
          } else {
            this.showMessage('加载所有学生数据失败', 'error');
          }
        } catch (error) {
          console.error('加载所有学生数据失败:', error);
          this.showMessage('加载所有学生数据失败', 'error');
        }
      }

      // 辅助方法：显示教师列表
      displayTeachers(teachers) {
        const teacherList = document.getElementById('teacherList');
        if (!teacherList) return;

        teacherList.innerHTML = '';
        teachers.forEach(teacher => {
          const teacherCard = this.createTeacherCard(teacher);
          teacherList.appendChild(teacherCard);
        });
      }

      // 辅助方法：显示学生列表
      displayStudents(students) {
        const studentList = document.getElementById('studentList');
        if (!studentList) return;

        studentList.innerHTML = '';
        students.forEach(student => {
          const studentCard = this.createStudentCard(student);
          studentList.appendChild(studentCard);
        });
      }

      // 辅助方法：显示所有学生
      displayAllStudents(students) {
        const allStudentList = document.getElementById('allStudentList');
        if (!allStudentList) return;

        allStudentList.innerHTML = '';
        students.forEach(student => {
          const studentCard = this.createAllStudentCard(student);
          allStudentList.appendChild(studentCard);
        });
      }

      // 创建教师卡片
      createTeacherCard(teacher) {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          if (window.i18n && window.i18n.t && window.i18n.translations[window.i18n.currentLanguage]) {
            return window.i18n.translations[window.i18n.currentLanguage][key] || key;
          }
          return fallback;
        };

        const teacherCard = document.createElement('div');
        teacherCard.className = 'bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 hover:bg-opacity-70 transition-all duration-300 border border-gray-700 hover:border-gray-600';

        teacherCard.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                ${teacher.full_name ? teacher.full_name.charAt(0).toUpperCase() : 'T'}
              </div>
              <div>
                <h3 class="text-xl font-semibold text-white">${teacher.full_name || t('unknown')}</h3>
                <p class="text-sm text-gray-300">${t('employeeId')}: ${teacher.employee_id || t('unknown')}</p>
                <p class="text-xs text-gray-500">${t('department')}: ${teacher.department || t('unknown')} • ${t('phone')}: ${teacher.phone || t('unknown')}</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="window.app.toggleUserStatus('${teacher.id}', 'teacher')"
                      class="px-2 py-1 text-xs rounded-full font-medium transition-all duration-200 ${teacher.is_active ? 'bg-green-500 bg-opacity-20 text-green-400 hover:bg-green-500 hover:bg-opacity-30' : 'bg-red-500 bg-opacity-20 text-red-400 hover:bg-red-500 hover:bg-opacity-30'}">
                ${teacher.is_active ? t('active') : t('inactive')}
              </button>
              <button onclick="window.app.editTeacher('${teacher.id}')" class="p-2 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button onclick="window.app.confirmDeleteTeacher('${teacher.id}')" class="p-2 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        `;

        return teacherCard;
      }

      // 创建学生卡片
      createStudentCard(student) {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          try {
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            if (i18n && i18n.translations && i18n.currentLanguage) {
              const translation = i18n.translations[i18n.currentLanguage][key];
              if (translation) return translation;
            }
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        const studentCard = document.createElement('div');
        studentCard.className = 'bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 hover:bg-opacity-70 transition-all duration-300 border border-gray-700 hover:border-gray-600';

        studentCard.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                ${student.full_name ? student.full_name.charAt(0).toUpperCase() : 'S'}
              </div>
              <div>
                <h3 class="text-xl font-semibold text-white">${student.full_name || t('unknown')}</h3>
                <p class="text-sm text-gray-300">${t('studentId')}: ${student.student_id || t('unknown')}</p>
                <p class="text-xs text-gray-500">${t('major')}: ${student.major || t('unknown')} • ${t('grade')}: ${student.grade || t('unknown')}</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="window.app.toggleUserStatus('${student.id}', 'student')"
                      class="px-2 py-1 text-xs rounded-full font-medium transition-all duration-200 ${student.is_active ? 'bg-green-500 bg-opacity-20 text-green-400 hover:bg-green-500 hover:bg-opacity-30' : 'bg-red-500 bg-opacity-20 text-red-400 hover:bg-red-500 hover:bg-opacity-30'}">
                ${student.is_active ? t('studentActive') : t('studentInactive')}
              </button>
              <button onclick="window.app.editStudent('${student.id}')" class="p-2 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button onclick="window.app.confirmDeleteStudent('${student.id}')" class="p-2 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        `;

        return studentCard;
      }

      // 创建所有学生卡片（用于所有学生列表）
      createAllStudentCard(student) {
        const studentCard = document.createElement('div');
        studentCard.className = 'bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-4 hover:bg-opacity-70 transition-all duration-300 border border-gray-700 hover:border-gray-600';

        studentCard.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3 flex-1 min-w-0">
              <!-- 基本信息 -->
              <div class="flex items-center space-x-3 flex-1 min-w-0">
                <h3 class="text-base font-semibold text-white whitespace-nowrap">${student.full_name || '未知'}</h3>
                <span class="text-sm text-gray-400 whitespace-nowrap">用户名: ${student.username || 'N/A'}</span>
                <span class="text-xs text-gray-500 whitespace-nowrap">${t('studentId')}: ${student.student_id || '未设置'}</span>
                ${student.major ? `<span class="text-xs text-gray-500 whitespace-nowrap">${t('major')}: ${student.major}</span>` : ''}
                ${student.grade ? `<span class="text-xs text-gray-500 whitespace-nowrap">${t('grade')}: ${student.grade}</span>` : ''}
              </div>
            </div>
            <div class="flex items-center space-x-1">
              <button onclick="window.app.toggleUserStatus('${student.id}', 'student')"
                      class="px-2 py-1 text-xs rounded-full font-medium transition-all duration-200 whitespace-nowrap ${student.is_active ? 'bg-green-500 bg-opacity-20 text-green-400 hover:bg-green-500 hover:bg-opacity-30' : 'bg-red-500 bg-opacity-20 text-red-400 hover:bg-red-500 hover:bg-opacity-30'}">
                ${student.is_active ? '已激活' : '未激活'}
              </button>
              <button onclick="window.app.editStudent('${student.id}')" class="p-1.5 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors" title="编辑学生">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button onclick="window.app.confirmDeleteStudent('${student.id}')" class="p-1.5 text-red-400 hover:bg-red-500 hover:bg-opacity-20 rounded-lg transition-colors" title="删除学生">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        `;

        return studentCard;
      }

      /**
       * 处理编辑教师
       */
      async handleEditTeacher(event) {
        const formData = new FormData(event.target);
        const teacherId = formData.get('teacherId');

        const updatedData = {
          fullName: formData.get('fullName'),
          username: formData.get('username'),
          employeeId: formData.get('employeeId'),
          department: formData.get('department'),
          phone: formData.get('phone'),
          isActive: true
        };

        try {
          const response = await fetch(`http://localhost:5025/api/users/${teacherId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
          });

          const result = await response.json();

          if (result.success) {
            this.closeModal();
            this.loadUsersPage('teachers');
            alert('教师信息修改成功！');
          } else {
            alert('修改失败：' + result.message);
          }
        } catch (error) {
          console.error('修改教师失败:', error);
          alert('修改失败：' + error.message);
        }
      }

      /**
       * 删除教师确认
       */
      async confirmDeleteTeacher(teacherId) {
        if (confirm('确定要删除这位教师吗？')) {
          try {
            const result = await this.deleteTeacher(teacherId);
            if (result.success) {
              this.loadUsersPage('teachers');
              alert('教师删除成功！');
            } else {
              alert('删除失败：' + result.error);
            }
          } catch (error) {
            alert('删除失败：' + error.message);
          }
        }
      }

      /**
       * 编辑学生
       */
      editStudent(studentId) {
        const student = this.getStudentById(studentId);
        if (!student) {
          alert('未找到该学生');
          return;
        }

        const modalHtml = `
          <div id="edit-student-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
              <h3 class="text-xl font-bold text-white mb-4 text-center">编辑学生</h3>
              <form id="edit-student-form" class="space-y-4">
                <input type="hidden" name="studentId" value="${student.id}">

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">姓名</label>
                  <input type="text" name="fullName" value="${student.fullName}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">用户名</label>
                  <input type="text" name="username" value="${student.username}" required
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">学号</label>
                  <input type="text" name="studentNumber" value="${student.studentId || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

    
                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">电话</label>
                  <input type="tel" name="phone" value="${student.phone || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">年级</label>
                  <input type="text" name="grade" value="${student.grade || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-200 mb-2">班级</label>
                  <input type="text" name="class" value="${student.class || ''}"
                    class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
                    focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none transition-all">
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                  <button type="button" onclick="window.app.closeModal()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
                    取消
                  </button>
                  <button type="submit"
                    class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
                    保存修改
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        document.getElementById('edit-student-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleEditStudent(e);
        });
      }

      /**
       * 处理编辑学生
       */
      async handleEditStudent(event) {
        const formData = new FormData(event.target);
        // 从隐藏字段获取真实的学生ID
        const studentId = formData.get('studentId');

        try {
          // 准备API数据格式（转换为下划线格式）
          const apiData = {
            full_name: formData.get('fullName'),
            username: formData.get('username'),
            student_id: formData.get('studentNumber'),
            grade: formData.get('grade'),
            major: formData.get('major'),
            email: formData.get('email'),
            phone: formData.get('phone')
          };

          // 调用API更新学生信息
          const response = await fetch(`http://localhost:5025/api/users/${studentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiData)
          });

          const result = await response.json();

          if (result.success) {
            this.closeModal();
            this.loadUsersPage('students');
            alert('学生信息更新成功！');

            // 清除本地缓存，强制重新获取数据
            localStorage.removeItem('oj-students');
          } else {
            alert('更新失败：' + (result.message || '未知错误'));
          }
        } catch (error) {
          console.error('更新学生信息失败:', error);
          alert('更新失败：网络错误，请稍后重试');
        }
      }

      /**
       * 删除学生确认
       */
      async confirmDeleteStudent(studentId) {
        try {
          const result = await this.deleteStudent(studentId);
          if (result.success) {
            this.loadUsersPage('students');
          }
        } catch (error) {
          console.error('删除学生失败:', error);
        }
      }

      /**
       * 用户退出登录
       */
      logout() {
        try {
          localStorage.removeItem('oj-current-user');
          localStorage.removeItem('oj-user-role');
          console.log('用户已退出登录');
        } catch (error) {
          console.error('退出登录失败:', error);
        }
      }

      /**
       * 加载学生课程页面
       */
      async loadStudentCoursesPage() {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;

        console.log('🔍 从数据库获取学生课程数据...');

        try {
          // 使用API获取课程数据
          const response = await fetch('http://localhost:5025/api/courses');
          const result = await response.json();

          if (!result.success) {
            throw new Error('获取课程数据失败: ' + result.message);
          }

          const courses = result.data;
          console.log('✅ 获取到课程数据:', courses.length, '个课程');

          // 过滤出学生已注册的活跃课程
          const enrolledCourses = courses.filter(course =>
            (course.status === 'active' || course.status === '已发布') &&
            course.enrolled_students &&
            course.enrolled_students.includes(currentUser.id.toString())
          );

          console.log('✅ 学生已报名课程:', enrolledCourses.length, '个');

          // 预先获取翻译文本，避免在模板字符串中this上下文问题
          const courseTranslations = {
            myCourses: typeof t === 'function' ? t('myCourses') : '我的课程',
            totalCoursesWithCount: typeof t === 'function' ? t('totalCoursesWithCount') : '共 {count} 门课程'
          };

          pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white" data-i18n="myCourses">${courseTranslations.myCourses}</h2>
                <span class="text-gray-400 i18n-dynamic" data-i18n-template="totalCoursesWithCount" data-count="${enrolledCourses.length}">${courseTranslations.totalCoursesWithCount.replace('{count}', enrolledCourses.length)}</span>
              </div>

              <div class="glass-effect rounded-lg p-6">
                <div class="space-y-4">
                  ${enrolledCourses.length > 0 ? enrolledCourses.map(course => `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <h3 class="text-lg font-semibold text-white">${course.title}</h3>
                          <p class="text-sm text-gray-400">${course.description || this.getTranslationText('noDescription')}</p>
                          <div class="flex items-center space-x-4 mt-2 text-sm">
                            <span class="text-gray-400"><span data-i18n="teacher">教师</span>：${course.teacher_full_name || course.teacher_name || this.getTranslationText('unassigned')}</span>
                            <span class="text-gray-400"><span data-i18n="students">学生</span>：${course.current_students || 0}/${course.max_students || 0}</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-green-500 bg-opacity-20 text-green-400">
                              <span data-i18n="inProgress">${this.getTranslationText('inProgress')}</span>
                            </span>
                          </div>
                        </div>
                        <button onclick="window.app.viewCourseDetail('${course.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm">
                          <span data-i18n="viewDetails">${this.getTranslationText('viewDetails')}</span>
                        </button>
                      </div>
                    </div>
                  `).join('') : `<p class="text-gray-400 text-center py-8" data-i18n="noAvailableCourses">${this.getTranslationText('noAvailableCourses')}</p>`}
                </div>
              </div>
            </div>
          `;

        } catch (error) {
          console.error('❌ 加载学生课程页面失败:', error);
          pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="text-center py-8">
                <p class="text-red-400">${this.getTranslationText('loadCoursesFailed')}: ${error.message}</p>
                <button onclick="window.app.loadStudentCoursesPage()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  ${this.getTranslationText('retry')}
                </button>
              </div>
            </div>
          `;
        }
      }

      /**
       * 加载教师学生管理页面
       */
      async loadTeacherStudentsPage() {
        // 安全获取翻译文本的辅助函数
        const t = (key, fallback = key) => {
          try {
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            if (i18n && i18n.translations && i18n.currentLanguage) {
              const translation = i18n.translations[i18n.currentLanguage][key];
              if (translation) return translation;
            }
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;
        const courses = await this.getAllCourses();

        // 使用API获取学生数据而不是localStorage
        let students = [];
        try {
          const allUsers = await this.getAllUsers();
          students = allUsers.filter(user => user.role === 'student');
          console.log('🔍 获取到的学生数量:', students.length);
        } catch (error) {
          console.error('获取学生列表失败:', error);
          students = [];
        }

        // 获取当前教师负责的课程
        console.log('🔍 [loadTeacherStudentsPage] 调试信息:');
        console.log('🔍 所有课程数量:', courses.length);
        console.log('🔍 当前用户ID:', currentUser.id, '类型:', typeof currentUser.id);
        console.log('🔍 所有课程:', courses.map(c => ({
          id: c.id,
          title: c.title,
          teacher_id: c.teacher_id,
          teacher_id_type: typeof c.teacher_id,
          enrolled_students: c.enrolled_students
        })));

        const teacherCourses = courses.filter(course => {
          const teacherIdMatch = String(course.teacherId) === String(currentUser.id);
          console.log('🔍 课程过滤检查:', {
            courseId: course.id,
            courseTitle: course.title,
            courseTeacherId: course.teacherId,
            courseTeacherIdType: typeof course.teacher_id,
            currentUserId: currentUser.id,
            currentUserIdType: typeof currentUser.id,
            teacherIdMatch
          });
          return teacherIdMatch;
        });

        // 获取这些课程的学生列表
        const teacherStudentIds = new Set();
        teacherCourses.forEach(course => {
          console.log('🔍 处理课程:', course.title, 'ID:', course.id);
          console.log('🔍 课程enrolled_students:', course.enrolledStudents);
          console.log('🔍 课程enrolledStudents:', course.enrolledStudents);

          // 从enrolled_students获取学生列表
          if (course.enrolledStudents && course.enrolledStudents.length > 0) {
            course.enrolledStudents.forEach(studentId => {
              teacherStudentIds.add(studentId);
              console.log('🔍 添加学生ID到集合:', studentId);
            });
          }
          // 也检查enrolledStudents字段（API可能返回这个字段）
          else if (course.enrolledStudents && course.enrolledStudents.length > 0) {
            course.enrolledStudents.forEach(studentId => {
              teacherStudentIds.add(String(studentId));
              console.log('🔍 添加学生ID到集合(从enrolledStudents):', studentId);
            });
          }
        });

        console.log('🔍 收集到的学生ID集合:', Array.from(teacherStudentIds));
        console.log('🔍 所有学生列表:', students.map(s => ({ id: s.id, name: s.full_name, username: s.username })));

        const teacherStudents = students.filter(student => {
          const hasStudent = teacherStudentIds.has(String(student.id)) || teacherStudentIds.has(student.id);
          console.log('🔍 检查学生', student.full_name, 'ID:', student.id, '是否在集合中:', hasStudent);
          return hasStudent;
        });

        console.log('🔍 学生管理页面调试信息:');
        console.log('🔍 teacherCourses:', teacherCourses);
        console.log('🔍 teacherCourses.length:', teacherCourses.length);
        console.log('🔍 第一个课程详情:', teacherCourses[0]);
        console.log('🔍 最终筛选出的学生:', teacherStudents);

        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white" data-i18n="myStudents">我的学生</h2>
              <div class="text-sm text-gray-400">
                <span class="mr-4"><span data-i18n="responsibleCourses">负责课程</span>：${teacherCourses.length} <span data-i18n="coursesUnit">门</span></span>
                <span><span data-i18n="totalStudents">学生总数</span>：${teacherStudents.length} <span data-i18n="people">人</span></span>
              </div>
            </div>

            <div class="glass-effect rounded-lg p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4" data-i18n="myCourses">我的课程</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${teacherCourses.map(course => {
                  console.log('🔍 渲染课程:', course);
                  return `
                  <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4 cursor-pointer hover:bg-opacity-40 transition-all" onclick="window.app.editCourseDescription(${course.id}, '${course.title || course.name || '未命名课程'}', '${(course.description || '').replace(/'/g, "\\'")}')">
                    <h4 class="font-medium text-white">${course.title || course.name || t('unnamedCourse')}</h4>
                    <p class="text-xs text-gray-500 mt-1" id="course-desc-${course.id}">
                      ${course.description || '<span class="text-gray-600 italic">' + t('clickToAddDescription') + '</span>'}
                    </p>
                    <p class="text-sm text-gray-400 mt-1"><span data-i18n="students">学生</span>：${(course.enrolled_count && course.enrolled_count !== '') ? course.enrolled_count : (course.enrolledCount || 0)} <span data-i18n="people">人</span></p>
                  </div>
                `;
                }).join('') || '<p class="text-gray-400">暂无负责的课程</p>'}
              </div>
            </div>

            <div class="glass-effect rounded-lg p-6">
              <div class="mb-4">
                <div class="flex items-center space-x-4">
                  <input type="text" id="teacher-student-search" placeholder="${t('searchStudents', '搜索学生...')}" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white flex-1">
                  <select id="teacher-student-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="all">${t('allStatus', '全部状态')}</option>
                    <option value="active">${t('active', '活跃')}</option>
                    <option value="inactive">${t('inactive', '未激活')}</option>
                  </select>
                </div>
              </div>

              <div class="space-y-2">
                ${teacherStudents.length > 0 ? teacherStudents.map(student => {
                  const studentCourses = teacherCourses.filter(course =>
                    course.enrolledStudents && course.enrolledStudents.includes(String(student.id))
                  );
                  return `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-3">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                          <!-- 姓名 -->
                          <h3 class="text-base font-semibold text-white whitespace-nowrap">${student.full_name || student.username}</h3>

                          <!-- 基本信息 -->
                          <div class="flex items-center space-x-2 text-xs text-gray-400 flex-1 min-w-0">
                            ${student.student_id ? `<span>${t('studentId')}: ${student.student_id}</span>` : ''}
                            ${student.major ? `<span>${t('major')}: ${student.major}</span>` : ''}
                            ${student.class ? `<span>${t('class')}: ${student.class}</span>` : ''}
                          </div>

                          <!-- 课程标签 -->
                          <div class="flex flex-wrap gap-1">
                            ${studentCourses.map(course =>
                              `<span class="px-2 py-1 text-xs bg-blue-500 bg-opacity-20 text-blue-400 rounded-full whitespace-nowrap">${course.title || course.name || '未命名课程'}</span>`
                            ).join('')}
                          </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="flex items-center space-x-2 ml-3">
                          ${student.is_active || student.isActive ? '<span class="px-2 py-1 text-xs bg-green-500 bg-opacity-20 text-green-400 rounded-full whitespace-nowrap">' + t('active', '活跃') + '</span>' : '<span class="px-2 py-1 text-xs bg-gray-500 bg-opacity-20 text-gray-400 rounded-full whitespace-nowrap">' + t('inactive', '未激活') + '</span>'}
                          <button onclick="window.app.viewStudentProgress('${student.id}')" class="p-1.5 text-blue-400 hover:bg-blue-500 hover:bg-opacity-20 rounded-lg transition-colors" title="查看作业完成情况">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('') : '<p class="text-gray-400 text-center py-8">暂无学生数据</p>'}
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 编辑课程描述
       */
      async editCourseDescription(courseId, courseTitle, currentDescription) {
        // 安全获取翻译文本
        const t = (key, fallback = key) => {
          try {
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">${t('editCourseDescription', '编辑课程描述')}</h3>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">${t('courseName', '课程名称')}</label>
              <input type="text" value="${courseTitle}" disabled class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-400">
            </div>
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-300 mb-2">${t('description', '描述')}</label>
              <textarea id="course-description-input" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="${t('enterCourseDescription', '请输入课程描述')}">${currentDescription}</textarea>
            </div>
            <div class="flex justify-end space-x-3">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                ${t('cancel', '取消')}
              </button>
              <button onclick="window.app.saveCourseDescription(${courseId}, this)" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                ${t('save', '保存')}
              </button>
            </div>
          </div>
        `;

        // 添加到页面并聚焦
        document.body.appendChild(modal);
        document.getElementById('course-description-input').focus();
        document.getElementById('course-description-input').select();

        // 点击外部关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // ESC键关闭
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      }

      /**
       * 保存课程描述
       */
      async saveCourseDescription(courseId, buttonElement) {
        const t = (key, fallback = key) => {
          try {
            if (window.i18n && window.i18n.translations && window.i18n.currentLanguage) {
              const translation = window.i18n.translations[window.i18n.currentLanguage][key];
              if (translation) return translation;
            }
            const currentLang = localStorage.getItem('language') || 'zh';
            if (i18n && i18n.translations && i18n.translations[currentLang]) {
              const translation = i18n.translations[currentLang][key];
              if (translation) return translation;
            }
          } catch (error) {
            console.warn('Translation error for key:', key, error);
          }
          return fallback;
        };

        const descriptionInput = document.getElementById('course-description-input');
        const newDescription = descriptionInput.value.trim();

        // 禁用按钮并显示加载状态
        const originalText = buttonElement.textContent;
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>';

        try {
          const response = await fetch(`http://localhost:5025/api/courses/${courseId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              description: newDescription
            })
          });

          const result = await response.json();

          if (result.success) {
            // 更新页面上的描述显示
            const descElement = document.getElementById(`course-desc-${courseId}`);
            if (descElement) {
              if (newDescription) {
                descElement.innerHTML = newDescription;
              } else {
                descElement.innerHTML = `<span class="text-gray-600 italic">${t('clickToAddDescription', '点击添加描述')}</span>`;
              }
            }

            // 显示成功消息
            this.showNotification(t('descriptionSaved', '描述已保存'), 'success');

            // 关闭模态框
            buttonElement.closest('.fixed').remove();
          } else {
            throw new Error(result.message || '保存失败');
          }
        } catch (error) {
          console.error('保存课程描述失败:', error);
          this.showNotification(t('saveDescriptionFailed', '保存描述失败') + ': ' + error.message, 'error');
        } finally {
          // 恢复按钮状态
          buttonElement.disabled = false;
          buttonElement.textContent = originalText;
        }
      }

      /**
       * 查看学生进度
       */
      async viewStudentProgress(studentId) {
        const students = this.getAllStudentsSync();
        const assignments = this.getAllAssignments();
        const courses = await this.getAllCourses();
        const currentUser = this.currentUser;

        const student = students.find(s => s.id === studentId);
        if (!student) return;

        // 获取当前教师的课程
        const teacherCourses = courses.filter(course =>
          course.teacherId === currentUser.id || course.teacherName === currentUser.fullName
        );

        // 获取该学生在教师课程中的作业
        const studentAssignments = assignments.filter(assignment =>
          teacherCourses.some(course => course.id === assignment.courseId) &&
          assignment.assignedStudents?.includes(studentId)
        );

        const pageContent = document.getElementById('page-content');
        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center space-x-4 mb-6">
              <button onclick="window.app.navigateToPage('students')" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <h2 class="text-2xl font-bold text-white">${student.fullName} 的学习进度</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">基本信息</h3>
                <div class="space-y-3">
                  <div>
                    <span class="text-gray-400">姓名：</span>
                    <span class="text-white">${student.fullName}</span>
                  </div>
                  <div>
                    <span class="text-gray-400">${t('studentId')}:</span>
                    <span class="text-white">${student.studentId}</span>
                  </div>
                  <div>
                    <span class="text-gray-400">${t('major')}:</span>
                    <span class="text-white">${student.major}</span>
                  </div>
                  <div>
                    <span class="text-gray-400">${t('grade')}:</span>
                    <span class="text-white">${student.grade}</span>
                  </div>
                  <div>
                    <span class="text-gray-400">邮箱：</span>
                    <span class="text-white">${student.email}</span>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">作业统计</h3>
                <div class="space-y-3">
                  <div>
                    <span class="text-gray-400">总作业数：</span>
                    <span class="text-white">${studentAssignments.length}</span>
                  </div>
                  <div>
                    <span class="text-gray-400">已提交：</span>
                    <span class="text-green-400">0</span>
                  </div>
                  <div>
                    <span class="text-gray-400">待完成：</span>
                    <span class="text-yellow-400">${studentAssignments.length}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="glass-effect rounded-lg p-6 mt-6">
              <h3 class="text-lg font-semibold text-white mb-4" data-i18n="assignmentList">${this.getTranslationText('assignmentList')}</h3>

              <div class="space-y-4">
                ${studentAssignments.length > 0 ? studentAssignments.map(assignment => {
                  const course = teacherCourses.find(c => c.id === assignment.courseId);
                  const deadline = assignment.deadline && assignment.deadline !== 'Invalid Date' ? new Date(assignment.deadline) : null;
                  return `
                    <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="font-medium text-white">${assignment.title || '未命名作业'}</h4>
                          <p class="text-sm text-gray-400">${course?.title || assignment.courseName || '未分配课程'}</p>
                          <p class="text-xs text-gray-500"><span data-i18n="deadline">截止</span>：${deadline ? deadline.toLocaleDateString() : '未设置'}</p>
                        </div>
                        <span class="px-3 py-1 text-xs rounded-full bg-yellow-500 bg-opacity-20 text-yellow-400">
                          <span data-i18n="pending">${this.getTranslationText('pending') || '待完成'}</span>
                        </span>
                      </div>
                    </div>
                  `;
                }).join('') : `<p class="text-gray-400 text-center py-4">${this.getTranslationText('studentHasNoAssignments')}</p>`}
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 加载学生作业页面
       */
      async loadStudentAssignmentsPage() {
        const pageContent = document.getElementById('page-content');
        const currentUser = this.currentUser;

        console.log('🔍 从数据库获取学生作业数据...');

        try {
          // 使用API获取作业和课程数据
          const [assignmentsResponse, coursesResponse] = await Promise.all([
            fetch('http://localhost:5025/api/assignments'),
            fetch('http://localhost:5025/api/courses')
          ]);

          const assignmentsResult = await assignmentsResponse.json();
          const coursesResult = await coursesResponse.json();

          if (!assignmentsResult.success || !coursesResult.success) {
            throw new Error('获取数据失败');
          }

          const allAssignments = assignmentsResult.data;
          const courses = coursesResult.data;

          console.log('✅ 获取到作业数据:', allAssignments.length, '个作业');
          console.log('✅ 获取到课程数据:', courses.length, '个课程');

          // 获取学生已报名的课程
          const studentCourses = courses.filter(course =>
            course.enrolled_students && course.enrolled_students.includes(currentUser.id.toString())
          );
          const studentCourseIds = studentCourses.map(course => course.id);

          console.log('✅ 学生已报名课程:', studentCourses.length, '个');
          console.log('✅ 学生课程IDs:', studentCourseIds);

          // 过滤出学生应该看到的作业（来自已报名课程的作业，并且是已发布的）
          const studentAssignments = allAssignments.filter(assignment =>
            studentCourseIds.includes(assignment.course_id) && assignment.is_published
          );

          console.log('✅ 学生可见作业:', studentAssignments.length, '个');

          // 预先获取翻译文本，避免在模板字符串中this上下文问题
          const studentTranslations = {
            myAssignments: typeof t === 'function' ? t('myAssignments') : '我的作业',
            totalAssignments: typeof t === 'function' ? t('totalAssignments') : '共 {count} 个作业',
            inProgress: typeof t === 'function' ? t('inProgress') : '进行中',
            ended: typeof t === 'function' ? t('ended') : '已结束',
            expired: typeof t === 'function' ? t('expired') : '已过期',
            startAssignment: typeof t === 'function' ? t('startAssignment') : '开始作业'
          };

          pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white" data-i18n="myAssignments">${studentTranslations.myAssignments}</h2>
                <span class="text-gray-400 i18n-dynamic" data-i18n-template="totalAssignments" data-count="${studentAssignments.length}">${studentTranslations.totalAssignments.replace('{count}', studentAssignments.length)}</span>
              </div>


              <div class="glass-effect rounded-lg p-6">
                <div class="space-y-4">
                  ${studentAssignments.length > 0 ? studentAssignments.map(assignment => {
                    const course = courses.find(c => c.id === assignment.course_id);
                    const deadline = assignment.end_time && assignment.end_time !== 'Invalid Date' ? new Date(assignment.end_time) : null;
                    const now = new Date();
                    const isOverdue = deadline ? deadline < now : false;

                    return `
                      <div class="bg-gray-700 bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                          <div class="flex-1">
                            <h3 class="text-lg font-semibold text-white">${assignment.title || '未命名作业'}</h3>
                            <p class="text-sm text-gray-400">${assignment.description || '无描述'}</p>
                            <div class="flex items-center space-x-4 mt-2 text-sm">
                              <span class="text-gray-400"><span data-i18n="course">课程</span>：${course?.title || assignment.course_title || '未分配'}</span>
                              <span class="text-gray-400"><span data-i18n="teacher">教师</span>：${assignment.teacher_full_name || assignment.teacher_name || '未分配'}</span>
                              <span class="${isOverdue ? 'text-red-400' : 'text-gray-400'}">
                                <span data-i18n="deadline">截止</span>：${deadline ? deadline.toLocaleDateString() : '未设置'}
                              </span>
                              <span class="px-2 py-1 text-xs rounded-full ${assignment.is_published ? 'bg-blue-500 bg-opacity-20 text-blue-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}">
                                <span data-i18n="${assignment.is_published ? 'inProgress' : 'ended'}">${assignment.is_published ? studentTranslations.inProgress : studentTranslations.ended}</span>
                              </span>
                            </div>
                          </div>
                          <button onclick="window.app.startAssignment('${assignment.id}')" class="px-4 py-2 ${isOverdue ? 'bg-gray-500' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg transition-colors text-sm">
                            ${isOverdue ? studentTranslations.expired : studentTranslations.startAssignment}
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('') :
                    (studentCourses.length > 0 ?
                      `<p class="text-gray-400 text-center py-8" data-i18n="noAssignments">${this.getTranslationText('noAssignments')}</p>` :
                      `<p class="text-gray-400 text-center py-8" data-i18n="noEnrolledCourses">${this.getTranslationText('noEnrolledCourses')}</p>`
                    )
                  }
                </div>
              </div>
            </div>
          `;

        } catch (error) {
          console.error('❌ 加载学生作业页面失败:', error);
          pageContent.innerHTML = `
            <div class="animate-fade-in-up">
              <div class="text-center py-8">
                <p class="text-red-400">加载作业失败: ${error.message}</p>
                <button onclick="window.app.loadStudentAssignmentsPage()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  重试
                </button>
              </div>
            </div>
          `;
        }
      }

      /**
       * 查看课程详情
       */
      async viewCourseDetail(courseId) {
        const courses = await this.getAllCourses();
        const course = courses.find(c => c.id === courseId);
        if (!course) return;

        const pageContent = document.getElementById('page-content');
        pageContent.innerHTML = `
          <div class="animate-fade-in-up">
            <div class="flex items-center space-x-4 mb-6">
              <button onclick="window.app.navigateToPage('courses')" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <h2 class="text-2xl font-bold text-white">${course.title}</h2>
            </div>

            <div class="glass-effect rounded-lg p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 class="text-lg font-semibold text-white mb-4" data-i18n="courseInfo">课程信息</h3>
                  <div class="space-y-3">
                    <div>
                      <span class="text-gray-400" data-i18n="courseCode">课程代码：</span>
                      <span class="text-white">${course.code}</span>
                    </div>
                    <div>
                      <span class="text-gray-400" data-i18n="courseTeacher">授课教师：</span>
                      <span class="text-white">${course.teacherName || this.getTranslationText('unassigned')}</span>
                    </div>
                    <div>
                      <span class="text-gray-400" data-i18n="courseDescription">课程描述：</span>
                      <p class="text-white mt-2">${course.description}</p>
                    </div>
                    <div>
                      <span class="text-gray-400" data-i18n="courseStatus">课程状态：</span>
                      <span class="px-2 py-1 text-xs rounded-full ${course.status === 'active' || course.status === '已发布' ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-gray-500 bg-opacity-20 text-gray-400'}">
                        ${course.status === 'active' || course.status === '已发布' ? this.getTranslationText('inProgress') : this.getTranslationText('ended')}
                      </span>
                    </div>
                  </div>
                </div>

                <div>
                  <h3 class="text-lg font-semibold text-white mb-4" data-i18n="statistics">统计信息</h3>
                  <div class="space-y-3">
                    <div>
                      <span class="text-gray-400" data-i18n="enrolledStudents">已选学生：</span>
                      <span class="text-white">${course.enrolledStudents?.length || 0} / ${course.maxStudents || 0}</span>
                    </div>
                    <div>
                      <span class="text-gray-400" data-i18n="createdAt">${this.getTranslationText('createdAt')}</span>：
                      <span class="text-white">${new Date(course.createdAt).toLocaleDateString()}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-6 pt-6 border-t border-gray-700">
                <button onclick="window.app.navigateToPage('assignments')" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" data-i18n="viewRelatedAssignments">
                  ${this.getTranslationText('viewRelatedAssignments')}
                </button>
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 开始作业
       */
      startAssignment(assignmentId) {
        try {
          // 设置返回页面信息为学生作业页面
          localStorage.setItem('editor-return-page', 'student-assignments');
          // 学生点击"开始作业"时，跳转到在线编译器页面
          // 在线编译器通过 URL 参数 assignment 进入作业模式
          window.location.href = 'editor.html?assignment=' + encodeURIComponent(assignmentId);
        } catch (error) {
          console.error('跳转到作业编辑器失败:', error);
          alert('无法打开作业编辑器，请稍后重试');
        }
      }

      /**
       * 教师在编辑器中查看学生作业
       */
      openSubmissionInEditor(assignmentId, studentId) {
        try {
          const url = 'editor.html?assignment=' +
            encodeURIComponent(assignmentId) +
            '&student=' + encodeURIComponent(studentId) +
            '&mode=review';
          window.open(url, '_blank');
        } catch (error) {
          console.error('打开学生作业失败:', error);
          alert('无法打开学生作业，请稍后重试');
        }
      }

      /**
       * 在在线文档查看器中打开学生提交
       */
      openSubmissionInViewer(submissionId) {
        try {
          const url = `submission-viewer.html?submission=${encodeURIComponent(submissionId)}`;
          window.open(url, '_blank');
        } catch (error) {
          console.error('打开在线文档失败:', error);
          alert('无法打开在线文档，请稍后重试');
        }
      }

      /**
       * 在编辑器中打开代码库案例
       */
      openRepoInEditor(repoId) {
        try {
          const items = this.getAllCodeRepositoryItems();
          const repo = items.find(item => item.id === repoId);
          if (!repo) {
            alert('未找到该代码案例');
            return;
          }

          // 设置返回页面信息并直接在当前窗口打开编辑器
          localStorage.setItem('editor-return-page', 'code-repository');
          localStorage.setItem('oj-current-repo-open', JSON.stringify(repo));
          window.location.href = 'editor.html';
        } catch (error) {
          console.error('打开代码案例失败:', error);
          alert('无法打开代码案例，请稍后重试');
        }
      }

      setupProfileForm() {
        try {
          const form = document.getElementById('profile-edit-form');
          const cancelBtn = document.getElementById('cancel-edit-btn');

          if (form) {
            form.addEventListener('submit', (e) => {
              e.preventDefault();
              this.saveProfileData();
            });
          }

          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
              this.navigateToPage('profile');
            });
          }

        } catch (error) {
          console.error('设置个人资料表单失败:', error);
        }
      }

      showProfileMessage(message, type = 'info') {
        // 移除之前的消息
        const existingMessage = document.getElementById('profile-message');
        if (existingMessage) {
          existingMessage.remove();
        }

        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.id = 'profile-message';
        messageDiv.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0`;

        // 根据类型设置样式
        const styles = {
          success: 'bg-green-500 text-white',
          error: 'bg-red-500 text-white',
          warning: 'bg-yellow-500 text-white',
          info: 'bg-blue-500 text-white'
        };

        messageDiv.className += ` ${styles[type] || styles.info}`;
        messageDiv.innerHTML = `
          <div class="flex items-center space-x-2">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        `;

        // 添加到页面
        document.body.appendChild(messageDiv);

        // 自动消失（成功消息3秒，错误消息5秒）
        const timeout = type === 'success' ? 3000 : 5000;
        setTimeout(() => {
          if (messageDiv && messageDiv.parentNode) {
            messageDiv.style.transform = 'translateX(400px)';
            setTimeout(() => {
              if (messageDiv && messageDiv.parentNode) {
                messageDiv.remove();
              }
            }, 300);
          }
        }, timeout);
      }

      saveProfileData() {
        console.log('🔧 开始保存个人资料...');

        try {
          // 检查当前用户
          const currentUserStr = sessionStorage.getItem('current-user');
          console.log('📋 当前用户数据:', currentUserStr);

          if (!currentUserStr) {
            console.error('❌ 未找到当前用户信息');
            this.showProfileMessage('用户信息丢失，请重新登录', 'error');
            return;
          }

          const currentUser = JSON.parse(currentUserStr);
          console.log('👤 解析后的用户信息:', currentUser);

          // 检查必需的DOM元素
          const nameInput = document.getElementById('edit-name');
          const emailInput = document.getElementById('edit-email');
          const phoneInput = document.getElementById('edit-phone');
          const bioInput = document.getElementById('edit-bio');

          console.log('🔍 DOM元素检查:');
          console.log('- edit-name:', nameInput);
          console.log('- edit-email:', emailInput);
          console.log('- edit-phone:', phoneInput);
          console.log('- edit-bio:', bioInput);

          if (!nameInput || !emailInput) {
            console.error('❌ 缺少必需的DOM元素');
            this.showProfileMessage('页面表单元素缺失，请刷新页面重试', 'error');
            return;
          }

          // 收集表单数据
          const updatedData = {
            ...currentUser,
            fullName: nameInput.value.trim(),
            email: emailInput.value.trim(),
            phone: phoneInput ? phoneInput.value.trim() : '',
            bio: bioInput ? bioInput.value.trim() : ''
          };

          console.log('📝 收集的表单数据:', updatedData);

          // 添加角色特定字段
          if (currentUser.role === 'student') {
            console.log('🎓 处理学生特定字段');
            const studentIdInput = document.querySelector('input[placeholder="请输入学号"]');
            if (studentIdInput) {
              updatedData.studentId = studentIdInput.value.trim();
              console.log('- 学号:', updatedData.studentId);
            }
            const majorInput = document.getElementById('edit-major');
            if (majorInput) {
              updatedData.major = majorInput.value.trim();
              console.log('- 专业:', updatedData.major);
            }
          } else if (currentUser.role === 'teacher') {
            console.log('👨‍🏫 处理教师特定字段');
            const teacherIdInput = document.getElementById('edit-teacher-id');
            if (teacherIdInput) {
              updatedData.teacherId = teacherIdInput.value.trim();
              console.log('- 教师工号:', updatedData.teacherId);
            }
            const departmentInput = document.getElementById('edit-department');
            if (departmentInput) {
              updatedData.department = departmentInput.value.trim();
              console.log('- 部门:', updatedData.department);
            }
          }

          // 验证必填字段
          if (!updatedData.fullName || !updatedData.email) {
            console.error('❌ 缺少必填字段:', { fullName: updatedData.fullName, email: updatedData.email });
            this.showProfileMessage('请填写姓名和邮箱地址！', 'error');
            return;
          }

          // 验证邮箱格式
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(updatedData.email)) {
            console.error('❌ 邮箱格式无效:', updatedData.email);
            this.showProfileMessage('请输入有效的邮箱地址！', 'error');
            return;
          }

          console.log('💾 开始保存数据...');

          // 更新localStorage
          localStorage.setItem('oj-current-user', JSON.stringify(updatedData));
          console.log('✅ 当前用户信息已保存到localStorage');

          // 更新用户列表
          const userKey = currentUser.role === 'student' ? 'oj-students' : 'oj-teachers';
          console.log('📚 用户列表key:', userKey);

          const users = JSON.parse(localStorage.getItem(userKey) || '[]');
          console.log('👥 用户列表长度:', users.length);

          const userIndex = users.findIndex(u => u.id === currentUser.id);
          console.log('🔎 用户在列表中的索引:', userIndex);

          if (userIndex !== -1) {
            users[userIndex] = updatedData;
            localStorage.setItem(userKey, JSON.stringify(users));
            console.log('✅ 用户列表已更新');
          } else {
            console.warn('⚠️ 在用户列表中未找到当前用户');
          }

          // 更新页面显示
          if (typeof this.updateUserInfo === 'function') {
            this.updateUserInfo(updatedData);
            console.log('✅ 页面用户信息已更新');
          }

          // 显示成功消息
          this.showProfileMessage('个人资料更新成功！', 'success');

          // 延迟刷新页面，让用户看到成功提示
          setTimeout(() => {
            console.log('🔄 刷新个人资料页面...');
            this.navigateToPage('profile');
          }, 1500);

        } catch (error) {
          console.error('❌ 保存个人资料失败:', error);
          console.error('❌ 错误堆栈:', error.stack);
          this.showProfileMessage('保存失败：' + error.message + '，请稍后重试！', 'error');
        }
      }

      /**
       * 以代码库案例为模板创建作业
       */
      createAssignmentFromRepo(repoId) {
        try {
          const items = this.getAllCodeRepositoryItems();
          const repo = items.find(item => item.id === repoId);
          if (!repo) {
            alert('未找到该代码案例');
            return;
          }

          this.currentAssignmentTemplate = repo;
          localStorage.setItem('oj-current-assignment-template', JSON.stringify(repo));
          this.showCreateAssignmentModal();
        } catch (error) {
          console.error('基于案例创建作业失败:', error);
          alert('创建作业失败：' + error.message);
        }
      }

      /**
       * 初始化主题切换功能
       */
      initThemeToggle() {
        const themeToggleBtn = document.getElementById('main-theme-toggle');
        if (!themeToggleBtn) return;

        // 简单的主题切换
        themeToggleBtn.onclick = function() {
          document.body.classList.toggle('light-theme');
          const isLight = document.body.classList.contains('light-theme');
          localStorage.setItem('theme', isLight ? 'light' : 'dark');
        };

        // 恢复保存的主题
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
          document.body.classList.add('light-theme');
        }
      }

      /**
       * 绑定事件
       */
      bindEvents() {
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
          this.logout();
          window.location.href = 'login.html';
        });
      }
    }

    // 用户认证检查 - 必须在应用初始化之前执行
    function checkUserAuth() {
      try {
        // 优先检查 sessionStorage 中的 current-user
        let userStr = sessionStorage.getItem('current-user');

        // 如果 sessionStorage 中没有，检查 localStorage 中的多个存储位置
        if (!userStr) {
          userStr = localStorage.getItem('currentUser') || localStorage.getItem('oj-current-user');
          if (userStr) {
            // 同步到 sessionStorage 以保持一致性
            sessionStorage.setItem('current-user', userStr);
            console.log('✅ 从 localStorage 恢复用户信息到 sessionStorage');
          }
        }

        // 如果仍然没有用户信息，检查 URL 参数
        if (!userStr) {
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('userId');
          const userName = urlParams.get('userName');
          const userRole = urlParams.get('userRole');
          const fullName = urlParams.get('fullName');

          if (userId && userName && userRole) {
            const user = {
              id: userId,
              username: userName,
              role: userRole,
              fullName: decodeURIComponent(fullName || userName)
            };
            userStr = JSON.stringify(user);
            // 保存到所有存储位置以保持一致性
            sessionStorage.setItem('current-user', userStr);
            localStorage.setItem('currentUser', userStr);
            console.log('✅ 从 URL 参数恢复用户信息:', user.fullName);
          }
        }

        if (!userStr) {
          console.log('🔒 用户未登录，跳转到登录页面');
          window.location.href = 'login.html';
          return false;
        }

        const user = JSON.parse(userStr);
        console.log('✅ 用户已登录:', user.fullName, `(${user.role})`);

        // 验证用户数据的完整性
        if (!user.id || !user.username || !user.role) {
          console.log('❌ 用户数据不完整，清除并跳转登录');
          sessionStorage.removeItem('current-user');
          window.location.href = 'login.html';
          return false;
        }

        // 清理 URL 参数，保持页面整洁
        if (window.location.search) {
          const cleanUrl = window.location.pathname + window.location.hash;
          window.history.replaceState({}, document.title, cleanUrl);
        }

        return true;
      } catch (error) {
        console.error('❌ 用户认证检查失败:', error);
        sessionStorage.removeItem('current-user');
        window.location.href = 'login.html';
        return false;
      }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
      // 首先检查用户认证
      if (!checkUserAuth()) {
        return; // 如果未登录，已经跳转，不需要继续初始化
      }

      const app = new OnlineJudgeApp();
      app.init();
      window.app = app; // 暴露到全局供调试使用
      
      // 监听全局设置变化
      window.addEventListener('themeChanged', (e) => {
        const theme = e.detail?.theme;
        if (theme) {
          document.documentElement.classList.toggle('dark', theme === 'dark');
          const themeIcon = document.querySelector('#theme-toggle-btn i') || document.querySelector('.theme-toggle i');
          if (themeIcon) {
            themeIcon.className = theme === 'dark' ? 'lucide-moon' : 'lucide-sun';
          }
          console.log('Theme synced from global settings:', theme);
        }
      });
      
      window.addEventListener('languageChanged', (e) => {
        const lang = e.detail?.language;
        if (lang && ['zh', 'en'].includes(lang)) {
          i18n.setLanguage(lang);
          console.log('Language synced from global settings:', lang);
        }
      });

      // 强制清除所有缓存并测试API连接
      setTimeout(async () => {
        console.log('🔥 页面加载完成，强制清除缓存...');

        // 清除所有相关缓存
        localStorage.removeItem('oj-courses');
        localStorage.removeItem('oj-students');
        localStorage.removeItem('oj-users');
        localStorage.removeItem('oj-assignments');
        console.log('🗑️ 已清除所有缓存数据');

        try {
          console.log('🔥 开始测试API...');
          const response = await fetch('http://localhost:5025/api/courses');
          console.log('🔥 API响应状态:', response.status);
          const data = await response.json();
          console.log('🔥 API完整响应:', data);

          if (data.success && data.data) {
            console.log('🔥 成功获取课程数据，数量:', data.data.length);
            data.data.forEach((course, index) => {
              console.log(`🔥 课程${index + 1}:`, {
                id: course.id,
                title: course.title,
                teacher_full_name: course.teacher_full_name,
                teacher_name: course.teacherName,
                enrolled_students_count: course.enrolledStudents_count
              });
            });
          } else {
            console.error('🔥 API返回失败:', data);
          }
        } catch (error) {
          console.error('🔥 API测试失败:', error);
        }
      }, 1000); // 延迟1秒执行，确保页面完全加载
    });

    // 启动 markviz-presenter 函数
    async function startMarkvizPresenter() {
      const button = event.target.closest('button');
      const originalText = button.innerHTML;

      // 显示加载状态
      button.innerHTML = '<i class="lucide-loader-2 animate-spin"></i> <span class="text-sm font-medium">启动中...</span>';
      button.disabled = true;

      try {
        // 首先检查 markviz-presenter 是否已经在运行
        const response = await fetch('http://localhost:3000').catch(() => null);

        if (response) {
          // 如果已经在运行，直接打开
          window.open('http://localhost:3000', '_blank');
        } else {
          // 调用后端 API 启动 markviz-presenter
          const startResponse = await fetch('http://localhost:5025/api/start-markviz', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (startResponse.ok) {
            const result = await startResponse.json();

            // 等待服务器启动
            let retryCount = 0;
            const maxRetries = 30;

            const checkServer = async () => {
              try {
                const testResponse = await fetch('http://localhost:3000');
                if (testResponse.ok) {
                  // 服务器已启动，打开页面
                  window.open('http://localhost:3000', '_blank');
                } else if (retryCount < maxRetries) {
                  retryCount++;
                  setTimeout(checkServer, 1000);
                } else {
                  alert('启动超时，请手动检查控制台');
                }
              } catch (e) {
                if (retryCount < maxRetries) {
                  retryCount++;
                  setTimeout(checkServer, 1000);
                } else {
                  alert('启动失败，请确保 Node.js 已安装');
                }
              }
            };

            checkServer();
          } else {
            throw new Error('启动请求失败');
          }
        }
      } catch (error) {
        console.error('启动 markviz-presenter 失败:', error);

        // 回退方案：尝试直接打开 markviz-presenter 目录
        const fallback = window.confirm('无法自动启动，是否手动打开 markviz-presenter 目录？');
        if (fallback) {
          window.location.href = 'markviz-presenter/';
        }
      } finally {
        // 恢复按钮状态
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }
  </script>

  <!-- Markdown文件选择模态框 -->
  <div id="markdown-file-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
    <div class="bg-gray-900 rounded-xl p-5 w-full max-w-md shadow-2xl border border-gray-700">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-white mb-2 text-center">Markdown编辑器</h3>
        <p class="text-sm text-gray-400 text-center">选择文件或创建新文档</p>
      </div>

      <!-- 之前的文件列表 -->
      <div id="saved-files-list" class="mb-4 max-h-60 overflow-y-auto">
        <!-- 动态加载已保存的Markdown文件 -->
      </div>

      <!-- 新建文件输入 -->
      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-200 mb-2">创建新文件</label>
        <input type="text" id="new-markdown-filename" placeholder="输入文件名（例如：我的文档.md）"
               class="w-full px-3 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white
               focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none transition-all">
      </div>

      <!-- 按钮组 -->
      <div class="flex justify-between pt-3 border-t border-gray-700">
        <button onclick="closeMarkdownFileSelector()"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-all font-medium">
          取消
        </button>
        <div class="space-x-3">
          <button onclick="importNewMarkdownFile()"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium">
            导入文件
          </button>
          <button onclick="createNewMarkdownFile()"
                  class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-all font-medium shadow-lg">
            创建新文件
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Markdown文件管理JavaScript -->
  <script>
    // 全局Markdown文件处理函数
    window.handleMarkdownFile = function(filePath, content = null) {
      // 如果是URL，先读取内容
      if (content === null && filePath.startsWith('blob:')) {
        fetch(filePath)
          .then(response => response.text())
          .then(text => {
            openMarkdownInEditor(text, filePath.split('/').pop() || 'untitled.md');
          })
          .catch(error => {
            console.error('读取Markdown文件失败:', error);
            alert('无法读取Markdown文件内容');
          });
      } else {
        openMarkdownInEditor(content || '', filePath.split('/').pop() || 'untitled.md');
      }
    };

    // 使用MarkViz编辑器打开Markdown文件
    function openMarkdownInEditor(content, filename) {
      // 存储到sessionStorage供编辑器使用
      sessionStorage.setItem('markdownEditorContent', content);
      sessionStorage.setItem('markdownEditorFilename', filename);

      // 打开编辑器
      window.open('http://localhost:3000', '_blank');
    }

    // 显示Markdown文件选择器
    function showMarkdownFileSelector() {
      const modal = document.getElementById('markdown-file-modal');
      const filesList = document.getElementById('saved-files-list');

      // 从localStorage获取已保存的Markdown文件
      const savedFiles = JSON.parse(localStorage.getItem('markdownFiles') || '{}');

      if (Object.keys(savedFiles).length > 0) {
        filesList.innerHTML = `
          <label class="block text-sm font-semibold text-gray-200 mb-2">之前的文件</label>
          <div class="space-y-2">
            ${Object.keys(savedFiles).map(filename => `
              <div class="flex items-center justify-between p-3 bg-gray-800 border border-gray-600 rounded-lg hover:bg-gray-700 transition-all">
                <div class="flex-1">
                  <div class="font-medium text-white text-sm">${filename}</div>
                  <div class="text-xs text-gray-400">${new Date(savedFiles[filename].timestamp).toLocaleString()}</div>
                </div>
                <button onclick="openSavedMarkdownFile('${filename}')"
                        class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-lg transition-all font-medium">
                  打开
                </button>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        filesList.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">暂无保存的文件</p>';
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // 关闭Markdown文件选择器
    function closeMarkdownFileSelector() {
      const modal = document.getElementById('markdown-file-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.getElementById('new-markdown-filename').value = '';
    }

    // 打开已保存的文件
    function openSavedMarkdownFile(filename) {
      const savedFiles = JSON.parse(localStorage.getItem('markdownFiles') || '{}');
      const fileData = savedFiles[filename];

      if (fileData) {
        // 调试信息
        console.log('Opening file:', filename);
        console.log('File content length:', fileData.content.length);
        console.log('File content preview:', fileData.content.substring(0, 100));

        // 将文件内容存储到sessionStorage中，供编辑器使用
        sessionStorage.setItem('markdownEditorContent', fileData.content);
        sessionStorage.setItem('markdownEditorFilename', filename);

        // 验证存储是否成功
        console.log('SessionStorage content length:', sessionStorage.getItem('markdownEditorContent')?.length);

        closeMarkdownFileSelector();

        // 打开编辑器
        window.open('http://localhost:3000', '_blank');
      } else {
        console.error('File not found:', filename);
        alert('文件未找到');
      }
    }

    // 导入新的Markdown文件
    function importNewMarkdownFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.md,.markdown,.txt';

      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = e.target.result;

            // 存储到localStorage
            const savedFiles = JSON.parse(localStorage.getItem('markdownFiles') || '{}');
            savedFiles[file.name] = {
              content: content,
              timestamp: Date.now()
            };
            localStorage.setItem('markdownFiles', JSON.stringify(savedFiles));

            // 将内容存储到sessionStorage供编辑器使用
            sessionStorage.setItem('markdownEditorContent', content);
            sessionStorage.setItem('markdownEditorFilename', file.name);

            closeMarkdownFileSelector();

            // 打开编辑器
            window.open('http://localhost:3000', '_blank');
          };
          reader.readAsText(file);
        }
      };

      input.click();
    }

    // 创建新的Markdown文件
    function createNewMarkdownFile() {
      const filename = document.getElementById('new-markdown-filename').value.trim();

      if (!filename) {
        alert('请输入文件名');
        return;
      }

      if (!filename.endsWith('.md') && !filename.endsWith('.markdown')) {
        alert('文件名必须以 .md 或 .markdown 结尾');
        return;
      }

      // 创建默认内容
      const defaultContent = `# ${filename.replace(/\.(md|markdown)$/, '')}

在这里开始编写你的Markdown内容...

## 功能特性

- 支持代码高亮
- 支持数学公式
- 支持图表和可视化
- 实时预览

## 快速开始

1. 在左侧编辑器中输入Markdown内容
2. 右侧会实时显示预览效果
3. 使用 Ctrl+S 保存文件

---

*使用MarkViz编辑器创建*
`;

      // 存储到localStorage
      const savedFiles = JSON.parse(localStorage.getItem('markdownFiles') || '{}');
      savedFiles[filename] = {
        content: defaultContent,
        timestamp: Date.now()
      };
      localStorage.setItem('markdownFiles', JSON.stringify(savedFiles));

      // 将内容存储到sessionStorage供编辑器使用
      sessionStorage.setItem('markdownEditorContent', defaultContent);
      sessionStorage.setItem('markdownEditorFilename', filename);

      closeMarkdownFileSelector();

      // 打开编辑器
      window.open('http://localhost:3000', '_blank');
    }

    // 监听ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('markdown-file-modal');
        if (!modal.classList.contains('hidden')) {
          closeMarkdownFileSelector();
        }
      }
    });
  </script>
</body>
</html>
